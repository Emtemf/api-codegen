<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Codegen - Web UI</title>
    <link rel="stylesheet" href="lib/codemirror.min.css">
    <link rel="stylesheet" href="lib/dracula.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            height: 100vh;
            overflow: hidden;
        }

        .app { display: flex; flex-direction: column; height: 100vh; }
        .header {
            background: #16213e;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #0f3460;
            flex-shrink: 0;
        }
        .logo { font-size: 18px; font-weight: bold; color: #e94560; }
        .nav { display: flex; gap: 8px; }
        .nav-btn {
            padding: 8px 16px;
            background: #0f3460;
            border: none;
            border-radius: 4px;
            color: #eee;
            cursor: pointer;
            transition: all 0.2s;
        }
        .nav-btn:hover, .nav-btn.active { background: #e94560; }
        .actions { display: flex; gap: 8px; }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn-primary { background: #e94560; color: white; }
        .btn-secondary { background: #0f3460; color: #eee; }
        .btn-success { background: #27ae60; color: white; }

        .main {
            flex: 1;
            display: flex;
            overflow: hidden;
            min-height: 0;
        }

        .panel {
            display: flex;
            flex-direction: column;
            border-right: 1px solid #0f3460;
            overflow: hidden;
            min-width: 0;
        }
        .api-panel {
            flex: 4;
        }
        .config-panel {
            flex: 3;
        }
        .panel:last-child { border-right: none; }

        .panel-header {
            background: #16213e;
            padding: 10px 16px;
            font-size: 13px;
            color: #aaa;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #0f3460;
            flex-shrink: 0;
        }
        .panel-header span:first-child {
            flex: 1;
        }
        .panel-load-btn {
            padding: 4px 12px;
            background: #0f3460;
            border: none;
            border-radius: 4px;
            color: #aaa;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 8px;
        }
        .panel-load-btn:hover {
            background: #e94560;
            color: white;
        }

        .editor-wrapper {
            flex: 1;
            overflow: hidden;
            position: relative;
            min-height: 0;
        }

        .config-output-paths {
            padding: 10px 16px;
            background: #1a1a2e;
            border-top: 1px solid #16213e;
            font-size: 12px;
        }

        .output-path-item {
            display: flex;
            margin-bottom: 4px;
        }

        .output-path-item:last-child {
            margin-bottom: 0;
        }

        .output-path-label {
            color: #888;
            width: 80px;
            flex-shrink: 0;
        }

        .output-path-value {
            color: #4ecca3;
            font-family: monospace;
            word-break: break-all;
        }

        .CodeMirror {
            height: 100% !important;
            font-size: 13px;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        /* Analysis Panel */
        .analysis {
            flex: 3;
            min-width: 300px;
            max-width: 450px;
            background: #16213e;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #0f3460;
            flex-shrink: 0;
        }
        .analysis-header {
            padding: 12px 16px;
            border-bottom: 1px solid #0f3460;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .issue-count {
            background: #0f3460;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
        }
        .issue-count.error { background: #e74c3c; }
        .issue-count.warn { background: #f39c12; }
        .issue-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }
        .issue {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 3px solid;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        .issue.error { background: rgba(231, 76, 60, 0.15); border-color: #e74c3c; }
        .issue.warn { background: rgba(243, 156, 18, 0.15); border-color: #f39c12; }
        .issue-checkbox {
            flex-shrink: 0;
            padding-top: 2px;
        }
        .issue-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #e94560;
        }
        .issue-content {
            flex: 1;
            min-width: 0;
        }
        .issue-select-all {
            padding: 10px 12px;
            background: rgba(233, 69, 96, 0.1);
            border-bottom: 1px solid #0f3460;
            font-size: 13px;
        }
        .issue-select-all label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            color: #e94560;
        }
        .issue-select-all input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #e94560;
        }
        .issue-title { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; flex-wrap: wrap; }
        .issue-icon { width: 8px; height: 8px; border-radius: 50%; }
        .issue.error .issue-icon { background: #e74c3c; }
        .issue.warn .issue-icon { background: #f39c12; }
        .issue-type { font-size: 11px; text-transform: uppercase; font-weight: 600; }
        .issue.error .issue-type { color: #e74c3c; }
        .issue.warn .issue-type { color: #f39c12; }
        .issue-rule {
            font-size: 10px;
            color: #666;
            margin-left: 8px;
            padding: 2px 6px;
            background: #2a2a3e;
            border-radius: 3px;
            font-family: monospace;
        }
        .issue-message { font-size: 13px; color: #ccc; line-height: 1.4; }
        .issue-api { font-size: 11px; color: #666; margin-top: 4px; font-family: monospace; }

        .tab-content { display: none; flex: 1; overflow: hidden; }
        .tab-content.active { display: flex; }

        .empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
        }
        .empty-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
        .empty-text { font-size: 14px; }

        .statusbar {
            background: #16213e;
            padding: 6px 16px;
            font-size: 12px;
            color: #666;
            display: flex;
            gap: 16px;
            border-top: 1px solid #0f3460;
            flex-shrink: 0;
        }

        textarea { display: none; }

        /* Diff Preview Modal */
        .diff-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }
        .diff-modal.active { display: flex; }
        .diff-container {
            background: #1e1e1e;
            border-radius: 12px;
            width: 96%;
            max-width: 1600px;
            max-height: 88vh;
            display: flex;
            flex-direction: column;
            border: 1px solid #3a3a3a;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
            overflow: hidden;
        }
        .diff-header {
            padding: 18px 24px;
            border-bottom: 1px solid #3a3a3a;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(180deg, #252525 0%, #1e1e1e 100%);
        }
        .diff-title {
            font-size: 17px;
            font-weight: 600;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .diff-title-icon {
            font-size: 20px;
        }
        .diff-stats {
            display: flex;
            gap: 20px;
            font-size: 13px;
            font-weight: 500;
        }
        .diff-stat {
            padding: 6px 14px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .diff-stat-add {
            background: rgba(46, 160, 67, 0.2);
            color: #57ab38;
            border: 1px solid rgba(46, 160, 67, 0.4);
        }
        .diff-stat-remove {
            background: rgba(248, 81, 73, 0.2);
            color: #f85149;
            border: 1px solid rgba(248, 81, 73, 0.4);
        }
        .diff-body {
            flex: 1;
            overflow: hidden;
            display: flex;
            min-height: 0;
            background: #0d0d0d;
        }
        .diff-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 0;
        }
        .diff-panel-left {
            border-right: 1px solid #3a3a3a;
        }
        .diff-panel-header {
            padding: 12px 18px;
            background: linear-gradient(180deg, #1e1e1e 0%, #181818 100%);
            font-size: 12px;
            font-weight: 600;
            color: #8b949e;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid #3a3a3a;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .diff-panel-badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
        }
        .diff-panel-badge.before {
            background: rgba(248, 81, 73, 0.2);
            color: #f85149;
        }
        .diff-panel-badge.after {
            background: rgba(46, 160, 67, 0.2);
            color: #57ab38;
        }
        .diff-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 0;
            font-family: 'JetBrains Mono', 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            line-height: 22px;
            scrollbar-width: thin;
            scrollbar-color: #4a4a4a #1e1e1e;
        }
        .diff-content::-webkit-scrollbar {
            width: 10px;
        }
        .diff-content::-webkit-scrollbar-track {
            background: #1e1e1e;
        }
        .diff-content::-webkit-scrollbar-thumb {
            background: #4a4a4a;
            border-radius: 5px;
        }
        .diff-line {
            display: flex;
            align-items: stretch;
            min-height: 22px;
            position: relative;
        }
        .diff-line-num {
            width: 55px;
            flex-shrink: 0;
            padding: 0 12px;
            color: #6e7681;
            text-align: right;
            user-select: none;
            background: #0d0d0d;
            border-right: 1px solid #21262d;
            font-size: 12px;
            line-height: 22px;
        }
        .diff-line-content {
            flex: 1;
            padding: 0 14px;
            white-space: pre;
            overflow-x: auto;
            line-height: 22px;
            position: relative;
        }
        .diff-line.add {
            background: rgba(46, 160, 67, 0.1);
        }
        .diff-line.add:hover {
            background: rgba(46, 160, 67, 0.15);
        }
        .diff-line.add .diff-line-content { color: #3fb950; }
        .diff-line.add .diff-line-num {
            background: rgba(46, 160, 67, 0.08);
            color: #57ab38;
        }
        .diff-line.remove {
            background: rgba(248, 81, 73, 0.1);
        }
        .diff-line.remove:hover {
            background: rgba(248, 81, 73, 0.15);
        }
        .diff-line.remove .diff-line-content { color: #f85149; }
        .diff-line.remove .diff-line-num {
            background: rgba(248, 81, 73, 0.08);
            color: #f85149;
        }
        /* Empty line for alignment */
        .diff-line-empty {
            background: rgba(255, 255, 255, 0.02);
        }
        .diff-line-empty .diff-line-content {
            color: #484f58;
        }
        .diff-line-empty .diff-line-num {
            color: #3a3a3a;
        }

        .diff-footer {
            padding: 16px 24px;
            border-top: 1px solid #3a3a3a;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 12px;
            background: linear-gradient(180deg, #181818 0%, #1e1e1e 100%);
        }
        .diff-hint {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 12px;
            color: #8b949e;
            margin-right: auto;
        }
        .diff-hint-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .diff-hint-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        .diff-hint-dot.add {
            background: #3fb950;
            box-shadow: 0 0 6px rgba(63, 185, 80, 0.5);
        }
        .diff-hint-dot.remove {
            background: #f85149;
            box-shadow: 0 0 6px rgba(248, 81, 73, 0.5);
        }

        /* Right Panel: API + Field stacked */
        .diff-right-panel {
            width: 55%;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-left: 1px solid #3a3a3a;
        }
        .diff-api-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-bottom: 1px solid #3a3a3a;
            min-height: 0;
        }
        .diff-field-section {
            flex: 1.5;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }
        /* YAML panel - limit max width */
        .diff-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 0;
            max-width: 45%;
        }
        .diff-panel-count {
            background: #0f3460;
            padding: 2px 10px;
            border-radius: 10px;
            font-size: 11px;
            color: #79c0ff;
            margin-left: auto;
        }

        /* API Panels with before/after */
        .diff-api-panels {
            flex: 1;
            display: flex;
            overflow: hidden;
            min-height: 0;
        }
        .diff-api-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }
        .diff-api-panel-left {
            border-right: 1px solid #3a3a3a;
        }
        .diff-api-header, .diff-field-header {
            padding: 8px 12px;
            background: #252525;
            font-size: 11px;
            color: #8b949e;
            border-bottom: 1px solid #3a3a3a;
            text-align: center;
        }
        .diff-api-list, .diff-field-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            min-height: 0;
        }

        /* Field Panels with before/after */
        .diff-field-panels {
            flex: 1;
            display: flex;
            overflow: hidden;
            min-height: 0;
        }
        .diff-field-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }
        .diff-field-panel-left {
            border-right: 1px solid #3a3a3a;
        }

        /* API/Field item styles */
        .diff-api-item-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            margin-bottom: 6px;
            background: #1a1a1a;
            border-radius: 6px;
            font-family: 'JetBrains Mono', 'Consolas', monospace;
            font-size: 12px;
        }
        .diff-api-item-row.added {
            border-left: 3px solid #57ab38;
        }
        .diff-api-item-row.removed {
            border-left: 3px solid #f85149;
        }
        .diff-api-item-row.modified {
            border-left: 3px solid #f0883e;
        }
        .diff-api-item-row.unchanged {
            border-left: 3px solid #3a3a3a;
            opacity: 0.7;
        }
        .diff-api-change-detail {
            padding: 4px 10px 4px 30px;
            font-size: 11px;
            color: #8b949e;
            font-family: 'JetBrains Mono', 'Consolas', monospace;
        }
        .diff-api-compact {
            display: flex;
            align-items: center;
            padding: 6px 12px;
            border-bottom: 1px solid #2d333b;
            gap: 8px;
            font-size: 12px;
        }
        .diff-api-compact .diff-path {
            color: #c9d1d9;
            font-family: 'JetBrains Mono', monospace;
        }
        .diff-api-compact .diff-path-old {
            color: #f85149;
            text-decoration: line-through;
            font-family: 'JetBrains Mono', monospace;
        }
        .diff-api-compact .diff-path-new {
            color: #57ab38;
            font-family: 'JetBrains Mono', monospace;
        }
        .diff-tag-add {
            color: #57ab38;
            font-size: 10px;
            margin-left: auto;
        }
        .diff-tag-del {
            color: #f85149;
            font-size: 10px;
            margin-left: auto;
        }
        .diff-tag-mod {
            color: #79c0ff;
            font-size: 10px;
            margin-left: auto;
        }
        /* Java 代码风格显示 */
        .diff-api-java {
            padding: 8px 12px;
            border-bottom: 1px solid #2d333b;
            font-size: 12px;
            position: relative;
        }
        .diff-api-java.diff-api-add {
            background: rgba(46, 160, 67, 0.08);
        }
        .diff-api-java.diff-api-del {
            background: rgba(248, 81, 73, 0.08);
        }
        .diff-api-java.diff-api-del .diff-java-annotation,
        .diff-api-java.diff-api-del .diff-java-method {
            text-decoration: line-through;
            opacity: 0.7;
        }
        .diff-java-annotation {
            color: #d2a8ff;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
        }
        .diff-custom-annotations {
            color: #ff7b72;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            margin-bottom: 4px;
        }
        .diff-java-code {
            color: #c9d1d9;
            font-family: 'JetBrains Mono', 'Consolas', monospace;
            font-size: 12px;
            margin: 0;
            white-space: pre;
            line-height: 1.5;
        }
        .diff-api-java.diff-api-del .diff-java-code {
            opacity: 0.6;
        }
        .diff-java-method {
            color: #7ee787;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            margin-top: 4px;
        }
        .diff-api-java .diff-tag-add,
        .diff-api-java .diff-tag-mod {
            position: absolute;
            top: 8px;
            right: 12px;
        }
        .diff-change-prop {
            color: #79c0ff;
        }
        .diff-change-item {
            padding: 3px 0;
            line-height: 1.4;
        }
        .diff-change-before {
            color: #f85149;
        }
        .diff-change-after {
            color: #57ab38;
            padding-left: 12px;
        }
        .diff-api-method {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
        }
        .diff-api-method.get { background: rgba(46, 160, 67, 0.2); color: #57ab38; }
        .diff-api-method.post { background: rgba(46, 107, 207, 0.2); color: #79c0ff; }
        .diff-api-method.put { background: rgba(240, 136, 62, 0.2); color: #f0883e; }
        .diff-api-method.delete { background: rgba(248, 81, 73, 0.2); color: #f85149; }

        /* Field item styles */
        .diff-field-class {
            margin-bottom: 12px;
        }
        .diff-field-class-title {
            font-size: 12px;
            font-weight: 600;
            color: #e94560;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid #3a3a3a;
        }
        .diff-field-item-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            margin-bottom: 4px;
            background: #1a1a1a;
            border-radius: 4px;
            font-family: 'JetBrains Mono', 'Consolas', monospace;
            font-size: 11px;
        }
        .diff-field-item-row.added {
            border-left: 3px solid #57ab38;
        }
        .diff-field-item-row.removed {
            border-left: 3px solid #f85149;
        }
        .diff-field-item-row.modified {
            border-left: 3px solid #f0883e;
        }
        .diff-field-item-row.unchanged {
            border-left: 3px solid #3a3a3a;
            opacity: 0.7;
        }
        .diff-field-type {
            color: #79c0ff;
        }
        .diff-field-name {
            color: #ffa657;
        }
        .diff-field-annotations {
            margin-left: auto;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        .diff-field-ann {
            padding: 1px 6px;
            border-radius: 3px;
            font-size: 10px;
        }
        .diff-field-ann.added {
            background: rgba(46, 160, 67, 0.2);
            color: #57ab38;
        }
        .diff-field-ann.removed {
            background: rgba(248, 81, 73, 0.2);
            color: #f85149;
        }
        .diff-field-ann.original {
            background: rgba(240, 136, 62, 0.2);
            color: #f0883e;
        }
        .diff-field-change-detail {
            padding: 4px 10px 4px 20px;
            font-size: 11px;
            color: #8b949e;
            font-family: 'JetBrains Mono', 'Consolas', monospace;
        }
        .diff-field-row {
            padding: 4px 12px;
            font-family: 'JetBrains Mono', 'Consolas', monospace;
            font-size: 12px;
            border-bottom: 1px solid #2d333b;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .diff-annotations {
            color: #57ab38;
            font-size: 11px;
        }
        .diff-validation-details {
            font-size: 10px;
            color: #888;
            margin-top: 4px;
            padding-left: 8px;
            border-left: 2px solid #444;
        }
        .diff-validation-after {
            color: #57ab38;
            border-left-color: #57ab38;
        }
        /* IDE风格的颜色 - Java语法高亮 */
        .diff-java-type { color: #79c0ff; }  /* 蓝色 - 类型 */
        .diff-java-name { color: #e3b341; }  /* 黄色 - 字段名 */
        .diff-java-keyword { color: #ff7b72; }  /* 红色 - 关键字 */
        .diff-java-annotation { color: #d2a8ff; }  /* 紫色 - 注解 */
        .diff-java-string { color: #a5d6ff; }  /* 浅蓝 - 字符串 */
        .diff-java-number { color: #79c0ff; }  /* 蓝色 - 数字 */
        .diff-java-comment { color: #8b949e; }  /* 灰色 - 注释 */

        /* 变更对比的颜色 */
        .diff-prop { color: #79c0ff; }
        .diff-old-val { color: #f85149; text-decoration: line-through; opacity: 0.7; }
        .diff-new-val { color: #57ab38; font-weight: 600; }

        /* IDE风格语法高亮 - 统一类名 */
        .diff-java-code .syntax-keyword { color: #ff7b72; }   /* 关键字: private, public, return, void */
        .diff-java-code .syntax-type { color: #79c0ff; }     /* 类型: String, Integer, Response */
        .diff-java-code .syntax-field { color: #e3b341; }    /* 字段名/参数名 */
        .diff-java-code .syntax-string { color: #a5d6ff; }    /* 字符串 */
        .diff-java-code .syntax-number { color: #79c0ff; }    /* 数字 */
        .diff-java-code .syntax-comment { color: #8b949e; font-style: italic; }  /* 注释 */
        .diff-java-code .syntax-method { color: #d2a8ff; }    /* 方法名 */
        .diff-java-code .syntax-annotation { color: #d2a8ff; } /* 注解: @Post, @Path, @Valid */

        /* API变更详情样式 */
        .diff-changes {
            padding: 8px 12px;
            background: #161b22;
            border-bottom: 1px solid #30363d;
            font-family: 'JetBrains Mono', 'Consolas', monospace;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="app">
        <header class="header">
            <div class="logo">API Codegen</div>
            <nav class="nav">
                <button class="nav-btn active">API + Config</button>
            </nav>
            <div class="actions">
                <button class="btn btn-secondary" onclick="loadExample()">加载示例</button>
                <button class="btn btn-secondary" onclick="saveFile()">保存</button>
                <button class="btn btn-primary" onclick="analyze()">分析</button>
                <button class="btn btn-success" onclick="autoFix()">自动修复</button>
            </div>
        </header>

        <main class="main">
            <!-- API YAML Editor -->
            <div class="panel api-panel">
                <div class="panel-header">
                    <span>API 定义 (api.yaml)</span>
                    <span id="yaml-info">-</span>
                    <button class="panel-load-btn" onclick="loadApiFile()">打开</button>
                </div>
                <div class="editor-wrapper">
                    <textarea id="yaml-editor"></textarea>
                </div>
            </div>

            <!-- Config YAML Editor -->
            <div class="panel config-panel">
                <div class="panel-header">
                    <span>生成配置 (codegen-config.yaml)</span>
                    <span id="config-info">-</span>
                    <button class="panel-load-btn" onclick="loadConfigFile()">打开</button>
                </div>
                <div class="editor-wrapper">
                    <textarea id="config-editor"></textarea>
                </div>
                <div class="config-output-paths" id="config-output-paths">
                    <div class="output-path-item">
                        <span class="output-path-label">Controller:</span>
                        <span class="output-path-value" id="output-path-controller">-</span>
                    </div>
                    <div class="output-path-item">
                        <span class="output-path-label">Request:</span>
                        <span class="output-path-value" id="output-path-request">-</span>
                    </div>
                    <div class="output-path-item">
                        <span class="output-path-label">Response:</span>
                        <span class="output-path-value" id="output-path-response">-</span>
                    </div>
                </div>
            </div>

            <!-- Analysis Panel -->
            <aside class="analysis">
                <div class="analysis-header">
                    <span>分析结果</span>
                    <span class="issue-count" id="issue-count">0</span>
                </div>
                <div class="issue-list" id="issue-list">
                    <div class="empty">
                        <div class="empty-icon">&#128221;</div>
                        <div class="empty-text">点击"分析"检查 YAML</div>
                    </div>
                </div>
            </aside>
        </main>

        <footer class="statusbar">
            <span id="status-position">行: 1, 列: 1</span>
            <span>|</span>
            <span id="status-api">API: 0</span>
            <span>|</span>
            <span id="status-field">字段: 0</span>
            <span>|</span>
            <span id="status-message">就绪</span>
        </footer>
    </div>

    <!-- Diff Preview Modal -->
    <div class="diff-modal" id="diff-modal">
        <div class="diff-container">
            <div class="diff-header">
                <div class="diff-title">
                    <span class="diff-title-icon">&#128293;</span>
                    <span>修复预览</span>
                </div>
                <div class="diff-stats">
                    <div class="diff-stat diff-stat-remove">
                        <span>&minus;</span>
                        <span id="diff-removes">0 处删除</span>
                    </div>
                    <div class="diff-stat diff-stat-add">
                        <span>&plus;</span>
                        <span id="diff-adds">0 处添加</span>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="closeDiffModal()">关闭</button>
            </div>
            <div class="diff-body">
                <!-- Left: YAML Before -->
                <div class="diff-panel diff-panel-left">
                    <div class="diff-panel-header">
                        <span class="diff-panel-badge before">修复前</span>
                        <span>原始 YAML</span>
                    </div>
                    <div class="diff-content" id="diff-before" data-scroll-group="yaml"></div>
                </div>

                <!-- Middle: YAML After -->
                <div class="diff-panel">
                    <div class="diff-panel-header">
                        <span class="diff-panel-badge after">修复后</span>
                        <span>修复后的 YAML</span>
                    </div>
                    <div class="diff-content" id="diff-after" data-scroll-group="yaml"></div>
                </div>

                <!-- Right: API + Field stacked, each with before/after -->
                <div class="diff-right-panel">
                    <!-- API Changes -->
                    <div class="diff-api-section">
                        <div class="diff-panel-header">
                            <span>&#128279; 接口变更</span>
                            <span id="diff-api-count" class="diff-panel-count">0</span>
                        </div>
                        <div class="diff-api-panels">
                            <div class="diff-api-panel diff-api-panel-left">
                                <div class="diff-api-header">原始</div>
                                <div class="diff-api-list" id="diff-api-before"></div>
                            </div>
                            <div class="diff-api-panel">
                                <div class="diff-api-header">修复后</div>
                                <div class="diff-api-list" id="diff-api-after" data-scroll-group="api"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Field Changes -->
                    <div class="diff-field-section">
                        <div class="diff-panel-header">
                            <span>&#128196; 字段变更</span>
                            <span id="diff-field-count" class="diff-panel-count">0</span>
                        </div>
                        <div class="diff-field-panels">
                            <div class="diff-field-panel diff-field-panel-left">
                                <div class="diff-field-header">原始</div>
                                <div class="diff-field-list" id="diff-field-before"></div>
                            </div>
                            <div class="diff-field-panel">
                                <div class="diff-field-header">修复后</div>
                                <div class="diff-field-list" id="diff-field-after" data-scroll-group="field"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="diff-footer">
                <div class="diff-hint">
                    <span class="diff-hint-item">
                        <span class="diff-hint-dot add"></span>
                        <span>添加的行</span>
                    </span>
                    <span class="diff-hint-item">
                        <span class="diff-hint-dot remove"></span>
                        <span>删除的行</span>
                    </span>
                </div>
                <button class="btn btn-secondary" onclick="closeDiffModal()">取消</button>
                <button class="btn btn-success" onclick="applyFix()">应用修复</button>
            </div>
        </div>
    </div>

    <script src="lib/js-yaml.min.js"></script>
    <script src="lib/codemirror.min.js"></script>
    <script src="lib/yaml.min.js"></script>
    <script src="js/analyzer.js"></script>
    <script>
        var yamlEditor, configEditor;

        // Default YAML content (使用Swagger 2.0格式)
        var defaultYaml = `swagger: "2.0"
info:
  title: 用户管理API
  version: "1.0"
basePath: /api
paths:
  /users:
    get:
      summary: 查询用户列表
      operationId: queryUserList
      parameters:
        - name: page
          in: query
          description: 页码
          schema:
            type: integer
        - name: pageSize
          in: query
          description: 每页数量
          schema:
            type: integer
        - name: keyword
          in: query
          description: 搜索关键词
          schema:
            type: string
      responses:
        200:
          description: 成功
    post:
      summary: 创建用户
      operationId: createUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - email
              properties:
                username:
                  type: string
                  minLength: 4
                  maxLength: 20
                email:
                  type: string
                  format: email
      responses:
        201:
          description: 创建成功
  /users/{id}:
    get:
      summary: 获取用户详情
      operationId: getUserById
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        200:
          description: 成功`;

        var defaultConfig = 'framework: CXF\n\ncopyright: ""\n\noutput:\n  controller:\n    path: generated/api/\n  request:\n    path: src/main/java/req/\n  response:\n    path: src/main/java/rsp/';

        // 存储用户的原始 YAML（用于预览对比）
        var originalYaml = defaultYaml;

        // 示例数据定义
        var examples = {
            'swagger': {
                name: 'Swagger 2.0',
                yaml: `swagger: "2.0"
info:
  title: 用户管理API
  version: "1.0"
basePath: /api
paths:
  /users:
    get:
      summary: 查询用户列表
      operationId: queryUserList
      description: 支持分页查询，可按关键词搜索
      parameters:
        - name: page
          in: query
          schema:
            type: integer
        - name: pageSize
          in: query
          schema:
            type: integer
        - name: keyword
          in: query
          description: 搜索关键词
          required: false
          schema:
            type: string
        - name: limit
          in: query
      responses:
        200:
          description: 成功
  /users/{id}:
    get:
      summary: 根据ID获取用户
      operationId: getUserById
      parameters:
        - name: id
          in: path
          description: 用户ID
          required: true
          schema:
            type: integer
        - name: X-Token
          in: header
          description: 认证令牌
          required: true
          schema:
            type: string
        - name: JSESSIONID
          in: cookie
          description: 会话ID
          required: false
          schema:
            type: string
      responses:
        200:
          description: 成功
  /users/{userCode}:
    get:
      summary: 根据编码获取用户
      operationId: getUserByCode
      parameters:
        - name: userCode
          in: path
          description: 用户编码
          required: true
          schema:
            type: string
      responses:
        200:
          description: 成功
    post:
      summary: 创建用户
      operationId: createUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - email
                - phone
              properties:
                username:
                  type: string
                  description: 用户名
                  minLength: 4
                  maxLength: 20
                email:
                  type: string
                  format: email
                  description: 邮箱
                phone:
                  type: string
                  description: 手机号
                age:
                  type: integer
                  description: 年龄
                score:
                  type: number
                  description: 评分
                price:
                  type: number
                  description: 价格
                balance:
                  type: number
                  description: 账户余额
                tags:
                  type: array
                  description: 标签列表
                  items:
                    type: string
                birthday:
                  type: string
                  format: date
                  description: 生日
                enabled:
                  type: boolean
                  description: 是否启用
      responses:
        201:
          description: 创建成功
  /users/batch:
    post:
      summary: 批量创建用户
      operationId: batchCreateUsers
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                users:
                  type: array
                  description: 用户列表
                  items:
                    type: object
                    properties:
                      username:
                        type: string
                      email:
                        type: string
      responses:
        201:
          description: 创建成功`,
                config: defaultConfig
            },
            'openapi': {
                name: 'OpenAPI 3.0',
                yaml: `openapi: "3.0.0"
info:
  title: 用户管理API
  version: "1.0.0"
servers:
  - url: /api
paths:
  /users:
    get:
      summary: 查询用户列表
      operationId: queryUserList
      description: 支持分页查询，可按关键词搜索
      parameters:
        - name: page
          in: query
          schema:
            type: integer
        - name: pageSize
          in: query
          schema:
            type: integer
        - name: keyword
          in: query
          description: 搜索关键词
          required: false
          schema:
            type: string
        - name: limit
          in: query
      responses:
        200:
          description: 成功
  /users/{id}:
    get:
      summary: 根据ID获取用户
      operationId: getUserById
      parameters:
        - name: id
          in: path
          description: 用户ID
          required: true
          schema:
            type: integer
        - name: X-Token
          in: header
          description: 认证令牌
          required: true
          schema:
            type: string
        - name: JSESSIONID
          in: cookie
          description: 会话ID
          required: false
          schema:
            type: string
      responses:
        200:
          description: 成功
  /users/{userCode}:
    get:
      summary: 根据编码获取用户
      operationId: getUserByCode
      parameters:
        - name: userCode
          in: path
          description: 用户编码
          required: true
          schema:
            type: string
      responses:
        200:
          description: 成功
    post:
      summary: 创建用户
      operationId: createUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - email
                - phone
              properties:
                username:
                  type: string
                  description: 用户名
                  minLength: 4
                  maxLength: 20
                email:
                  type: string
                  format: email
                  description: 邮箱
                phone:
                  type: string
                  description: 手机号
                age:
                  type: integer
                  description: 年龄
                score:
                  type: number
                  description: 评分
                price:
                  type: number
                  description: 价格
                balance:
                  type: number
                  description: 账户余额
                tags:
                  type: array
                  description: 标签列表
                  items:
                    type: string
                birthday:
                  type: string
                  format: date
                  description: 生日
                enabled:
                  type: boolean
                  description: 是否启用
      responses:
        201:
          description: 创建成功
  /users/batch:
    post:
      summary: 批量创建用户
      operationId: batchCreateUsers
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                users:
                  type: array
                  description: 用户列表
                  items:
                    type: object
                    properties:
                      username:
                        type: string
                      email:
                        type: string
      responses:
        201:
          description: 创建成功`,
                config: defaultConfig
            }
        };

        function loadExampleFromUrl() {
            var params = new URLSearchParams(window.location.search);
            var demo = params.get('demo');
            if (demo && examples[demo]) {
                var example = examples[demo];
                document.getElementById('yaml-info').textContent = example.name + ' (URL参数)';
                return example.yaml;
            }
            return null;
        }

        function init() {
            // 尝试从URL参数加载示例
            var urlYaml = loadExampleFromUrl();

            // Initialize YAML editor
            yamlEditor = CodeMirror.fromTextArea(document.getElementById('yaml-editor'), {
                mode: 'yaml',
                theme: 'dracula',
                lineNumbers: true,
                lineWrapping: true,
                indentUnit: 2,
                tabSize: 2
            });

            // Initialize config editor
            configEditor = CodeMirror.fromTextArea(document.getElementById('config-editor'), {
                mode: 'yaml',
                theme: 'dracula',
                lineNumbers: true,
                lineWrapping: true,
                indentUnit: 2,
                tabSize: 2
            });

            // Set default content (use URL example if provided)
            var currentYaml = urlYaml || defaultYaml;
            var currentConfig = defaultConfig;
            yamlEditor.setValue(currentYaml);
            configEditor.setValue(currentConfig);
            originalYaml = currentYaml;  // 保存为原始版本

            // Events
            yamlEditor.on('cursorActivity', updateStatus);
            yamlEditor.on('change', function() {
                updateStatus();
                document.getElementById('yaml-info').textContent = '已修改';
            });

            // Config editor events
            configEditor.on('change', function() {
                document.getElementById('config-info').textContent = '已修改';
                updateConfigOutputPaths();
            });

            // Initialize config output paths
            updateConfigOutputPaths();

            updateStatus();
        }

        function updateStatus() {
            var cursor = yamlEditor.getDoc().getCursor();
            document.getElementById('status-position').textContent = '行: ' + (cursor.line + 1) + ', 列: ' + (cursor.ch + 1);

            try {
                var content = yamlEditor.getValue();
                var parsed = jsyaml.load(content);

                if (!parsed || !parsed.apis) {
                    document.getElementById('status-api').textContent = 'API: 0';
                    document.getElementById('status-field').textContent = '字段: 0';
                    return;
                }

                var apiCount = parsed.apis.length;
                var fieldCount = 0;

                parsed.apis.forEach(function(api) {
                    if (api.request && api.request.fields) fieldCount += api.request.fields.length;
                    if (api.response && api.response.fields) fieldCount += api.response.fields.length;
                });

                document.getElementById('status-api').textContent = 'API: ' + apiCount;
                document.getElementById('status-field').textContent = '字段: ' + fieldCount;
            } catch (e) {
                document.getElementById('status-api').textContent = 'API: -';
                document.getElementById('status-field').textContent = '字段: -';
            }
        }

        function loadExample() {
            // 显示示例选择菜单
            var exampleKeys = Object.keys(examples);
            var options = exampleKeys.map(function(key, idx) {
                return (idx + 1) + '. ' + examples[key].name;
            }).join('\n');

            var choice = prompt('选择格式示例:\n\n' + options + '\n\n输入数字:');

            var exampleKey = 'basic';
            if (choice) {
                var num = parseInt(choice);
                if (num >= 1 && num <= exampleKeys.length) {
                    exampleKey = exampleKeys[num - 1];
                }
            }

            var example = examples[exampleKey];
            originalYaml = example.yaml;
            yamlEditor.setValue(example.yaml);
            configEditor.setValue(example.config || defaultConfig);
            yamlEditor.refresh();
            configEditor.refresh();
            updateStatus();
            document.getElementById('issue-list').innerHTML = '<div class="empty"><div class="empty-icon">&#128221;</div><div class="empty-text">点击"分析"检查 YAML</div></div>';
            document.getElementById('issue-count').textContent = '0';
            document.getElementById('issue-count').className = 'issue-count';
            document.getElementById('yaml-info').textContent = example.name;
            document.getElementById('config-info').textContent = example.name;
            setMessage('已加载: ' + example.name);
        }

        // Load API YAML file
        function loadApiFile() {
            var input = document.createElement('input');
            input.type = 'file';
            input.accept = '.yaml,.yml';
            input.onchange = function(e) {
                var file = e.target.files[0];
                var reader = new FileReader();
                reader.onload = function(e) {
                    var content = e.target.result;
                    // 上传时直接去掉注释
                    var cleanContent = stripYamlComments(content);
                    originalYaml = cleanContent;  // 保存去掉注释后的内容
                    yamlEditor.setValue(cleanContent);
                    yamlEditor.refresh();
                    document.getElementById('yaml-info').textContent = file.name;
                    updateStatus();
                    setMessage('已加载 API: ' + file.name);
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // 去掉 YAML 注释
        function stripYamlComments(content) {
            var lines = content.split('\n');
            var result = [];
            lines.forEach(function(line) {
                // 去掉 # 注释（但保留 # 在字符串里的情况）
                var trimmed = line.trim();
                if (trimmed === '' || trimmed.startsWith('#')) {
                    return; // 跳过空行和纯注释行
                }
                // 查找 # 的位置（不在引号内）
                var inString = false;
                var stringChar = '';
                for (var i = 0; i < line.length; i++) {
                    var c = line[i];
                    if (!inString && (c === '"' || c === "'")) {
                        inString = true;
                        stringChar = c;
                    } else if (inString && c === stringChar && line[i-1] !== '\\') {
                        inString = false;
                    } else if (!inString && c === '#') {
                        // 找到注释开始
                        line = line.substring(0, i);
                        break;
                    }
                }
                result.push(line);
            });
            return result.join('\n');
        }

        // Load Config YAML file
        function loadConfigFile() {
            var input = document.createElement('input');
            input.type = 'file';
            input.accept = '.yaml,.yml';
            input.onchange = function(e) {
                var file = e.target.files[0];
                var reader = new FileReader();
                reader.onload = function(e) {
                    configEditor.setValue(e.target.result);
                    configEditor.refresh();
                    document.getElementById('config-info').textContent = file.name;
                    updateConfigOutputPaths();
                    setMessage('已加载配置: ' + file.name);
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function saveFile() {
            var content = yamlEditor.getValue();
            var blob = new Blob([content], { type: 'text/yaml' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'api.yaml';
            a.click();
            URL.revokeObjectURL(url);
            setMessage('已保存');
        }

        function analyze() {
            var content = yamlEditor.getValue();
            originalYaml = content;  // 保存当前内容作为原始版本，用于预览对比
            var analyzer = new ApiYamlAnalyzer();
            var issues = analyzer.analyze(content);

            document.getElementById('issue-count').textContent = issues.length;
            renderIssues(issues);

            var errorCount = issues.filter(function(i) { return i.severity === 'error'; }).length;
            var warnCount = issues.filter(function(i) { return i.severity === 'warn'; }).length;

            var countEl = document.getElementById('issue-count');
            countEl.className = 'issue-count';
            if (errorCount > 0) countEl.classList.add('error');
            else if (warnCount > 0) countEl.classList.add('warn');

            setMessage('分析完成: ' + errorCount + ' 错误, ' + warnCount + ' 警告');
        }

        // Store issues with selection state
        var selectedIssues = {};

        function renderIssues(issues) {
            var container = document.getElementById('issue-list');

            if (issues.length === 0) {
                container.innerHTML = '<div class="empty"><div class="empty-icon">&#10004;</div><div class="empty-text">没有发现问题！</div></div>';
                return;
            }

            // Reset selection - all selected by default
            selectedIssues = {};
            issues.forEach(function(_, i) { selectedIssues[i] = true; });

            var html = '<div class="issue-select-all">' +
                '<label><input type="checkbox" id="select-all-issues" checked onchange="toggleAllIssues(this.checked)"> 全选</label>' +
                '</div>';

            html += issues.map(function(issue, index) {
                var checked = selectedIssues[index] ? 'checked' : '';
                return '<div class="issue ' + issue.severity + '">' +
                    '<div class="issue-checkbox">' +
                    '<input type="checkbox" ' + checked + ' onchange="toggleIssue(' + index + ', this.checked)">' +
                    '</div>' +
                    '<div class="issue-content">' +
                    '<div class="issue-title">' +
                    '<span class="issue-icon"></span>' +
                    '<span class="issue-type">' + (issue.severity === 'error' ? '错误' : '警告') + '</span>' +
                    '<span class="issue-rule" title="规则依据">' + (issue.rule || '') + '</span>' +
                    '</div>' +
                    '<div class="issue-message">' + issue.message + '</div>' +
                    (issue.api !== undefined ? '<div class="issue-api">API: ' + issue.api + '</div>' : '') +
                    '</div>' +
                    '</div>';
            }).join('');

            container.innerHTML = html;
            window.currentIssues = issues;
            updateIssueCount();
        }

        function toggleIssue(index, checked) {
            selectedIssues[index] = checked;
            updateIssueCount();
        }

        function toggleAllIssues(checked) {
            var checkboxes = document.querySelectorAll('#issue-list input[type="checkbox"]:not(#select-all-issues)');
            checkboxes.forEach(function(cb, i) {
                cb.checked = checked;
                selectedIssues[i] = checked;
            });
            updateIssueCount();
        }

        function updateIssueCount() {
            var total = Object.keys(selectedIssues).length;
            var selected = Object.values(selectedIssues).filter(function(v) { return v; }).length;
            var countEl = document.getElementById('issue-count');
            countEl.textContent = selected + '/' + total;
        }

        function autoFix() {
            // 使用原始内容作为对比基础
            var content = originalYaml || yamlEditor.getValue();
            var analyzer = new ApiYamlAnalyzer();

            // Get selected issues and compute selective fix
            var issues = window.currentIssues || [];
            var selectedIndices = Object.keys(selectedIssues).filter(function(i) { return selectedIssues[i]; }).map(function(i) { return parseInt(i); });

            var fixed = analyzer.fixSelective(content, selectedIndices);

            // Show diff preview - 使用原始内容作为修复前
            showDiffPreview(content, fixed);
            setMessage('点击"应用修复"确认更改');
        }

        /**
         * Show diff preview modal
         */
        function showDiffPreview(before, after) {
            var diff = computeDiff(before, after);

            document.getElementById('diff-before').innerHTML = renderDiffContent(before, diff, 'before');
            document.getElementById('diff-after').innerHTML = renderDiffContent(after, diff, 'after');

            // Update stats
            var addCount = diff.filter(function(d) { return d.type === 'add'; }).length;
            var removeCount = diff.filter(function(d) { return d.type === 'remove'; }).length;
            document.getElementById('diff-adds').textContent = addCount + ' 处添加';
            document.getElementById('diff-removes').textContent = removeCount + ' 处删除';

            // Compute and display impact summary
            var impact = computeImpact(before, after);

            // Render API and Field changes
            renderApiChanges(impact);
            renderFieldChanges(impact);

            // Store fixed content for apply
            window.pendingFixedContent = after;

            // Sync scroll between left and right panels (YAML only)
            setupScrollSync();

            // Show modal
            document.getElementById('diff-modal').classList.add('active');
        }

        /**
         * Render API-level changes with before/after comparison
         */
        function renderApiChanges(impact) {
            var beforeContainer = document.getElementById('diff-api-before');
            var afterContainer = document.getElementById('diff-api-after');
            var countEl = document.getElementById('diff-api-count');

            if (!impact || !impact.apis || impact.apis.length === 0) {
                beforeContainer.innerHTML = '<div class="diff-field-empty">无接口变更</div>';
                afterContainer.innerHTML = '<div class="diff-field-empty">无接口变更</div>';
                countEl.textContent = '0';
                return;
            }

            var apis = impact.apis;
            countEl.textContent = apis.length;

            // 像 GitHub 一样显示：左边原始，右边修复后
            var beforeHtml = '';
            var afterHtml = '';

            apis.forEach(function(api) {
                var method = (api.method || 'get').toLowerCase();
                var fixedPath = api.path || '';
                var originalPath = api.originalPath || api.path || '';
                // 优先使用name，如果没有则使用summary或operationId，最后使用路径
                var apiName = api.name || api.summary || api.operationId || fixedPath.replace(/\//g, '').replace(/\{|\}/g, '') || 'api';
                var annotations = api.annotations || [];
                var params = api.parameters || [];
                var originalParams = api.originalParameters || api.parameters || [];

                // 生成完整的 Java 方法代码（带语法高亮）
                // 修复后使用修复后的参数（带校验注解），修复前使用原始参数（不带校验注解）
                var javaCode = generateJavaControllerCode(fixedPath, method, apiName, annotations, api.description, params);
                var originalJavaCode = generateJavaControllerCode(originalPath, method, apiName, annotations, api.description, originalParams);

                if (api.type === 'added') {
                    // 新增的接口 - 只在右边显示
                    afterHtml += '<div class="diff-api-java diff-api-add">';
                    afterHtml += '<pre class="diff-java-code">' + javaCode + '</pre>';
                    afterHtml += '</div>';
                } else if (api.type === 'deleted') {
                    // 删除的接口 - 只在左边显示
                    beforeHtml += '<div class="diff-api-java diff-api-del">';
                    beforeHtml += '<pre class="diff-java-code">' + originalJavaCode + '</pre>';
                    beforeHtml += '</div>';
                } else if (api.type === 'modified') {
                    // 修改的接口 - 左边显示原始，右边显示修复后
                    // 只显示重要变更（路径、description、type等），注解类变更已在代码中体现
                    var importantChangesHtml = '';
                    if (api.changes && api.changes.length > 0) {
                        var hasImportantChange = false;
                        var changeLines = [];

                        api.changes.forEach(function(change) {
                            // 只显示非注解类的变更
                            if (change.prop === 'path') {
                                changeLines.push('<span class="diff-change-before">路径: ' + escapeHtml(change.before) + '</span> → <span class="diff-change-after">' + escapeHtml(change.after) + '</span>');
                                hasImportantChange = true;
                            } else if (change.prop.startsWith('参数 ') && change.prop.includes('description')) {
                                var paramName = change.prop.replace('参数 ', '').replace(' description', '').trim();
                                changeLines.push('参数 <span class="diff-change-before">' + paramName + '</span>: 添加描述');
                                hasImportantChange = true;
                            } else if (change.prop.startsWith('参数 ') && change.prop.includes(' type')) {
                                var paramName = change.prop.replace('参数 ', '').replace(' type', '').trim();
                                changeLines.push('参数 <span class="diff-change-before">' + paramName + '</span>: 添加类型');
                                hasImportantChange = true;
                            }
                        });

                        if (hasImportantChange) {
                            importantChangesHtml = '<div class="diff-changes">' + changeLines.join('<br>') + '</div>';
                        }
                    }

                    // 左边显示原始代码
                    beforeHtml += '<div class="diff-api-java diff-api-mod">';
                    beforeHtml += importantChangesHtml;
                    beforeHtml += '<pre class="diff-java-code">' + originalJavaCode + '</pre>';
                    beforeHtml += '</div>';

                    // 右边显示修复后代码
                    afterHtml += '<div class="diff-api-java diff-api-mod">';
                    afterHtml += importantChangesHtml;
                    afterHtml += '<pre class="diff-java-code">' + javaCode + '</pre>';
                    afterHtml += '</div>';
                }
            });

            if (beforeHtml === '') beforeHtml = '<div class="diff-field-empty">-</div>';
            if (afterHtml === '') afterHtml = '<div class="diff-field-empty">-</div>';

            beforeContainer.innerHTML = beforeHtml;
            afterContainer.innerHTML = afterHtml;
        }

        /**
         * 生成 Java Controller 代码风格（完整方法预览，带语法高亮）
         */
        function generateJavaControllerCode(path, httpMethod, apiName, annotations, description, params) {
            var methodName = toCamelCase(apiName);
            var returnType = 'Response';
            annotations = annotations || [];
            description = description || apiName;
            params = params || [];

            switch (httpMethod.toLowerCase()) {
                case 'get':
                    returnType = 'Response';
                    break;
                case 'post':
                    returnType = 'Response';
                    break;
                case 'put':
                    returnType = 'Response';
                    break;
                case 'delete':
                    returnType = 'Response';
                    break;
                case 'patch':
                    returnType = 'Response';
                    break;
            }

            // 生成自定义注解（带语法高亮）
            var customAnnotationsHtml = '';
            if (annotations && annotations.length > 0) {
                annotations.forEach(function(ann) {
                    var highlighted = ann
                        .replace(/(@\w+)/g, '<span class="syntax-keyword">$1</span>')
                        .replace(/(\w+)=/g, '<span class="syntax-field">$1</span>=')
                        .replace(/(".*?")/g, '<span class="syntax-string">$1</span>');
                    customAnnotationsHtml += '    <span class="syntax-annotation">' + highlighted + '</span>\n';
                });
            }

            // 生成完整的方法代码（带语法高亮）
            var code = '';
            if (customAnnotationsHtml) {
                code += customAnnotationsHtml;
            }
            code += '    <span class="syntax-annotation">@' + httpMethod.toUpperCase() + '</span>\n';
            code += '    <span class="syntax-annotation">@Path("' + path + '")</span>\n';

            // 处理参数
            var hasRequestBody = false;
            var pathParams = [];
            var queryParams = [];
            var headerParams = [];
            var cookieParams = [];

            if (params && params.length > 0) {
                params.forEach(function(param) {
                    if (param.in === 'path') {
                        pathParams.push(param);  // 保存完整对象
                    } else if (param.in === 'query') {
                        queryParams.push(param);  // 保存完整对象
                    } else if (param.in === 'header') {
                        headerParams.push(param);  // 保存完整对象
                    } else if (param.in === 'cookie') {
                        cookieParams.push(param);  // 保存完整对象
                    } else if (param.in === 'body' || param.name === 'body') {
                        hasRequestBody = true;
                    }
                });

                // 注意：参数注解和声明都在后面的方法签名生成逻辑中统一处理
                // 这里不再单独生成注解，避免位置错误
            }

            if (hasRequestBody) {
                code += '    <span class="syntax-annotation">@Consumes</span>(<span class="syntax-string">MediaType.APPLICATION_JSON</span>)\n';
            }
            code += '    <span class="syntax-annotation">@Produces</span>(<span class="syntax-string">MediaType.APPLICATION_JSON</span>)\n';

            // 生成方法签名 - @Size放在参数前面
            var paramStr = '()';
            if (hasRequestBody) {
                paramStr = '(@Valid <span class="syntax-type">RequestBody</span> <span class="syntax-field">req</span>)';
            } else if (pathParams.length > 0 || queryParams.length > 0 || headerParams.length > 0 || cookieParams.length > 0) {
                var methodParams = [];

                // 处理路径参数 - 包含校验注解和@PathParam
                pathParams.forEach(function(p) {
                    var paramType = p.type === 'integer' ? 'Integer' : (p.type === 'number' ? 'Double' : 'String');
                    var annots = '';
                    // required参数 -> @NotNull
                    if (p.required === true) {
                        annots += '<span class="syntax-annotation">@NotNull</span> ';
                    }
                    // 数值类型 -> @Min/@Max
                    var minimum = p.minimum !== undefined ? p.minimum : (p.schema && p.schema.minimum !== undefined ? p.schema.minimum : undefined);
                    var maximum = p.maximum !== undefined ? p.maximum : (p.schema && p.schema.maximum !== undefined ? p.schema.maximum : undefined);
                    if (minimum !== undefined || maximum !== undefined) {
                        if (minimum !== undefined) annots += '<span class="syntax-annotation">@Min</span>(' + minimum + ') ';
                        if (maximum !== undefined) annots += '<span class="syntax-annotation">@Max</span>(' + maximum + ') ';
                    }
                    // 字符串类型 -> @Size
                    var minLength = p.minLength !== undefined ? p.minLength : (p.schema && p.schema.minLength !== undefined ? p.schema.minLength : undefined);
                    var maxLength = p.maxLength !== undefined ? p.maxLength : (p.schema && p.schema.maxLength !== undefined ? p.schema.maxLength : undefined);
                    if (minLength !== undefined || maxLength !== undefined) {
                        var parts = [];
                        if (minLength !== undefined && minLength > 0) parts.push('min=' + minLength);
                        if (maxLength !== undefined) parts.push('max=' + maxLength);
                        if (parts.length > 0) annots += '<span class="syntax-annotation">@Size</span>(' + parts.join(', ') + ') ';
                    }
                    annots += '<span class="syntax-annotation">@PathParam("' + p.name + '")</span> ';
                    methodParams.push(annots + '<span class="syntax-type">' + paramType + '</span> <span class="syntax-field">' + p.name + '</span>');
                });

                // 处理查询参数
                queryParams.forEach(function(p) {
                    // 支持 param.type 或 param.schema.type
                    var paramType = p.type || (p.schema && p.schema.type);
                    paramType = paramType === 'integer' ? 'Integer' : (paramType === 'number' ? 'Double' : 'String');
                    var annots = '';
                    // required参数 -> @NotNull
                    if (p.required === true || (p.schema && p.schema.required === true)) {
                        annots += '<span class="syntax-annotation">@NotNull</span> ';
                    }
                    // minLength/maxLength -> @Size
                    var minLength = p.minLength !== undefined ? p.minLength : (p.schema && p.schema.minLength !== undefined ? p.schema.minLength : undefined);
                    var maxLength = p.maxLength !== undefined ? p.maxLength : (p.schema && p.schema.maxLength !== undefined ? p.schema.maxLength : undefined);
                    if (minLength !== undefined || maxLength !== undefined) {
                        var parts = [];
                        if (minLength !== undefined && minLength > 0) parts.push('min=' + minLength);
                        if (maxLength !== undefined) parts.push('max=' + maxLength);
                        if (parts.length > 0) annots += '<span class="syntax-annotation">@Size</span>(' + parts.join(', ') + ') ';
                    }
                    // minimum/maximum -> @Min/@Max
                    var minimum = p.minimum !== undefined ? p.minimum : (p.schema && p.schema.minimum !== undefined ? p.schema.minimum : undefined);
                    var maximum = p.maximum !== undefined ? p.maximum : (p.schema && p.schema.maximum !== undefined ? p.schema.maximum : undefined);
                    if (minimum !== undefined || maximum !== undefined) {
                        if (minimum !== undefined) annots += '<span class="syntax-annotation">@Min</span>(' + minimum + ') ';
                        if (maximum !== undefined) annots += '<span class="syntax-annotation">@Max</span>(' + maximum + ') ';
                    }
                    annots += '<span class="syntax-annotation">@QueryParam("' + p.name + '")</span> ';
                    methodParams.push(annots + '<span class="syntax-type">' + paramType + '</span> <span class="syntax-field">' + p.name + '</span>');
                });

                // 处理Header参数
                headerParams.forEach(function(p) {
                    var paramType = p.type || (p.schema && p.schema.type);
                    paramType = paramType === 'integer' ? 'Integer' : (paramType === 'number' ? 'Double' : 'String');
                    var annots = '';
                    // required参数 -> @NotNull
                    if (p.required === true || (p.schema && p.schema.required === true)) {
                        annots += '<span class="syntax-annotation">@NotNull</span> ';
                    }
                    // minLength/maxLength -> @Size
                    var minLength = p.minLength !== undefined ? p.minLength : (p.schema && p.schema.minLength !== undefined ? p.schema.minLength : undefined);
                    var maxLength = p.maxLength !== undefined ? p.maxLength : (p.schema && p.schema.maxLength !== undefined ? p.schema.maxLength : undefined);
                    if (minLength !== undefined || maxLength !== undefined) {
                        var parts = [];
                        if (minLength !== undefined && minLength > 0) parts.push('min=' + minLength);
                        if (maxLength !== undefined) parts.push('max=' + maxLength);
                        if (parts.length > 0) annots += '<span class="syntax-annotation">@Size</span>(' + parts.join(', ') + ') ';
                    }
                    // minimum/maximum -> @Min/@Max
                    var minimum = p.minimum !== undefined ? p.minimum : (p.schema && p.schema.minimum !== undefined ? p.schema.minimum : undefined);
                    var maximum = p.maximum !== undefined ? p.maximum : (p.schema && p.schema.maximum !== undefined ? p.schema.maximum : undefined);
                    if (minimum !== undefined || maximum !== undefined) {
                        if (minimum !== undefined) annots += '<span class="syntax-annotation">@Min</span>(' + minimum + ') ';
                        if (maximum !== undefined) annots += '<span class="syntax-annotation">@Max</span>(' + maximum + ') ';
                    }
                    annots += '<span class="syntax-annotation">@HeaderParam("' + p.name + '")</span> ';
                    methodParams.push(annots + '<span class="syntax-type">' + paramType + '</span> <span class="syntax-field">' + p.name + '</span>');
                });

                // 处理Cookie参数
                cookieParams.forEach(function(p) {
                    var paramType = p.type || (p.schema && p.schema.type);
                    paramType = paramType === 'integer' ? 'Integer' : (paramType === 'number' ? 'Double' : 'String');
                    var annots = '';
                    // required参数 -> @NotNull
                    if (p.required === true || (p.schema && p.schema.required === true)) {
                        annots += '<span class="syntax-annotation">@NotNull</span> ';
                    }
                    // minLength/maxLength -> @Size
                    var minLength = p.minLength !== undefined ? p.minLength : (p.schema && p.schema.minLength !== undefined ? p.schema.minLength : undefined);
                    var maxLength = p.maxLength !== undefined ? p.maxLength : (p.schema && p.schema.maxLength !== undefined ? p.schema.maxLength : undefined);
                    if (minLength !== undefined || maxLength !== undefined) {
                        var parts = [];
                        if (minLength !== undefined && minLength > 0) parts.push('min=' + minLength);
                        if (maxLength !== undefined) parts.push('max=' + maxLength);
                        if (parts.length > 0) annots += '<span class="syntax-annotation">@Size</span>(' + parts.join(', ') + ') ';
                    }
                    // minimum/maximum -> @Min/@Max
                    var minimum = p.minimum !== undefined ? p.minimum : (p.schema && p.schema.minimum !== undefined ? p.schema.minimum : undefined);
                    var maximum = p.maximum !== undefined ? p.maximum : (p.schema && p.schema.maximum !== undefined ? p.schema.maximum : undefined);
                    if (minimum !== undefined || maximum !== undefined) {
                        if (minimum !== undefined) annots += '<span class="syntax-annotation">@Min</span>(' + minimum + ') ';
                        if (maximum !== undefined) annots += '<span class="syntax-annotation">@Max</span>(' + maximum + ') ';
                    }
                    annots += '<span class="syntax-annotation">@CookieParam("' + p.name + '")</span> ';
                    methodParams.push(annots + '<span class="syntax-type">' + paramType + '</span> <span class="syntax-field">' + p.name + '</span>');
                });

                paramStr = '(' + methodParams.join(', ') + ')';
            }

            code += '    <span class="syntax-keyword">public</span> <span class="syntax-type">' + returnType + '</span> <span class="syntax-method">' + methodName + '</span>' + paramStr + ' {\n';
            code += '        <span class="syntax-comment">// TODO: 实现业务逻辑</span>\n';
            code += '        <span class="syntax-keyword">return</span> <span class="syntax-keyword">null</span>;\n';
            code += '    }';

            return code;
        }

        /**
         * 生成 Java 字段代码（完整效果，带语法高亮）
         * 使用简单的方式：先转义HTML，再简单高亮注解名
         */
        function generateJavaFieldCode(fieldName, fieldType, annotations, validation) {
            annotations = annotations || [];
            validation = validation || {};

            var code = '';

            // 添加注解
            annotations.forEach(function(ann) {
                // 先转义HTML特殊字符，避免注入
                var escapedAnn = ann
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');

                // 简单高亮注解名 @开头的部分
                escapedAnn = escapedAnn.replace(/^(@\w+)/, '<span class="syntax-annotation">$1</span>');

                code += '    ' + escapedAnn + '\n';
            });

            // 字段
            var escapedType = fieldType.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            var escapedName = fieldName.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            code += '    <span class="syntax-keyword">private</span> <span class="syntax-type">' + escapedType + '</span> <span class="syntax-field">' + escapedName + '</span>;\n';

            return code;
        }

        /**
         * 生成 Java 字段代码（纯文本版本，用于escapeHtml）
         */
        function generateJavaFieldCodePlain(fieldName, fieldType, annotations, validation) {
            annotations = annotations || [];
            validation = validation || {};

            var code = '';

            // 添加注解
            annotations.forEach(function(ann) {
                code += '    ' + ann + '\n';
            });

            // 字段
            code += '    private ' + fieldType + ' ' + fieldName + ';\n';

            return code;
        }

        /**
         * 转换为驼峰命名
         */
        function toCamelCase(str) {
            if (!str) return 'api';
            return str.replace(/[-_\/](\w)/g, function(match, c) {
                return c ? c.toUpperCase() : '';
            }).replace(/^\w/, function(c) {
                return c.toLowerCase();
            });
        }

        /**
         * Render field-level changes with before/after comparison
         */
        function renderFieldChanges(impact) {
            var beforeContainer = document.getElementById('diff-field-before');
            var afterContainer = document.getElementById('diff-field-after');
            var countEl = document.getElementById('diff-field-count');

            if (!impact || !impact.fields || impact.fields.length === 0) {
                beforeContainer.innerHTML = '<div class="diff-field-empty">无字段变更</div>';
                afterContainer.innerHTML = '<div class="diff-field-empty">无字段变更</div>';
                countEl.textContent = '0';
                return;
            }

            var fields = impact.fields;
            countEl.textContent = fields.length;

            // Group by class
            var byClass = {};
            fields.forEach(function(item) {
                if (!byClass[item.className]) {
                    byClass[item.className] = [];
                }
                byClass[item.className].push(item);
            });

            var beforeHtml = '';
            var afterHtml = '';

            for (var className in byClass) {
                var classFields = byClass[className];

                beforeHtml += '<div class="diff-field-class"><div class="diff-field-class-title">' + escapeHtml(className) + '.java</div>';
                afterHtml += '<div class="diff-field-class"><div class="diff-field-class-title">' + escapeHtml(className) + '.java</div>';

                classFields.forEach(function(item) {
                    var fieldType = item.fieldType || 'String';
                    var fieldName = item.field;
                    var changes = item.changes || [];
                    var changeType = item.type || 'modified';

                    // Build detailed changes info - 分离before和after
                    var addedAnnotations = [];
                    var beforeDetails = [];  // 修复前缺失的校验
                    var afterDetails = [];   // 修复后新增的校验

                    // 先收集所有的变更，按字段分组
                    if (changes.length > 0) {
                        // 用于收集每个字段的变更
                        var fieldChangesMap = {};
                        var yamlFormatChange = false;

                        changes.forEach(function(change) {
                            if (change === 'YAML格式变化') {
                                yamlFormatChange = true;
                                addedAnnotations.push('@Valid');
                                beforeDetails.push('缺失校验规则');
                                afterDetails.push('新增 @Valid');
                            } else if (typeof change === 'object' && change.before !== undefined) {
                                if (change.prop === 'required') {
                                    beforeDetails.push('缺失必填校验');
                                    afterDetails.push('新增 @NotNull');
                                    addedAnnotations.push('@NotNull');
                                } else if (change.prop === 'format' && change.after === 'email') {
                                    beforeDetails.push('缺失邮箱格式校验');
                                    afterDetails.push('新增 @Email');
                                    addedAnnotations.push('@Email');
                                } else if (change.prop === 'pattern') {
                                    // 检查是否已经有同字段的变更
                                    var existingIdx = beforeDetails.findIndex(function(d) {
                                        return d.includes('缺失正则校验');
                                    });
                                    if (existingIdx === -1) {
                                        beforeDetails.push('缺失正则校验');
                                        afterDetails.push('新增 @Pattern(regexp="' + escapeHtml(change.after || '') + '")');
                                        addedAnnotations.push('@Pattern(regexp="' + (change.after || '') + '")');
                                    }
                                } else if (change.prop === 'minimum') {
                                    // 收集minimum，后面合并
                                    if (!fieldChangesMap['min']) fieldChangesMap['min'] = [];
                                    fieldChangesMap['min'].push(change.after);
                                } else if (change.prop === 'maximum') {
                                    if (!fieldChangesMap['max']) fieldChangesMap['max'] = [];
                                    fieldChangesMap['max'].push(change.after);
                                } else if (change.prop === 'minLength') {
                                    if (!fieldChangesMap['sizeMin']) fieldChangesMap['sizeMin'] = [];
                                    fieldChangesMap['sizeMin'].push(change.after);
                                } else if (change.prop === 'maxLength') {
                                    if (!fieldChangesMap['sizeMax']) fieldChangesMap['sizeMax'] = [];
                                    fieldChangesMap['sizeMax'].push(change.after);
                                }
                            } else if (typeof change === 'string' && change.startsWith('@')) {
                                addedAnnotations.push(change);
                            }
                        });

                        // 合并数值范围校验 @Min/@Max
                        if (fieldChangesMap['min'] || fieldChangesMap['max']) {
                            var minVals = fieldChangesMap['min'] || [0];
                            var maxVals = fieldChangesMap['max'] || [];
                            // 去重
                            minVals = [...new Set(minVals)];
                            maxVals = [...new Set(maxVals)];

                            beforeDetails.push('缺失数值范围校验');
                            var mmAnnots = [];
                            minVals.forEach(function(m) {
                                mmAnnots.push('@Min(' + m + ')');
                            });
                            maxVals.forEach(function(m) {
                                mmAnnots.push('@Max(' + m + ')');
                            });
                            afterDetails.push('新增 ' + mmAnnots.join(' '));
                            mmAnnots.forEach(function(a) { addedAnnotations.push(a); });
                        }

                        // 合并长度校验 @Size
                        if (fieldChangesMap['sizeMin'] || fieldChangesMap['sizeMax']) {
                            var sMinVals = fieldChangesMap['sizeMin'] || [];
                            var sMaxVals = fieldChangesMap['sizeMax'] || [];
                            sMinVals = [...new Set(sMinVals)];
                            sMaxVals = [...new Set(sMaxVals)];

                            beforeDetails.push('缺失长度范围校验');
                            var sizeParts = [];
                            var hasSizeMin = false;
                            sMinVals.forEach(function(m) {
                                if (m > 0) {
                                    sizeParts.push('min=' + m);
                                    hasSizeMin = true;
                                }
                            });
                            sMaxVals.forEach(function(m) {
                                sizeParts.push('max=' + m);
                            });
                            var sizeAnnot = '@Size(' + sizeParts.join(', ') + ')';
                            afterDetails.push('新增 ' + sizeAnnot);
                            addedAnnotations.push(sizeAnnot);
                        }
                    }

                    // Deduplicate
                    addedAnnotations = [...new Set(addedAnnotations)];

                    // Generate field code for before/after
                    var beforeCode = generateJavaFieldCode(fieldName, fieldType, [], {});
                    var afterCode = generateJavaFieldCode(fieldName, fieldType, addedAnnotations, {});

                    // Before: show field without annotations - 显示缺失的校验
                    beforeHtml += '<div class="diff-field-row">';
                    beforeHtml += '<pre class="diff-java-code">' + beforeCode + '</pre>';
                    if (beforeDetails.length > 0) {
                        beforeHtml += '<div class="diff-validation-details">' + beforeDetails.join('<br>') + '</div>';
                    }
                    beforeHtml += '</div>';

                    // After: field with annotations added - 显示新增的校验
                    afterHtml += '<div class="diff-field-row">';
                    afterHtml += '<pre class="diff-java-code">' + afterCode + '</pre>';
                    if (afterDetails.length > 0) {
                        afterHtml += '<div class="diff-validation-details diff-validation-after">' + afterDetails.join('<br>') + '</div>';
                    }
                    afterHtml += '</div>';
                });

                beforeHtml += '</div>';
                afterHtml += '</div>';
            }

            beforeContainer.innerHTML = beforeHtml;
            afterContainer.innerHTML = afterHtml;
        }

        /**
         * Compute impact on Java code
         */
        function computeImpact(before, after) {
            var result = {
                apis: [],  // API/interface level changes
                fields: []  // Field level changes
            };

            try {
                var beforeParsed = jsyaml.load(before);
                var afterParsed = jsyaml.load(after);

                if (!beforeParsed || !afterParsed) {
                    return result;
                }

                // Check if it's Swagger/OpenAPI format
                var isSwagger = (beforeParsed.swagger || beforeParsed.openapi || beforeParsed.paths);

                if (isSwagger) {
                    // Swagger/OpenAPI format - compare paths/APIs
                    var beforePaths = beforeParsed.paths || {};
                    var afterPaths = afterParsed.paths || {};

                    // Normalize path: ensure it starts with /
                    function normalizePath(path) {
                        if (!path) return path;
                        // Remove duplicate slashes
                        var normalized = path.replace(/\/+/g, '/');
                        // Remove /XXX/ prefix (placeholder path)
                        normalized = normalized.replace(/^\/XXX\//, '/');
                        if (!normalized.startsWith('/')) {
                            normalized = '/' + normalized;
                        }
                        return normalized;
                    }

                    // Build normalized map for before paths
                    var normalizedBeforePaths = {};
                    for (var origPath in beforePaths) {
                        var np = normalizePath(origPath);
                        normalizedBeforePaths[np] = origPath;
                    }

                    // Compare each path in after
                    for (var path in afterPaths) {
                        var np = normalizePath(path);
                        var beforePath = beforePaths[path];
                        var afterPath = afterPaths[path];
                        var originalPath = path;

                        // Check if path was fixed (e.g., //users -> /users or users -> /users)
                        if (normalizedBeforePaths[np]) {
                            // Found matching normalized path
                            originalPath = normalizedBeforePaths[np];
                            beforePath = beforePaths[originalPath];
                        }

                        if (!beforePath && originalPath === path) {
                            // New API path added - check if it's truly new (not just normalized difference)
                            if (!normalizedBeforePaths[np]) {
                                var afterOp = afterPath[Object.keys(afterPath)[0]];
                                // Only add if there's actual content
                                if (afterOp.summary || afterOp.operationId || (afterOp.parameters && afterOp.parameters.length > 0)) {
                                    result.apis.push({
                                        path: path,
                                        originalPath: path,
                                        method: Object.keys(afterPath)[0],
                                        name: afterOp.operationId || afterOp.summary || path.replace(/\//g, '').replace(/\{|\}/g, ''),
                                        summary: afterOp.summary || '',
                                        operationId: afterOp.operationId || '',
                                        parameters: afterOp.parameters || [],
                                        type: 'added',
                                        changes: [{ prop: 'API', before: '(无)', after: '新增接口' }]
                                    });
                                }
                            }
                        } else if (originalPath !== path) {
                            // Path was fixed (//users -> /users or users -> /users)
                            var afterOpFixed = afterPath[Object.keys(afterPath)[0]];
                            var beforeOpFixed = beforePath[originalPath] || {};
                            result.apis.push({
                                path: path,
                                originalPath: originalPath,
                                method: Object.keys(afterPath)[0],
                                name: afterOpFixed.operationId || afterOpFixed.summary || path.replace(/\//g, '').replace(/\{|\}/g, ''),
                                summary: afterOpFixed.summary || '',
                                operationId: afterOpFixed.operationId || '',
                                parameters: afterOpFixed.parameters || [],
                                originalParameters: beforeOpFixed.parameters || [],
                                type: 'modified',
                                changes: [{ prop: 'path', before: originalPath, after: path }]
                            });
                        } else {
                            // Check if methods changed - only add if there are actual changes
                            var hasActualChange = false;
                            var pathChanges = [];

                            // Check if path was fixed
                            if (originalPath !== path) {
                                hasActualChange = true;
                                pathChanges.push({ prop: 'path', before: originalPath, after: path });
                            }

                            for (var method in afterPath) {
                                var beforeMethod = beforePath[method];
                                var afterMethod = afterPath[method];

                                if (!beforeMethod) {
                                    // New method added - this is an actual change
                                    hasActualChange = true;
                                } else {
                                    // Check specific property changes
                                    var changes = [];

                                    // Check operationId
                                    if (!beforeMethod.operationId && afterMethod.operationId) {
                                        changes.push({ prop: 'operationId', before: '(无)', after: afterMethod.operationId });
                                    }
                                    // Check description
                                    if (!beforeMethod.description && afterMethod.description) {
                                        changes.push({ prop: 'description', before: '(无)', after: afterMethod.description });
                                    }

                                    // Check parameters - compare by name
                                    if (afterMethod.parameters && afterMethod.parameters.length > 0) {
                                        var beforeParamMap = {};
                                        if (beforeMethod.parameters) {
                                            beforeMethod.parameters.forEach(function(p) { beforeParamMap[p.name] = p; });
                                        }
                                        afterMethod.parameters.forEach(function(param) {
                                            var beforeParam = beforeParamMap[param.name];
                                            if (!beforeParam) {
                                                changes.push({ prop: '参数 ' + param.name, before: '(无)', after: '新增' });
                                            } else {
                                                // 检查description变化
                                                if (!beforeParam.description && param.description) {
                                                    changes.push({ prop: '参数 ' + param.name + ' description', before: '(无)', after: param.description });
                                                }
                                                // 检查type变化
                                                if (!beforeParam.type && param.type) {
                                                    changes.push({ prop: '参数 ' + param.name + ' type', before: '(无)', after: param.type });
                                                }
                                                // 检查校验规则变化
                                                if (!beforeParam.required && param.required === true) {
                                                    changes.push({ prop: '参数 ' + param.name + ' required', before: '(无)', after: true });
                                                }
                                                if (!beforeParam.minLength && param.minLength !== undefined) {
                                                    changes.push({ prop: '参数 ' + param.name + ' minLength', before: '(无)', after: param.minLength });
                                                }
                                                if (!beforeParam.maxLength && param.maxLength !== undefined) {
                                                    changes.push({ prop: '参数 ' + param.name + ' maxLength', before: '(无)', after: param.maxLength });
                                                }
                                                if (!beforeParam.minimum && param.minimum !== undefined) {
                                                    changes.push({ prop: '参数 ' + param.name + ' minimum', before: '(无)', after: param.minimum });
                                                }
                                                if (!beforeParam.maximum && param.maximum !== undefined) {
                                                    changes.push({ prop: '参数 ' + param.name + ' maximum', before: '(无)', after: param.maximum });
                                                }
                                                if (!beforeParam.pattern && param.pattern) {
                                                    changes.push({ prop: '参数 ' + param.name + ' pattern', before: '(无)', after: param.pattern });
                                                }
                                            }
                                        });
                                    }

                                    // Only add to changes if there are actual content changes
                                    if (changes.length > 0) {
                                        hasActualChange = true;
                                        pathChanges = pathChanges.concat(changes);
                                    }
                                }
                            }

                            // Only add to result if there are actual changes
                            if (hasActualChange) {
                                var firstAfterMethod = afterPath[Object.keys(afterPath)[0]];
                                var firstBeforeMethod = beforePath[Object.keys(beforePath)[0]] || {};
                                result.apis.push({
                                    path: path,
                                    originalPath: originalPath,
                                    method: Object.keys(afterPath)[0],
                                    name: firstAfterMethod.operationId || firstAfterMethod.summary || path.replace(/\//g, '').replace(/\{|\}/g, ''),
                                    summary: firstAfterMethod.summary || '',
                                    operationId: firstAfterMethod.operationId || '',
                                    parameters: firstAfterMethod.parameters || [],
                                    originalParameters: firstBeforeMethod.parameters || [],
                                    type: (originalPath !== path || pathChanges.some(function(c) { return c.prop === 'path'; })) ? 'modified' : 'modified',
                                    changes: pathChanges
                                });
                            }
                        }
                    }

                    // Check for deleted paths
                    for (var path in beforePaths) {
                        if (!afterPaths[path]) {
                            var beforeOp = beforePaths[path][Object.keys(beforePaths[path])[0]];
                            result.apis.push({
                                path: path,
                                originalPath: path,
                                method: Object.keys(beforePaths[path])[0],
                                name: beforeOp.operationId || beforeOp.summary || path.replace(/\//g, '').replace(/\{|\}/g, ''),
                                summary: beforeOp.summary || '',
                                operationId: beforeOp.operationId || '',
                                parameters: beforeOp.parameters || [],
                                type: 'deleted',
                                changes: []
                            });
                        }
                    }

                    // Compare definitions (field changes)
                    var beforeDefs = beforeParsed.definitions || (beforeParsed.components && beforeParsed.components.schemas) || {};
                    var afterDefs = afterParsed.definitions || (afterParsed.components && afterParsed.components.schemas) || {};

                    // Extract definitions section for format comparison
                    var beforeDefSection = extractDefinitionsSection(before);
                    var afterDefSection = extractDefinitionsSection(after);

                    // Compare each definition
                    for (var defName in afterDefs) {
                        var beforeDef = beforeDefs[defName] || {};
                        var afterDef = afterDefs[defName];
                        var beforeProps = beforeDef.properties || {};
                        var afterProps = afterDef.properties || {};

                        var hasChanges = false;
                        var fieldChangesList = [];

                        for (var propName in afterProps) {
                            var beforeProp = beforeProps[propName] || {};
                            var afterProp = afterProps[propName];

                            // Check if validation changed
                            var beforeVal = JSON.stringify(beforeProp);
                            var afterVal = JSON.stringify(afterProp);

                            if (beforeVal !== afterVal) {
                                hasChanges = true;
                                var fieldType = afterProp.type || 'Object';
                                if (fieldType === 'integer') fieldType = 'Integer';
                                if (fieldType === 'number' && afterProp.format === 'double') fieldType = 'Double';
                                if (fieldType === 'boolean') fieldType = 'Boolean';
                                if (fieldType === 'array') fieldType = 'List';

                                var changes = getSwaggerFieldChanges(beforeProp, afterProp);
                                fieldChangesList.push({
                                    field: propName,
                                    fieldType: fieldType,
                                    changes: changes
                                });
                            }
                        }

                        // If there are changes, add them
                        if (fieldChangesList.length > 0) {
                            fieldChangesList.forEach(function(fc) {
                                result.fields.push({
                                    className: defName,
                                    field: fc.field,
                                    fieldType: fc.fieldType,
                                    type: 'model',
                                    changes: fc.changes
                                });
                            });
                        } else if (hasChanges === false && JSON.stringify(beforeDef) !== JSON.stringify(afterDef)) {
                            // Parsed objects are same but might have YAML format difference
                            // Add all fields as having "格式变化"
                            for (var propName in afterProps) {
                                var fieldType = afterProps[propName].type || 'Object';
                                if (fieldType === 'integer') fieldType = 'Integer';
                                if (fieldType === 'boolean') fieldType = 'Boolean';
                                if (fieldType === 'array') fieldType = 'List';

                                result.fields.push({
                                    className: defName,
                                    field: propName,
                                    fieldType: fieldType,
                                    type: 'model',
                                    changes: ['YAML格式变化']
                                });
                            }
                        }
                    }

                    // If no field changes detected but YAML has changes in definitions, show them
                    if (result.fields.length === 0 && beforeDefSection !== afterDefSection) {
                        // Show all definitions as changed
                        for (var defName in afterDefs) {
                            var afterDef = afterDefs[defName];
                            if (afterDef.properties) {
                                for (var propName in afterDef.properties) {
                                    var fieldType = afterDef.properties[propName].type || 'Object';
                                    if (fieldType === 'integer') fieldType = 'Integer';
                                    if (fieldType === 'boolean') fieldType = 'Boolean';
                                    if (fieldType === 'array') fieldType = 'List';

                                    result.fields.push({
                                        className: defName,
                                        field: propName,
                                        fieldType: fieldType,
                                        type: 'model',
                                        changes: ['YAML格式变化']
                                    });
                                }
                            }
                        }
                    }

                    return result;
                }

                /**
                 * Extract definitions section from YAML text for comparison
                 */
                function extractDefinitionsSection(yamlText) {
                    // Remove line numbers that might be at the start
                    var text = yamlText.replace(/^\d+/gm, '');
                    var lines = text.split('\n');
                    var inDefinitions = false;
                    var result = [];

                    for (var i = 0; i < lines.length; i++) {
                        var line = lines[i];
                        if (line.match(/^definitions:\s*$/) || line.match(/^components:\s*$/)) {
                            inDefinitions = true;
                            continue;
                        }
                        if (inDefinitions) {
                            // Stop at next top-level key
                            if (line.match(/^[a-zA-Z]/) && !line.match(/^\s/)) {
                                break;
                            }
                            result.push(line);
                        }
                    }
                    return result.join('\n');
                }

                // Custom format - check apis
                if (!beforeParsed.apis || !afterParsed.apis) {
                    return result;
                }

                // Compare each API
                beforeParsed.apis.forEach(function(api, apiIndex) {
                    var afterApi = afterParsed.apis[apiIndex];
                    if (!afterApi) return;

                    var className = (api.request && api.request.className) ||
                                   (api.response && api.response.className) ||
                                   'Unknown';

                    // Track API level changes
                    var apiChanged = false;

                    // Check request fields
                    if (api.request && api.request.fields && afterApi.request && afterApi.request.fields) {
                        var maxReqFields = Math.max(api.request.fields.length, afterApi.request.fields.length);
                        for (var fieldIndex = 0; fieldIndex < maxReqFields; fieldIndex++) {
                            var field = api.request.fields[fieldIndex];
                            var afterField = afterApi.request.fields[fieldIndex];

                            if (!field && afterField) {
                                // New field added
                                if (afterField.validation && Object.keys(afterField.validation).length > 0) {
                                    result.fields.push({
                                        className: afterApi.request.className || className + 'Req',
                                        field: afterField.name,
                                        fieldType: afterField.type || 'String',
                                        type: 'request',
                                        changes: getFieldChanges({}, afterField.validation)
                                    });
                                    apiChanged = true;
                                }
                            } else if (field && afterField) {
                                var beforeVal = JSON.stringify(field.validation || {});
                                var afterVal = JSON.stringify(afterField.validation || {});
                                if (beforeVal !== afterVal) {
                                    result.fields.push({
                                        className: afterApi.request.className || className + 'Req',
                                        field: field.name,
                                        fieldType: field.type || 'String',
                                        type: 'request',
                                        changes: getFieldChanges(field.validation, afterField.validation)
                                    });
                                    apiChanged = true;
                                }
                            }
                        }
                    }

                    // Check response fields
                    if (api.response && api.response.fields && afterApi.response && afterApi.response.fields) {
                        var maxRspFields = Math.max(api.response.fields.length, afterApi.response.fields.length);
                        for (var fieldIndex = 0; fieldIndex < maxRspFields; fieldIndex++) {
                            var field = api.response.fields[fieldIndex];
                            var afterField = afterApi.response.fields[fieldIndex];

                            if (!field && afterField) {
                                // New field added
                                if (afterField.validation && Object.keys(afterField.validation).length > 0) {
                                    result.fields.push({
                                        className: afterApi.response.className || className + 'Rsp',
                                        field: afterField.name,
                                        fieldType: afterField.type || 'String',
                                        type: 'response',
                                        changes: getFieldChanges({}, afterField.validation)
                                    });
                                    apiChanged = true;
                                }
                            } else if (field && afterField) {
                                var beforeVal = JSON.stringify(field.validation || {});
                                var afterVal = JSON.stringify(afterField.validation || {});
                                if (beforeVal !== afterVal) {
                                    result.fields.push({
                                        className: afterApi.response.className || className + 'Rsp',
                                        field: field.name,
                                        fieldType: field.type || 'String',
                                        type: 'response',
                                        changes: getFieldChanges(field.validation, afterField.validation)
                                    });
                                    apiChanged = true;
                                }
                            }
                        }
                    }

                    // Add API to changes if fields changed
                    if (apiChanged) {
                        result.apis.push({
                            name: api.name || 'API ' + (apiIndex + 1),
                            path: api.path || '',
                            method: api.method || '',
                            annotations: api.annotations || [],
                            type: 'modified'
                        });
                    }
                });
            } catch (e) {
                console.log('Impact analysis error:', e);
            }

            return result;
        }

        /**
         * Get field validation changes
         */
        function getFieldChanges(beforeVal, afterVal) {
            var changes = [];
            var before = beforeVal || {};
            var after = afterVal || {};

            // Check each validation property
            var props = ['notNull', 'minLength', 'maxLength', 'email', 'pattern', 'min', 'max', 'minSize', 'maxSize', 'past', 'future'];
            props.forEach(function(prop) {
                if (before[prop] !== after[prop]) {
                    if (after[prop] !== undefined && after[prop] !== false) {
                        var annotation = propToAnnotation(prop, after[prop]);
                        if (annotation) changes.push(annotation);
                    }
                }
            });

            return changes;
        }

        /**
         * Get swagger field validation changes with before/after values
         */
        function getSwaggerFieldChanges(beforeProp, afterProp) {
            var changes = [];

            // Check description
            if (!beforeProp.description && afterProp.description) {
                changes.push({ prop: 'description', before: '(无)', after: afterProp.description });
            }

            // Check type
            if (!beforeProp.type && afterProp.type) {
                changes.push({ prop: 'type', before: '(无)', after: afterProp.type });
            }

            // Check required
            if (afterProp.required && !beforeProp.required) {
                changes.push({ prop: 'required', before: 'false', after: 'true' });
            }

            // Check format
            if (afterProp.format === 'email' || afterProp.description && afterProp.description.toLowerCase().includes('email')) {
                if (!beforeProp.format || beforeProp.format !== 'email') {
                    changes.push({ prop: 'format', before: '(无)', after: 'email' });
                }
            }

            // Check pattern
            if (afterProp.pattern && !beforeProp.pattern) {
                changes.push({ prop: 'pattern', before: '(无)', after: afterProp.pattern });
            }

            // Check minimum/maximum
            if (afterProp.minimum !== undefined && beforeProp.minimum === undefined) {
                changes.push({ prop: 'minimum', before: '(无)', after: afterProp.minimum });
            }
            if (afterProp.maximum !== undefined && beforeProp.maximum === undefined) {
                changes.push({ prop: 'maximum', before: '(无)', after: afterProp.maximum });
            }

            // Check minLength/maxLength
            if (afterProp.minLength !== undefined && beforeProp.minLength === undefined) {
                changes.push({ prop: 'minLength', before: '(无)', after: afterProp.minLength });
            }
            if (afterProp.maxLength !== undefined && beforeProp.maxLength === undefined) {
                changes.push({ prop: 'maxLength', before: '(无)', after: afterProp.maxLength });
            }

            // Check minItems/maxItems (for arrays)
            if (afterProp.minItems !== undefined && beforeProp.minItems === undefined) {
                changes.push({ prop: 'minItems', before: '(无)', after: afterProp.minItems });
            }
            if (afterProp.maxItems !== undefined && beforeProp.maxItems === undefined) {
                changes.push({ prop: 'maxItems', before: '(无)', after: afterProp.maxItems });
            }

            return changes;
        }

        /**
         * Convert validation property to Java annotation
         */
        function propToAnnotation(prop, value) {
            var map = {
                'notNull': '@NotNull',
                'minLength': '@Size(min=' + value + ')',
                'maxLength': '@Size(max=' + value + ')',
                'email': '@Email',
                'pattern': '@Pattern(regexp="' + value + '")',
                'min': '@Min(value=' + value + ')',
                'max': '@Max(value=' + value + ')',
                'minSize': '@Size(min=' + value + ')',
                'maxSize': '@Size(max=' + value + ')',
                'past': '@Past',
                'future': '@Future'
            };
            return map[prop] || null;
        }

        /**
         * Setup synchronized scrolling for all diff panel groups
         */
        function setupScrollSync() {
            var isSyncing = false;

            // Sync function for a group of panels
            function setupGroupSync(groupName) {
                var leftPanel = document.querySelector('[data-scroll-group="' + groupName + '"].diff-panel-left, #diff-' + groupName + '-before, #diff-' + groupName + '-panel-left');
                var rightPanel = document.querySelector('[data-scroll-group="' + groupName + '"]:not(.diff-panel-left), #diff-' + groupName + '-after, #diff-' + groupName + '-panel:not(.diff-panel-left)');

                // Handle YAML panels
                if (groupName === 'yaml') {
                    leftPanel = document.getElementById('diff-before');
                    rightPanel = document.getElementById('diff-after');
                }

                if (!leftPanel || !rightPanel) return;

                function syncScroll(source, target) {
                    if (isSyncing) return;
                    isSyncing = true;
                    target.scrollTop = source.scrollTop;
                    target.scrollLeft = source.scrollLeft;
                    setTimeout(function() { isSyncing = false; }, 10);
                }

                leftPanel.addEventListener('scroll', function() {
                    syncScroll(leftPanel, rightPanel);
                });

                rightPanel.addEventListener('scroll', function() {
                    syncScroll(rightPanel, leftPanel);
                });
            }

            // Setup sync for each group
            setupGroupSync('yaml');
            setupGroupSync('api');
            setupGroupSync('field');
        }

        /**
         * Close diff modal
         */
        function closeDiffModal() {
            document.getElementById('diff-modal').classList.remove('active');
            window.pendingFixedContent = null;
        }

        /**
         * Show debug info (full YAML content)
         */
        function showDebugInfo() {
            var before = originalYaml || yamlEditor.getValue();
            var after = window.pendingFixedContent || '';
            var msg = '=== 修复前 YAML (共 ' + before.length + ' 字符) ===\n\n' + before + '\n\n=== 修复后 YAML (共 ' + after.length + ' 字符) ===\n\n' + after;
            alert(msg);
        }

        /**
         * Apply the fixed content
         */
        function applyFix() {
            if (window.pendingFixedContent) {
                yamlEditor.setValue(window.pendingFixedContent);
                analyze();
                closeDiffModal();
                setMessage('已应用修复');
            }
        }

        /**
         * Compute line-by-line diff using improved LCS
         */
        function computeDiff(before, after) {
            var beforeLines = before.split('\n');
            var afterLines = after.split('\n');

            // Build LCS matrix
            var lcs = buildLcsMatrix(beforeLines, afterLines);
            var diff = [];

            // Backtrack to build diff with line numbers
            var i = beforeLines.length;
            var j = afterLines.length;

            while (i > 0 || j > 0) {
                if (i > 0 && j > 0 && beforeLines[i - 1] === afterLines[j - 1]) {
                    // Unchanged line
                    diff.unshift({
                        type: 'unchanged',
                        beforeLine: i - 1,
                        afterLine: j - 1,
                        beforeNum: i,
                        afterNum: j
                    });
                    i--;
                    j--;
                } else if (j > 0 && (i === 0 || lcs[i][j - 1] >= lcs[i - 1][j])) {
                    // Added line
                    diff.unshift({
                        type: 'add',
                        afterLine: j - 1,
                        afterNum: j
                    });
                    j--;
                } else if (i > 0) {
                    // Removed line
                    diff.unshift({
                        type: 'remove',
                        beforeLine: i - 1,
                        beforeNum: i
                    });
                    i--;
                }
            }

            return diff;
        }

        /**
         * Build LCS matrix for diff
         */
        function buildLcsMatrix(arr1, arr2) {
            var m = arr1.length;
            var n = arr2.length;
            var dp = [];

            for (var i = 0; i <= m; i++) {
                dp[i] = [];
                for (var j = 0; j <= n; j++) {
                    dp[i][j] = 0;
                }
            }

            for (var i = 1; i <= m; i++) {
                for (var j = 1; j <= n; j++) {
                    if (arr1[i - 1] === arr2[j - 1]) {
                        dp[i][j] = dp[i - 1][j - 1] + 1;
                    } else {
                        dp[i][j] = Math.max(dp[i - 1][j], dp[i][j - 1]);
                    }
                }
            }

            return dp;
        }

        /**
         * Render diff content for one panel (aligned)
         */
        function renderDiffContent(content, diff, side) {
            var lines = content.split('\n');
            var html = '';
            var lineNum = 1;  // Sequential line numbers

            // Build a map of changes for quick lookup
            var changeMap = {};
            diff.forEach(function(change) {
                if (change.type === 'add') {
                    changeMap[change.afterLine] = change;
                } else if (change.type === 'remove') {
                    changeMap[-change.beforeLine - 1000] = change;  // Use negative to distinguish
                } else {
                    changeMap[side === 'before' ? change.beforeLine : change.afterLine] = change;
                }
            });

            for (var i = 0; i < lines.length; i++) {
                var key = side === 'before' ? i : i;
                var change = changeMap[i];

                if (!change) {
                    // Unchanged line
                    html += renderDiffLine(lines[i], lineNum++, 'unchanged');
                } else if (change.type === 'unchanged') {
                    html += renderDiffLine(lines[i], lineNum++, 'unchanged');
                } else if (change.type === 'remove') {
                    if (side === 'before') {
                        html += renderDiffLine(lines[i], lineNum++, 'remove');
                    } else {
                        html += renderDiffLine('', lineNum++, 'empty');
                    }
                } else if (change.type === 'add') {
                    if (side === 'after') {
                        html += renderDiffLine(lines[i], lineNum++, 'add');
                    } else {
                        html += renderDiffLine('', lineNum++, 'empty');
                    }
                }
            }

            // Add empty lines for changes that don't exist in this side
            var maxLines = side === 'before' ?
                Math.max(...diff.filter(c => c.type === 'remove').map(c => c.beforeLine + 1 || 0)) :
                Math.max(...diff.filter(c => c.type === 'add').map(c => c.afterLine + 1 || 0));

            while (lineNum <= maxLines && lineNum <= lines.length) {
                html += renderDiffLine('', lineNum++, 'empty');
            }

            return html;
        }

        /**
         * Render a single diff line
         */
        function renderDiffLine(content, lineNum, type) {
            var lineClass = '';
            var showNum = true;

            if (type === 'add') {
                lineClass = 'add';
            } else if (type === 'remove') {
                lineClass = 'remove';
            } else if (type === 'empty') {
                lineClass = 'diff-line-empty';
                showNum = false;
            }

            var numHtml = showNum ?
                '<div class="diff-line-num">' + lineNum + '</div>' :
                '<div class="diff-line-num"></div>';

            return '<div class="diff-line ' + lineClass + '">' +
                numHtml +
                '<div class="diff-line-content">' + escapeHtml(content || '') + '</div>' +
                '</div>';
        }

        /**
         * Escape HTML
         */
        function escapeHtml(text) {
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        /**
         * Update config output paths display
         */
        function updateConfigOutputPaths() {
            try {
                var configContent = configEditor.getValue();
                if (!configContent || !configContent.trim()) {
                    document.getElementById('output-path-controller').textContent = '-';
                    document.getElementById('output-path-request').textContent = '-';
                    document.getElementById('output-path-response').textContent = '-';
                    return;
                }

                var config = jsyaml.load(configContent);
                if (!config || !config.output) {
                    document.getElementById('output-path-controller').textContent = '-';
                    document.getElementById('output-path-request').textContent = '-';
                    document.getElementById('output-path-response').textContent = '-';
                    return;
                }

                var output = config.output;
                document.getElementById('output-path-controller').textContent = output.controller ? output.controller.path || '-' : '-';
                document.getElementById('output-path-request').textContent = output.request ? output.request.path || '-' : '-';
                document.getElementById('output-path-response').textContent = output.response ? output.response.path || '-' : '-';
            } catch (e) {
                // Invalid YAML, ignore
                document.getElementById('output-path-controller').textContent = '-';
                document.getElementById('output-path-request').textContent = '-';
                document.getElementById('output-path-response').textContent = '-';
            }
        }

        function setMessage(msg) {
            document.getElementById('status-message').textContent = msg;
        }

        // Initialize
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
