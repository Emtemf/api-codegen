<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Codegen - Web UI</title>
    <link rel="stylesheet" href="lib/codemirror.min.css">
    <link rel="stylesheet" href="lib/dracula.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            height: 100vh;
            overflow: hidden;
        }

        .app { display: flex; flex-direction: column; height: 100vh; }
        .header {
            background: #16213e;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #0f3460;
            flex-shrink: 0;
        }
        .logo { font-size: 18px; font-weight: bold; color: #e94560; }
        .nav { display: flex; gap: 8px; }
        .nav-btn {
            padding: 8px 16px;
            background: #0f3460;
            border: none;
            border-radius: 4px;
            color: #eee;
            cursor: pointer;
            transition: all 0.2s;
        }
        .nav-btn:hover, .nav-btn.active { background: #e94560; }
        .actions { display: flex; gap: 8px; }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn-primary { background: #e94560; color: white; }
        .btn-secondary { background: #0f3460; color: #eee; }
        .btn-success { background: #27ae60; color: white; }

        .main {
            flex: 1;
            display: flex;
            overflow: hidden;
            min-height: 0;
        }

        .panel {
            display: flex;
            flex-direction: column;
            border-right: 1px solid #0f3460;
            overflow: hidden;
            min-width: 0;
        }
        .api-panel {
            flex: 1;
        }
        .panel:last-child { border-right: none; }

        .panel-header {
            background: #16213e;
            padding: 10px 16px;
            font-size: 13px;
            color: #aaa;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #0f3460;
            flex-shrink: 0;
        }
        .panel-header span:first-child {
            flex: 1;
        }
        .panel-load-btn {
            padding: 4px 12px;
            background: #0f3460;
            border: none;
            border-radius: 4px;
            color: #aaa;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 8px;
        }
        .panel-load-btn:hover {
            background: #e94560;
            color: white;
        }

        .editor-wrapper {
            flex: 1;
            overflow: hidden;
            position: relative;
            min-height: 0;
        }

        .CodeMirror {
            height: 100% !important;
            font-size: 13px;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        /* Analysis Panel */
        .analysis {
            flex: 3;
            min-width: 300px;
            max-width: 450px;
            background: #16213e;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #0f3460;
            flex-shrink: 0;
        }
        .analysis-header {
            padding: 12px 16px;
            border-bottom: 1px solid #0f3460;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .issue-count {
            background: #0f3460;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
        }
        .issue-count.error { background: #e74c3c; }
        .issue-count.warn { background: #f39c12; }
        .issue-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }
        .issue {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 3px solid;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        .issue.error { background: rgba(231, 76, 60, 0.15); border-color: #e74c3c; }
        .issue.warn { background: rgba(243, 156, 18, 0.15); border-color: #f39c12; }
        .issue.info { background: rgba(52, 152, 219, 0.15); border-color: #3498db; }
        .issue-checkbox {
            flex-shrink: 0;
            padding-top: 2px;
        }
        .issue-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #e94560;
        }
        .issue-content {
            flex: 1;
            min-width: 0;
        }
        .issue-select-all {
            padding: 10px 12px;
            background: rgba(233, 69, 96, 0.1);
            border-bottom: 1px solid #0f3460;
            font-size: 13px;
        }
        .issue-select-all label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            color: #e94560;
        }
        .issue-select-all input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #e94560;
        }
        .issue-title { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; flex-wrap: wrap; }
        .issue-icon { width: 8px; height: 8px; border-radius: 50%; }
        .issue.error .issue-icon { background: #e74c3c; }
        .issue.warn .issue-icon { background: #f39c12; }
        .issue.info .issue-icon { background: #3498db; }
        .issue-type { font-size: 11px; text-transform: uppercase; font-weight: 600; }
        .issue.error .issue-type { color: #e74c3c; }
        .issue.warn .issue-type { color: #f39c12; }
        .issue.info .issue-type { color: #3498db; }
        .issue-rule {
            font-size: 10px;
            color: #666;
            margin-left: 8px;
            padding: 2px 6px;
            background: #2a2a3e;
            border-radius: 3px;
            font-family: monospace;
        }
        .issue-fixable {
            font-size: 10px;
            margin-left: 8px;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 500;
        }
        .issue-fixable.fixable-yes {
            background: rgba(39, 174, 96, 0.2);
            color: #27ae60;
        }
        .issue-fixable.fixable-no {
            background: rgba(233, 69, 96, 0.2);
            color: #e94560;
            cursor: pointer;
            transition: all 0.2s;
        }
        .issue-fixable.fixable-no:hover {
            background: rgba(233, 69, 96, 0.4);
            color: #fff;
        }
        .issue-fixable.fixable-no::after {
            content: ' ✏️';
            font-size: 9px;
        }
        .issue-message { font-size: 13px; color: #ccc; line-height: 1.4; }
        .issue-api { font-size: 11px; color: #666; margin-top: 4px; font-family: monospace; }

        .tab-content { display: none; flex: 1; overflow: hidden; }
        .tab-content.active { display: flex; }

        .empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
        }
        .empty-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
        .empty-text { font-size: 14px; }

        .statusbar {
            background: #16213e;
            padding: 6px 16px;
            font-size: 12px;
            color: #666;
            display: flex;
            gap: 16px;
            border-top: 1px solid #0f3460;
            flex-shrink: 0;
        }

        /* Hide original textarea for CodeMirror */
        .api-panel textarea.original-textarea,
        .output-panel textarea.original-textarea { display: none; }

        /* Diff Preview Modal - 简洁直观风格 */
        .diff-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(12px);
        }
        .diff-modal.active { display: flex; }

        /* Edit Modal - 编辑弹窗 */
        .edit-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1100;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }
        .edit-modal {
            background: #1a1a2e;
            border: 1px solid #0f3460;
            border-radius: 8px;
            width: 400px;
            max-width: 90vw;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        }
        .edit-modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid #0f3460;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 15px;
            font-weight: 500;
        }
        .edit-modal-close {
            background: none;
            border: none;
            color: #888;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        .edit-modal-close:hover { color: #e94560; }
        .edit-modal-body {
            padding: 20px;
        }
        .edit-modal-body label {
            display: block;
            margin-bottom: 8px;
            font-size: 13px;
            color: #aaa;
        }
        .edit-modal-body textarea {
            width: 100%;
            padding: 10px 12px;
            background: #16213e;
            border: 1px solid #0f3460;
            border-radius: 4px;
            color: #eee;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 60px;
        }
        .edit-modal-body textarea:focus {
            outline: none;
            border-color: #e94560;
        }
        .edit-modal-footer {
            padding: 16px 20px;
            border-top: 1px solid #0f3460;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .diff-container {
            background: #0d1117;
            width: 100%;
            height: 100%;
            max-width: none;
            max-height: none;
            display: flex;
            flex-direction: column;
            border: none;
            border-radius: 0;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        /* 改进的 Diff 区块样式 */
        .diff-api-block-header {
            padding: 10px 16px;
            background: linear-gradient(180deg, #21262d 0%, #161b22 100%);
            border-bottom: 1px solid #30363d;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .diff-api-block-badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .diff-api-block-badge.get { background: #61affe; color: #fff; }
        .diff-api-block-badge.post { background: #49cc90; color: #fff; }
        .diff-api-block-badge.put { background: #fca130; color: #fff; }
        .diff-api-block-badge.delete { background: #f93e3e; color: #fff; }
        .diff-api-block-badge.patch { background: #9012fe; color: #fff; }
        .diff-api-block-path {
            font-size: 13px;
            font-weight: 500;
            color: #e6edf3;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            flex: 1;
        }
        .diff-change-indicator {
            font-size: 10px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .diff-change-indicator.added {
            background: rgba(46, 160, 67, 0.2);
            color: #3fb950;
            border: 1px solid rgba(46, 160, 67, 0.4);
        }
        .diff-change-indicator.removed {
            background: rgba(248, 81, 73, 0.2);
            color: #f85149;
            border: 1px solid rgba(248, 81, 73, 0.4);
        }
        .diff-change-indicator.modified {
            background: rgba(210, 153, 34, 0.2);
            color: #d29922;
            border: 1px solid rgba(210, 153, 34, 0.4);
        }
        .diff-change-indicator.path-fixed {
            background: rgba(56, 139, 253, 0.2);
            color: #58a6ff;
            border: 1px solid rgba(56, 139, 253, 0.4);
        }
        .diff-yaml-content {
            padding: 12px 16px;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 12px;
            line-height: 1.6;
            min-height: 60px;
        }
        .diff-yaml-content .line { display: block; padding: 2px 0; }
        .diff-yaml-content .line.removed {
            background: rgba(248, 81, 73, 0.2);
            color: #f85149;
            border-radius: 2px;
        }
        .diff-yaml-content .line.added {
            background: rgba(46, 160, 67, 0.2);
            color: #3fb950;
            border-radius: 2px;
        }

        /* 参数对比表格样式 */
        .diff-param-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
            font-size: 12px;
        }
        .diff-param-table th {
            background: #21262d;
            padding: 8px 12px;
            text-align: left;
            font-weight: 600;
            color: #8b949e;
            border-bottom: 1px solid #30363d;
        }
        .diff-param-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #21262d;
            color: #c9d1d9;
        }
        .diff-param-table tr.param-added td { background: rgba(56, 139, 253, 0.1); }
        .diff-param-table tr.param-removed td { background: rgba(248, 81, 73, 0.1); }
        .diff-param-table tr.param-changed td { background: rgba(187, 128, 9, 0.1); }
        .diff-param-table .param-name { font-weight: 500; color: #e6edf3; }
        .diff-param-table .param-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            margin-right: 6px;
        }
        .diff-param-table .param-badge.required { background: #f85149; color: #fff; }
        .diff-param-table .param-badge.optional { background: #30363d; color: #8b949e; }
        .diff-param-table .change-indicator {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 6px;
        }
        .diff-param-table .change-indicator.added { background: #238636; color: #fff; }
        .diff-param-table .change-indicator.removed { background: #da3633; color: #fff; }
        .diff-param-table .change-indicator.changed { background: #9e6a03; color: #fff; }

        /* 头部 - 简洁风格 */
        .diff-header {
            padding: 12px 24px;
            border-bottom: 1px solid #21262d;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #161b22;
            flex-shrink: 0;
        }
        .diff-title {
            font-size: 16px;
            font-weight: 600;
            color: #e6edf3;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .diff-title-icon {
            font-size: 20px;
        }

        /* 统计 - 更柔和的颜色 */
        .diff-stats {
            display: flex;
            gap: 12px;
        }
        .diff-stat {
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .diff-stat-add {
            background: rgba(56, 139, 253, 0.15);
            color: #58a6ff;
        }
        .diff-stat-remove {
            background: rgba(248, 81, 73, 0.12);
            color: #f85149;
        }

        /* 主体 - 全屏高度 */
        .diff-body {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 0;
            background: #0d1117;
        }

        /* 统一 Diff 面板 */
        .diff-unified-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .diff-unified-header {
            padding: 12px 20px;
            background: #161b22;
            font-size: 14px;
            font-weight: 600;
            color: #e6edf3;
            border-bottom: 1px solid #21262d;
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }
        .diff-unified-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: auto;
            padding: 16px 20px;
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.6;
        }
        .diff-unified-content::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .diff-unified-content::-webkit-scrollbar-track {
            background: #0d1117;
        }
        .diff-unified-content::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 4px;
        }

        /* API 块配对 - 确保前后对齐 */
        .diff-api-block-paired {
            margin-bottom: 0;
            border: 1px solid #30363d;
            border-radius: 8px;
            overflow: hidden;
            background: #161b22;
            transition: box-shadow 0.2s;
            display: grid;
            grid-template-rows: auto 1fr;
            min-height: 80px;
        }
        .diff-api-block-paired:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .diff-api-block-paired[data-index] {
            /* 确保相同 index 的块高度相同 */
        }

        /* 统一视图 API 块样式 */
        .diff-api-unified {
            margin-bottom: 24px;
            border: 1px solid #30363d;
            border-radius: 8px;
            overflow: hidden;
            background: #161b22;
        }
        .diff-api-unified-header {
            padding: 12px 16px;
            background: linear-gradient(180deg, #21262d 0%, #161b22 100%);
            border-bottom: 1px solid #30363d;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        .diff-api-unified-badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .diff-api-unified-badge.get { background: #61affe; color: #fff; }
        .diff-api-unified-badge.post { background: #49cc90; color: #fff; }
        .diff-api-unified-badge.put { background: #fca130; color: #fff; }
        .diff-api-unified-badge.delete { background: #f93e3e; color: #fff; }
        .diff-api-unified-badge.patch { background: #9012fe; color: #fff; }
        .diff-api-path-before {
            font-size: 13px;
            color: #f85149;
            font-family: 'JetBrains Mono', monospace;
            text-decoration: line-through;
            opacity: 0.7;
        }
        .diff-api-path-arrow {
            color: #8b949e;
            font-size: 14px;
        }
        .diff-api-path-after {
            font-size: 14px;
            color: #3fb950;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
        }
        .diff-api-path-unchanged {
            font-size: 14px;
            color: #e6edf3;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
        }
        .diff-api-change-type {
            margin-left: auto;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .diff-api-change-type.path-fixed {
            background: rgba(255, 184, 108, 0.15);
            color: #ffb86c;
            border: 1px solid rgba(255, 184, 108, 0.3);
        }
        .diff-api-change-type.modified {
            background: rgba(56, 139, 253, 0.15);
            color: #58a6ff;
            border: 1px solid rgba(56, 139, 253, 0.3);
        }
        .diff-api-change-type.added {
            background: rgba(46, 160, 67, 0.15);
            color: #3fb950;
            border: 1px solid rgba(46, 160, 67, 0.3);
        }

        /* 代码对比区域 - 内部显示删除和添加 */
        .diff-api-code-section {
            padding: 0;
        }
        .diff-code-section-label {
            padding: 6px 16px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #8b949e;
            background: #0d1117;
            border-bottom: 1px solid #21262d;
        }
        .diff-code-section-label.remove {
            background: rgba(248, 81, 73, 0.05);
            color: #f85149;
        }
        .diff-code-section-label.add {
            background: rgba(46, 160, 67, 0.05);
            color: #3fb950;
        }
        .diff-code-block {
            padding: 12px 16px;
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.7;
            overflow-x: auto;
            white-space: pre;
        }
        .diff-code-block.remove {
            background: rgba(248, 81, 73, 0.08);
        }
        .diff-code-block.add {
            background: rgba(46, 160, 67, 0.08);
        }
        .diff-code-block.unchanged {
            background: transparent;
            color: #8b949e;
        }

        /* 行内高亮 */
        .diff-highlight-remove {
            background: rgba(248, 81, 73, 0.3);
            color: #ffa198;
            padding: 1px 2px;
            border-radius: 2px;
        }
        .diff-highlight-add {
            background: rgba(46, 160, 67, 0.3);
            color: #7ee787;
            padding: 1px 2px;
            border-radius: 2px;
        }

        /* 行级 diff 样式 */
        .diff-line-by-line {
            padding: 0;
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.8;
        }
        .diff-line-added, .diff-line-removed {
            display: flex;
            align-items: flex-start;
            padding: 2px 16px;
        }
        .diff-line-added {
            background: rgba(46, 160, 67, 0.15);
            border-left: 3px solid #3fb950;
        }
        .diff-line-removed {
            background: rgba(248, 81, 73, 0.15);
            border-left: 3px solid #f85149;
        }
        .diff-line-marker {
            flex-shrink: 0;
            width: 20px;
            font-weight: bold;
            font-size: 14px;
        }
        .diff-line-added .diff-line-marker {
            color: #3fb950;
        }
        .diff-line-removed .diff-line-marker {
            color: #f85149;
        }
        .diff-line-code {
            flex: 1;
            white-space: pre;
            overflow-x: auto;
        }
        .diff-no-change {
            padding: 16px;
            color: #8b949e;
            font-style: italic;
            text-align: center;
        }

        /* 无变化提示 */
        .diff-no-changes {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #8b949e;
        }
        .diff-no-changes-icon {
            font-size: 48px;
            color: #3fb950;
            margin-bottom: 16px;
        }
        .diff-no-changes-text {
            font-size: 16px;
        }

        /* API 块样式 - 更简洁 */
        .diff-api-block {
            margin-bottom: 12px;
            border: 1px solid #21262d;
            border-radius: 6px;
            overflow: hidden;
        }
        .diff-api-block-header {
            padding: 8px 14px;
            background: #161b22;
            border-bottom: 1px solid #21262d;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .diff-api-block-badge {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .diff-api-block-name {
            font-size: 12px;
            font-weight: 500;
            color: #c9d1d9;
            font-family: 'JetBrains Mono', monospace;
        }
        .diff-api-block .diff-line {
            font-size: 12px;
        }
        /* API块内容容器 - 并排显示修改前/后 */
        .diff-api-block-content {
            display: flex;
            gap: 2px;
            background: #0d1117;
        }
        .diff-api-block-before,
        .diff-api-block-after {
            flex: 1;
            padding: 10px;
            overflow-x: auto;
        }
        .diff-api-block-before {
            background: rgba(248, 81, 73, 0.03);
            border-right: 1px solid #21262d;
        }
        .diff-api-block-after {
            background: rgba(56, 139, 253, 0.03);
        }
        .diff-api-block-label {
            font-size: 10px;
            font-weight: 600;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .diff-api-changes {
            font-size: 12px;
            color: #8b949e;
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(0,0,0,0.2);
            border-radius: 4px;
        }
        .diff-empty {
            padding: 40px;
            text-align: center;
            color: #6e7681;
            font-size: 14px;
        }

        /* Diff 行 */
        .diff-line {
            display: flex;
            align-items: stretch;
            min-height: 20px;
        }
        .diff-line-num {
            width: 40px;
            flex-shrink: 0;
            padding: 0 6px;
            color: #484f58;
            text-align: right;
            user-select: none;
            background: #0d1117;
            border-right: 1px solid #21262d;
            font-size: 11px;
            font-family: monospace;
        }
        .diff-line-content {
            flex: 1;
            padding: 0 10px;
            white-space: pre;
            overflow-x: visible;
            line-height: 20px;
        }

        .diff-prefix {
            display: inline-block;
            width: 14px;
            text-align: center;
            font-weight: 700;
            margin-right: 6px;
            font-family: monospace;
        }

        /* 添加行 - 更柔和的蓝色 */
        .diff-line.add {
            background: rgba(56, 139, 253, 0.08);
        }
        .diff-line.add:hover {
            background: rgba(56, 139, 253, 0.15);
        }
        .diff-line.add .diff-prefix { color: #58a6ff; }
        .diff-line.add .diff-line-content { color: #79c0ff; }

        /* 删除行 - 更柔和的红色 */
        .diff-line.remove {
            background: rgba(248, 81, 73, 0.08);
        }
        .diff-line.remove:hover {
            background: rgba(248, 81, 73, 0.15);
        }
        .diff-line.remove .diff-prefix { color: #f85149; }
        .diff-line.remove .diff-line-content { color: #ffa198; }

        /* 未改变 */
        .diff-line.unchanged .diff-line-content {
            color: #8b949e;
        }

        /* ===== 词语级别高亮 ===== */
        .diff-word-add {
            background: rgba(46, 213, 115, 0.25);
            color: #2ed573;
            padding: 1px 2px;
            border-radius: 2px;
            font-weight: 500;
        }

        .diff-word-remove {
            background: rgba(255, 71, 87, 0.25);
            color: #ff4757;
            padding: 1px 2px;
            border-radius: 2px;
            text-decoration: line-through;
            font-weight: 500;
        }

        /* ===== diff2html 样式覆盖 ===== */
        .d2h-wrapper {
            font-family: 'JetBrains Mono', 'Consolas', monospace !important;
            font-size: 13px !important;
        }
        .d2h-file-header { display: none; }
        .d2h-files { border: none !important; }
        .d2h-file {
            border: none !important;
            box-shadow: none !important;
        }
        .d2h-file-diff {
            overflow: hidden !important;
        }
        .d2h-code-side-linenum {
            width: 40px !important;
            padding: 0 8px !important;
        }
        .d2h-code-side-line {
            line-height: 20px !important;
        }
        .d2h-code-side {
            font-size: 12px !important;
        }
        /* diff2html 深色主题 */
        .d2h-dark .d2h-code-side-linenum { color: #5c5f66 !important; }
        .d2h-dark .d2h-code-side-line { color: #a4b0be !important; }
        .d2h-dark .d2h-ins { background: rgba(46, 213, 115, 0.15) !important; }
        .d2h-dark .d2h-del { background: rgba(255, 71, 87, 0.15) !important; }

        /* 空行对齐 */
        .diff-line-empty {
            background: transparent;
        }
        .diff-line-empty .diff-line-content {
            color: transparent;
        }
        .diff-line-empty .diff-prefix {
            color: #3a3d42;
        }

        /* 尾部 */
        .diff-footer {
            padding: 14px 24px;
            border-top: 1px solid #3a3d42;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #25262b;
        }
        .diff-hint {
            display: flex;
            gap: 16px;
            font-size: 12px;
            color: #747d8c;
        }
        .diff-hint-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .diff-hint-dot {
            width: 10px;
            height: 10px;
            border-radius: 2px;
        }
        .diff-hint-dot.add { background: #2ed573; }
        .diff-hint-dot.remove { background: #ff4757; }

        /* 右面板区域 */
        .diff-right-panel {
            width: 50%;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-left: 1px solid #3a3d42;
            background: #1f2023;
        }
        }
        .diff-line.add:hover {
            background: rgba(34, 197, 94, 0.2);
        }
        .diff-line.add .diff-prefix {
            color: #22c55e;
        }
        .diff-line.add .diff-line-content {
            color: #4ade80;
        }
        .diff-line.add .diff-line-num {
            background: rgba(34, 197, 94, 0.08);
            color: #22c55e;
        }

        /* 删除行 - 红色 */
        .diff-line.remove {
            background: rgba(239, 68, 68, 0.12);
        }
        .diff-line.remove:hover {
            background: rgba(239, 68, 68, 0.2);
        }
        .diff-line.remove .diff-prefix {
            color: #ef4444;
        }
        .diff-line.remove .diff-line-content {
            color: #f87171;
        }
        .diff-line.remove .diff-line-num {
            background: rgba(239, 68, 68, 0.08);
            color: #ef4444;
        }

        /* 空行对齐 - 更加低调 */
        .diff-line-empty {
            background: transparent;
        }
        .diff-line-empty:hover {
            background: rgba(139, 148, 158, 0.03);
        }
        .diff-line-empty .diff-prefix {
            color: #30363d;
        }
        .diff-line-empty .diff-line-content {
            color: transparent;
        }
        .diff-line-empty .diff-line-num {
            color: #21262d;
            background: transparent;
        }

        /* 修改的行 - 黄色/橙色高亮 */
        .diff-line.modify {
            background: rgba(234, 179, 8, 0.1);
        }
        .diff-line.modify:hover {
            background: rgba(234, 179, 8, 0.18);
        }
        .diff-line.modify .diff-prefix {
            color: #eab308;
        }
        .diff-line.modify .diff-line-content {
            color: #facc15;
        }
        .diff-line.modify .diff-line-num {
            background: rgba(234, 179, 8, 0.08);
            color: #eab308;
        }

        /* 尾部 */
        .diff-footer {
            padding: 12px 20px;
            border-top: 1px solid #30363d;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            background: #161b22;
        }
        .diff-hint {
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 12px;
            color: #8b949e;
        }
        .diff-hint-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .diff-hint-dot {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }
        .diff-hint-dot.add {
            background: #22c55e;
            box-shadow: 0 0 8px rgba(34, 197, 94, 0.4);
        }
        .diff-hint-dot.remove {
            background: #ef4444;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.4);
        }

        /* Right Panel: API + Field stacked */
        .diff-right-panel {
            width: 55%;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-left: 2px solid #30363d;
            border-left: 1px solid #3a3a3a;
        }
        .diff-api-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-bottom: 1px solid #30363d;
            min-height: 0;
        }
        /* ===== Field 区域样式 ===== */
        .diff-field-section {
            flex: 1.5;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }
        /* YAML panel - limit max width */
        .diff-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 0;
            max-width: 45%;
        }
        .diff-panel-count {
            background: rgba(56, 139, 253, 0.15);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            color: #58a6ff;
            margin-left: auto;
            font-weight: 600;
        }

        /* API Panels with before/after */
        .diff-api-panels {
            flex: 1;
            display: flex;
            overflow: hidden;
            min-height: 0;
        }
        .diff-api-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }
        .diff-api-panel-left {
            border-right: 1px solid #30363d;
        }
        .diff-api-header, .diff-field-header {
            padding: 10px 14px;
            background: #161b22;
            font-size: 11px;
            font-weight: 600;
            color: #8b949e;
            border-bottom: 1px solid #30363d;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .diff-api-list, .diff-field-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            min-height: 0;
            background: #0d1117;
        }

        /* Field Panels with before/after */
        .diff-field-panels {
            flex: 1;
            display: flex;
            overflow: hidden;
            min-height: 0;
        }
        .diff-field-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }
        .diff-field-panel-left {
            border-right: 1px solid #30363d;
        }

        /* API/Field item styles - Git 风格 */
        .diff-api-item-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            margin-bottom: 8px;
            background: #161b22;
            border-radius: 6px;
            font-family: 'JetBrains Mono', 'Consolas', monospace;
            font-size: 12px;
            border-left: 3px solid transparent;
            transition: background 0.15s ease;
        }
        .diff-api-item-row:hover {
            background: #1c2128;
        }
        .diff-api-item-row.added {
            border-left-color: #22c55e;
            background: rgba(34, 197, 94, 0.08);
        }
        .diff-api-item-row.added:hover {
            background: rgba(34, 197, 94, 0.12);
        }
        .diff-api-item-row.removed {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.08);
        }
        .diff-api-item-row.removed:hover {
            background: rgba(239, 68, 68, 0.12);
        }
        .diff-api-item-row.modified {
            border-left-color: #eab308;
            background: rgba(234, 179, 8, 0.08);
        }
        .diff-api-item-row.modified:hover {
            background: rgba(234, 179, 8, 0.12);
        }
        .diff-api-item-row.unchanged {
            border-left-color: #30363d;
            opacity: 0.7;
        }
        .diff-api-change-detail {
            padding: 4px 10px 4px 30px;
            font-size: 11px;
            color: #8b949e;
            font-family: 'JetBrains Mono', 'Consolas', monospace;
        }
        .diff-api-compact {
            display: flex;
            align-items: center;
            padding: 6px 12px;
            border-bottom: 1px solid #2d333b;
            gap: 8px;
            font-size: 12px;
        }
        .diff-api-compact .diff-path {
            color: #c9d1d9;
            font-family: 'JetBrains Mono', monospace;
        }
        .diff-api-compact .diff-path-old {
            color: #ef4444;
            text-decoration: line-through;
            opacity: 0.8;
            font-family: 'JetBrains Mono', monospace;
        }
        .diff-api-compact .diff-path-new {
            color: #22c55e;
            font-family: 'JetBrains Mono', monospace;
        }
        /* ===== Tag 标签样式 ===== */
        .diff-tag-add {
            color: #22c55e;
            font-size: 10px;
            font-weight: 600;
            margin-left: auto;
            padding: 2px 6px;
            background: rgba(34, 197, 94, 0.15);
            border-radius: 3px;
        }
        .diff-tag-del {
            color: #ef4444;
            font-size: 10px;
            font-weight: 600;
            margin-left: auto;
            padding: 2px 6px;
            background: rgba(239, 68, 68, 0.15);
            border-radius: 3px;
        }
        .diff-tag-mod {
            color: #eab308;
            font-size: 10px;
            font-weight: 600;
            margin-left: auto;
            padding: 2px 6px;
            background: rgba(234, 179, 8, 0.15);
            border-radius: 3px;
        }
        /* ===== Java 代码风格显示 - Git 风格 ===== */
        .diff-api-java {
            padding: 10px 14px;
            border-bottom: 1px solid #21262d;
            font-size: 12px;
            position: relative;
            border-left: 3px solid transparent;
        }
        .diff-api-java.diff-api-add {
            background: rgba(34, 197, 94, 0.08);
            border-left-color: #22c55e;
        }
        .diff-api-java.diff-api-del {
            background: rgba(239, 68, 68, 0.08);
            border-left-color: #ef4444;
        }
        .diff-api-java.diff-api-mod {
            background: rgba(234, 179, 8, 0.08);
            border-left-color: #eab308;
        }
        .diff-api-java.diff-api-del .diff-java-annotation,
        .diff-api-java.diff-api-del .diff-java-method {
            text-decoration: line-through;
            opacity: 0.6;
            color: #f87171;
        }
        .diff-java-annotation {
            color: #d2a8ff;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
        }
        .diff-custom-annotations {
            color: #ff7b72;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            margin-bottom: 4px;
        }
        .diff-java-code {
            color: #c9d1d9;
            font-family: 'JetBrains Mono', 'Consolas', monospace;
            font-size: 12px;
            margin: 0;
            white-space: pre;
            line-height: 1.5;
        }
        .diff-api-java.diff-api-del .diff-java-code {
            opacity: 0.6;
        }
        .diff-java-method {
            color: #7ee787;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            margin-top: 4px;
        }
        .diff-api-java .diff-tag-add,
        .diff-api-java .diff-tag-mod {
            position: absolute;
            top: 10px;
            right: 14px;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
        }
        .diff-tag-add {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }
        .diff-tag-del {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        .diff-tag-mod {
            background: rgba(234, 179, 8, 0.2);
            color: #eab308;
        }
        .diff-change-prop {
            color: #79c0ff;
        }
        .diff-change-item {
            padding: 4px 0;
            line-height: 1.4;
        }
        .diff-change-before {
            color: #ef4444;
            text-decoration: line-through;
            opacity: 0.8;
        }
        .diff-change-after {
            color: #22c55e;
            padding-left: 12px;
            font-weight: 500;
        }
        .diff-api-method {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.3px;
            color: #fff;
        }
        .diff-api-method.get { background: #61affe; }
        .diff-api-method.post { background: #49cc90; }
        .diff-api-method.put { background: #fca130; }
        .diff-api-method.delete { background: #f93e3e; }
        .diff-api-path {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: #e6edf3;
        }
        .diff-api-type {
            font-size: 11px;
            color: #8b949e;
            margin-left: auto;
        }

        /* Field item styles - Git 风格 */
        .diff-field-class {
            margin-bottom: 14px;
        }
        .diff-field-class-title {
            font-size: 12px;
            font-weight: 600;
            color: #f472b6;
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 1px solid #30363d;
            font-family: 'JetBrains Mono', monospace;
        }
        .diff-field-item-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            margin-bottom: 6px;
            background: #161b22;
            border-radius: 5px;
            font-family: 'JetBrains Mono', 'Consolas', monospace;
            font-size: 11px;
            border-left: 3px solid transparent;
            transition: background 0.15s ease;
        }
        .diff-field-item-row:hover {
            background: #1c2128;
        }
        .diff-field-item-row.added {
            border-left-color: #22c55e;
            background: rgba(34, 197, 94, 0.08);
        }
        .diff-field-item-row.added:hover {
            background: rgba(34, 197, 94, 0.12);
        }
        .diff-field-item-row.removed {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.08);
        }
        .diff-field-item-row.removed:hover {
            background: rgba(239, 68, 68, 0.12);
        }
        .diff-field-item-row.modified {
            border-left-color: #eab308;
            background: rgba(234, 179, 8, 0.08);
        }
        .diff-field-item-row.modified:hover {
            background: rgba(234, 179, 8, 0.12);
        }
        .diff-field-item-row.unchanged {
            border-left-color: #30363d;
            opacity: 0.7;
        }
        .diff-field-type {
            color: #79c0ff;
        }
        .diff-field-name {
            color: #ffa657;
            font-weight: 500;
        }
        .diff-field-annotations {
            margin-left: auto;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        .diff-field-ann {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
        }
        .diff-field-ann.added {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }
        .diff-field-ann.removed {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        .diff-field-ann.original {
            background: rgba(234, 179, 8, 0.2);
            color: #eab308;
        }
        .diff-field-change-detail {
            padding: 6px 12px 6px 24px;
            font-size: 11px;
            color: #8b949e;
            font-family: 'JetBrains Mono', 'Consolas', monospace;
        }
        .diff-field-row {
            padding: 6px 14px;
            font-family: 'JetBrains Mono', 'Consolas', monospace;
            font-size: 12px;
            border-bottom: 1px solid #21262d;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .diff-annotations {
            color: #22c55e;
            font-size: 11px;
        }
        .diff-validation-details {
            font-size: 10px;
            color: #888;
            margin-top: 4px;
            padding-left: 8px;
            border-left: 2px solid #444;
        }
        .diff-validation-after {
            color: #22c55e;
            border-left-color: #22c55e;
        }
        /* ===== IDE风格的颜色 - Java语法高亮 ===== */
        .diff-java-type { color: #79c0ff; }  /* 蓝色 - 类型 */
        .diff-java-name { color: #e3b341; }  /* 黄色 - 字段名 */
        .diff-java-keyword { color: #ff7b72; }  /* 红色 - 关键字 */
        .diff-java-annotation { color: #d2a8ff; }  /* 紫色 - 注解 */
        .diff-java-string { color: #a5d6ff; }  /* 浅蓝 - 字符串 */
        .diff-java-number { color: #79c0ff; }  /* 蓝色 - 数字 */
        .diff-java-comment { color: #8b949e; }  /* 灰色 - 注释 */

        /* 变更对比的颜色 - Git 风格 */
        .diff-prop { color: #79c0ff; }
        .diff-old-val { color: #ef4444; text-decoration: line-through; opacity: 0.7; font-weight: 500; }
        .diff-new-val { color: #22c55e; font-weight: 600; }

        /* IDE风格语法高亮 - 统一类名 */
        .diff-java-code .syntax-keyword { color: #ff7b72; }   /* 关键字: private, public, return, void */
        .diff-java-code .syntax-type { color: #79c0ff; }     /* 类型: String, Integer, Response */
        .diff-java-code .syntax-field { color: #e3b341; }    /* 字段名/参数名 */
        .diff-java-code .syntax-string { color: #a5d6ff; }    /* 字符串 */
        .diff-java-code .syntax-number { color: #79c0ff; }    /* 数字 */
        .diff-java-code .syntax-comment { color: #8b949e; font-style: italic; }  /* 注释 */
        .diff-java-code .syntax-method { color: #d2a8ff; }    /* 方法名 */
        .diff-java-code .syntax-annotation { color: #d2a8ff; } /* 注解: @Post, @Path, @Valid */

        /* API变更详情样式 */
        .diff-changes {
            padding: 8px 12px;
            background: #161b22;
            border-bottom: 1px solid #30363d;
            font-family: 'JetBrains Mono', 'Consolas', monospace;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="app">
        <header class="header">
            <div class="logo">API Codegen</div>
            <nav class="nav">
                <button class="nav-btn active">API + Config</button>
            </nav>
            <div class="actions">
                <button class="btn btn-secondary" onclick="loadExample()">加载示例</button>
                <button class="btn btn-secondary" onclick="saveFile()">保存</button>
                <button class="btn btn-primary" onclick="analyze()">分析</button>
                <button class="btn btn-success" onclick="autoFix()">自动修复</button>
            </div>
        </header>

        <main class="main">
            <!-- API YAML Editor -->
            <div class="panel api-panel">
                <div class="panel-header">
                    <span>API 定义 (api.yaml)</span>
                    <span id="yaml-info">-</span>
                    <button class="panel-load-btn" onclick="loadApiFile()">打开</button>
                </div>
                <div class="editor-wrapper">
                    <textarea id="yaml-editor" class="original-textarea"></textarea>
                </div>
            </div>

            <!-- Analysis Panel -->
            <aside class="analysis">
                <div class="analysis-header">
                    <span>分析结果</span>
                    <span class="issue-count" id="issue-count">0</span>
                </div>
                <div class="issue-list" id="issue-list">
                    <div class="empty">
                        <div class="empty-icon">&#128221;</div>
                        <div class="empty-text">点击"分析"检查 YAML</div>
                    </div>
                </div>
            </aside>
        </main>

        <footer class="statusbar">
            <span id="status-position">行: 1, 列: 1</span>
            <span>|</span>
            <span id="status-api">API: 0</span>
            <span>|</span>
            <span id="status-field">字段: 0</span>
            <span>|</span>
            <span id="status-message">就绪</span>
        </footer>
    </div>

    <!-- Diff Preview Modal -->
    <div class="diff-modal" id="diff-modal">
        <div class="diff-container">
            <div class="diff-header">
                <div class="diff-title">
                    <span class="diff-title-icon">&#128293;</span>
                    <span>修复预览</span>
                </div>
                <div class="diff-stats">
                    <div class="diff-stat diff-stat-remove">
                        <span>&minus;</span>
                        <span id="diff-removes">0 处删除</span>
                    </div>
                    <div class="diff-stat diff-stat-add">
                        <span>&plus;</span>
                        <span id="diff-adds">0 处添加</span>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="closeDiffModal()">关闭</button>
            </div>
            <div class="diff-body">
                <!-- 统一 Diff 视图 -->
                <div class="diff-unified-panel">
                    <div class="diff-unified-header">
                        <span class="diff-panel-badge before">修复前</span>
                        <span style="margin: 0 8px;">→</span>
                        <span class="diff-panel-badge after">修复后</span>
                        <span style="margin-left: 12px; color: #8b949e;">Java 代码变更预览</span>
                    </div>
                    <div class="diff-unified-content" id="diff-unified"></div>
                </div>
            </div>
            <div class="diff-footer">
                <div class="diff-hint">
                    <span class="diff-hint-item">
                        <span class="diff-hint-dot add"></span>
                        <span>添加的行</span>
                    </span>
                    <span class="diff-hint-item">
                        <span class="diff-hint-dot remove"></span>
                        <span>删除的行</span>
                    </span>
                </div>
                <button class="btn btn-secondary" onclick="closeDiffModal()">取消</button>
                <button class="btn btn-success" onclick="applyFix()">应用修复</button>
            </div>
        </div>
    </div>

    <script src="lib/js-yaml.min.js"></script>
    <script>
        // 确保 jsyaml 全局可用 (js-yaml 可能创建 window.jsyaml)
        if (typeof jsyaml === 'undefined' && typeof window.jsyaml !== 'undefined') {
            jsyaml = window.jsyaml;
        }
    </script>
    <script src="lib/codemirror.min.js"></script>
    <script src="lib/yaml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.2.0/diff.min.js"></script>
    <script src="js/analyzer.js"></script>
    <script>
        var yamlEditor;

        // Default YAML content (使用Swagger 2.0格式，包含实体对象示例)
        var defaultYaml = `swagger: "2.0"
info:
  title: 电商系统API
  version: "1.0"
basePath: /api/v1
paths:
  # ==================== 简单参数示例 ====================
  /users:
    get:
      summary: 查询用户列表
      operationId: queryUserList
      description: 分页查询用户列表，支持关键词搜索
      parameters:
        - name: page
          in: query
          description: 页码（从1开始）
          required: true
          schema:
            type: integer
        - name: pageSize
          in: query
          description: 每页数量
          schema:
            type: integer
        - name: keyword
          in: query
          description: 搜索关键词
          schema:
            type: string
        - name: status
          in: query
          description: 用户状态
          schema:
            type: string
            enum: [active, inactive, banned]
      responses:
        200:
          description: 查询成功
          schema:
            $ref: '#/definitions/PageResult'

  # ==================== 实体对象示例 ====================
  /users:
    post:
      summary: 创建用户
      operationId: createUser
      description: 创建新用户，需要提供用户基本信息
      parameters:
        - name: body
          in: body
          required: true
          schema:
            $ref: '#/definitions/CreateUserReq'
      responses:
        201:
          description: 创建成功
          schema:
            $ref: '#/definitions/CreateUserRsp'

  # ==================== 路径参数示例 ====================
  /users/{userId}:
    get:
      summary: 获取用户详情
      operationId: getUserById
      parameters:
        - name: userId
          in: path
          description: 用户ID
          required: true
          schema:
            type: integer
            format: int64
      responses:
        200:
          description: 成功
          schema:
            $ref: '#/definitions/UserDetail'

  # ==================== 复杂实体示例 ====================
  /orders:
    post:
      summary: 创建订单
      operationId: createOrder
      description: 创建新订单，包含多个商品
      parameters:
        - name: body
          in: body
          required: true
          schema:
            $ref: '#/definitions/CreateOrderReq'
      responses:
        201:
          description: 订单创建成功
          schema:
            $ref: '#/definitions/OrderRsp'

  /orders/{orderId}:
    get:
      summary: 获取订单详情
      operationId: getOrderById
      parameters:
        - name: orderId
          in: path
          description: 订单ID
          required: true
          schema:
            type: string
        - name: includeItems
          in: query
          description: 是否包含订单项详情
          schema:
            type: boolean
      responses:
        200:
          description: 成功
          schema:
            $ref: '#/definitions/OrderDetail'

# ==================== 实体定义 ====================
definitions:
  # 分页结果
  PageResult:
    type: object
    properties:
      total:
        type: integer
        description: 总记录数
      page:
        type: integer
        description: 当前页码
      pageSize:
        type: integer
        description: 每页数量
      list:
        type: array
        description: 数据列表
        items:
          $ref: '#/definitions/User'

  # 用户基本信息
  User:
    type: object
    properties:
      id:
        type: integer
        format: int64
        description: 用户ID
      username:
        type: string
        description: 用户名
      email:
        type: string
        format: email
        description: 邮箱
      phone:
        type: string
        description: 手机号
      status:
        type: string
        enum: [active, inactive, banned]
        description: 状态
      createdAt:
        type: string
        format: date-time
        description: 创建时间

  # 创建用户请求
  CreateUserReq:
    type: object
    required:
      - username
      - email
      - password
    properties:
      username:
        type: string
        minLength: 4
        maxLength: 20
        description: 用户名（4-20字符）
      email:
        type: string
        format: email
        description: 邮箱地址
      password:
        type: string
        minLength: 8
        maxLength: 32
        description: 密码（8-32字符）
      phone:
        type: string
        description: 手机号（可选）
      nickname:
        type: string
        maxLength: 50
        description: 昵称
      birthday:
        type: string
        format: date
        description: 生日

  # 创建用户响应
  CreateUserRsp:
    type: object
    properties:
      userId:
        type: integer
        format: int64
        description: 新创建的用户ID
      success:
        type: boolean
        description: 是否成功

  # 用户详情
  UserDetail:
    type: object
    properties:
      id:
        type: integer
        format: int64
      username:
        type: string
      email:
        type: string
      phone:
        type: string
      nickname:
        type: string
      avatar:
        type: string
        description: 头像URL
      status:
        type: string
      createdAt:
        type: string
        format: date-time
      updatedAt:
        type: string
        format: date-time

  # 创建订单请求
  CreateOrderReq:
    type: object
    required:
      - userId
      - items
    properties:
      userId:
        type: integer
        format: int64
        description: 用户ID
      shippingAddress:
        type: string
        description: 收货地址
      items:
        type: array
        description: 订单项列表
        items:
          $ref: '#/definitions/OrderItemReq'
      couponCode:
        type: string
        description: 优惠券代码
      remark:
        type: string
        maxLength: 200
        description: 订单备注

  # 订单项请求
  OrderItemReq:
    type: object
    required:
      - productId
      - quantity
    properties:
      productId:
        type: integer
        format: int64
        description: 商品ID
      quantity:
        type: integer
        minimum: 1
        maximum: 999
        description: 购买数量
      skuId:
        type: string
        description: SKU ID

  # 创建订单响应
  OrderRsp:
    type: object
    properties:
      orderId:
        type: string
        description: 订单号
      totalAmount:
        type: number
        format: double
        description: 订单总金额
      success:
        type: boolean

  # 订单详情
  OrderDetail:
    type: object
    properties:
      orderId:
        type: string
      userId:
        type: integer
        format: int64
      status:
        type: string
        enum: [pending, paid, shipped, completed, cancelled]
      totalAmount:
        type: number
        format: double
      items:
        type: array
        items:
          $ref: '#/definitions/OrderItem'
      createdAt:
        type: string
        format: date-time

  # 订单项
  OrderItem:
    type: object
    properties:
      productId:
        type: integer
        format: int64
      productName:
        type: string
      quantity:
        type: integer
      price:
        type: number
        format: double
      subtotal:
        type: number
        format: double`;

        // 存储用户的原始 YAML（用于预览对比）
        var originalYaml = defaultYaml;
        var currentFramework = 'spring'; // 默认 Spring MVC

        // 示例数据定义 - 从外部 YAML 文件加载
        var exampleFiles = {
            'swagger': '../swagger2-example.yaml',
            'openapi': '../openapi3-example.yaml'
        };

        // 异步加载外部 YAML 文件
        function loadYamlFromFile(filePath) {
            return fetch(filePath)
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('无法加载文件: ' + filePath);
                    }
                    return response.text();
                })
                .then(function(yaml) {
                    // 自动去掉注释
                    return stripYamlComments(yaml);
                })
                .catch(function(err) {
                    console.error('加载文件失败:', err);
                    return null;
                });
        }

        // 缓存已加载的示例
        var examplesCache = {};

        // 预加载所有示例文件
        Object.keys(exampleFiles).forEach(function(key) {
            loadYamlFromFile(exampleFiles[key]).then(function(yaml) {
                if (yaml) {
                    examplesCache[key] = yaml;
                }
            });
        });

        // 示例数据定义（使用缓存）
        var examples = {
            'swagger': {
                name: 'Swagger 2.0 (swagger2-example.yaml)',
                yaml: null  // 异步加载
            },
            'openapi': {
                name: 'OpenAPI 3.0 (openapi3-example.yaml)',
                yaml: null  // 异步加载
            }
        };

        // 异步加载示例（从URL参数）
        function loadExampleFromUrl() {
            var params = new URLSearchParams(window.location.search);
            var demo = params.get('demo');
            if (demo && examples[demo]) {
                var example = examples[demo];
                document.getElementById('yaml-info').textContent = example.name + ' (URL参数)';
                // 异步加载外部文件
                var filePath = exampleFiles[demo];
                if (filePath) {
                    loadYamlFromFile(filePath).then(function(yaml) {
                        if (yaml) {
                            yamlEditor.setValue(yaml);
                            originalYaml = yaml;
                            updateStatus();
                        }
                    });
                }
                return ''; // 返回空字符串，稍后异步加载
            }
            return null;
        }

        function init() {
            // 尝试从URL参数加载示例（异步）
            loadExampleFromUrl();

            // Initialize YAML editor
            yamlEditor = CodeMirror.fromTextArea(document.getElementById('yaml-editor'), {
                mode: 'yaml',
                theme: 'dracula',
                lineNumbers: true,
                lineWrapping: true,
                indentUnit: 2,
                tabSize: 2
            });

            // Set default content (blank, user can click "加载示例" to load)
            var currentYaml = '';
            yamlEditor.setValue(currentYaml);
            originalYaml = currentYaml;  // 保存为原始版本

            // Events
            yamlEditor.on('cursorActivity', updateStatus);
            yamlEditor.on('change', function() {
                updateStatus();
                document.getElementById('yaml-info').textContent = '已修改';
            });

            updateStatus();
        }

        function updateStatus() {
            var cursor = yamlEditor.getDoc().getCursor();
            document.getElementById('status-position').textContent = '行: ' + (cursor.line + 1) + ', 列: ' + (cursor.ch + 1);

            try {
                var content = yamlEditor.getValue();
                var parsed = jsyaml.load(content);

                if (!parsed || !parsed.apis) {
                    document.getElementById('status-api').textContent = 'API: 0';
                    document.getElementById('status-field').textContent = '字段: 0';
                    return;
                }

                var apiCount = parsed.apis.length;
                var fieldCount = 0;

                parsed.apis.forEach(function(api) {
                    if (api.request && api.request.fields) fieldCount += api.request.fields.length;
                    if (api.response && api.response.fields) fieldCount += api.response.fields.length;
                });

                document.getElementById('status-api').textContent = 'API: ' + apiCount;
                document.getElementById('status-field').textContent = '字段: ' + fieldCount;
            } catch (e) {
                document.getElementById('status-api').textContent = 'API: -';
                document.getElementById('status-field').textContent = '字段: -';
            }
        }

        function loadExample() {
            // 显示示例选择菜单
            var exampleKeys = Object.keys(examples);
            var options = exampleKeys.map(function(key, idx) {
                return (idx + 1) + '. ' + examples[key].name;
            }).join('\n');

            var choice = prompt('选择格式示例:\n\n' + options + '\n\n输入数字:');

            var exampleKey = 'basic';
            if (choice) {
                var num = parseInt(choice);
                if (num >= 1 && num <= exampleKeys.length) {
                    exampleKey = exampleKeys[num - 1];
                }
            }

            var example = examples[exampleKey];
            var filePath = exampleFiles[exampleKey];

            // 异步加载外部 YAML 文件
            if (filePath) {
                loadYamlFromFile(filePath).then(function(yaml) {
                    if (yaml) {
                        originalYaml = yaml;
                        yamlEditor.setValue(yaml);
                        yamlEditor.refresh();
                        updateStatus();
                        document.getElementById('issue-list').innerHTML = '<div class="empty"><div class="empty-icon">&#128221;</div><div class="empty-text">点击"分析"检查 YAML</div></div>';
                        document.getElementById('issue-count').textContent = '0';
                        document.getElementById('issue-count').className = 'issue-count';
                        document.getElementById('yaml-info').textContent = example.name;
                        setMessage('已加载: ' + example.name);
                    } else {
                        setMessage('加载失败，请检查网络或文件是否存在');
                    }
                });
            }
        }

        // Load API YAML file
        function loadApiFile() {
            var input = document.createElement('input');
            input.type = 'file';
            input.accept = '.yaml,.yml';
            input.onchange = function(e) {
                var file = e.target.files[0];
                var reader = new FileReader();
                reader.onload = function(e) {
                    var content = e.target.result;
                    // 上传时直接去掉注释
                    var cleanContent = stripYamlComments(content);
                    originalYaml = cleanContent;  // 保存去掉注释后的内容
                    yamlEditor.setValue(cleanContent);
                    yamlEditor.refresh();
                    document.getElementById('yaml-info').textContent = file.name;
                    updateStatus();
                    setMessage('已加载 API: ' + file.name);
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // 去掉 YAML 注释
        function stripYamlComments(content) {
            var lines = content.split('\n');
            var result = [];
            lines.forEach(function(line) {
                // 去掉 # 注释（但保留 # 在字符串里的情况）
                var trimmed = line.trim();
                if (trimmed === '' || trimmed.startsWith('#')) {
                    return; // 跳过空行和纯注释行
                }
                // 查找 # 的位置（不在引号内）
                var inString = false;
                var stringChar = '';
                for (var i = 0; i < line.length; i++) {
                    var c = line[i];
                    if (!inString && (c === '"' || c === "'")) {
                        inString = true;
                        stringChar = c;
                    } else if (inString && c === stringChar && line[i-1] !== '\\') {
                        inString = false;
                    } else if (!inString && c === '#') {
                        // 找到注释开始
                        line = line.substring(0, i);
                        break;
                    }
                }
                result.push(line);
            });
            return result.join('\n');
        }

        function saveFile() {
            var content = yamlEditor.getValue();
            var blob = new Blob([content], { type: 'text/yaml' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'api.yaml';
            a.click();
            URL.revokeObjectURL(url);
            setMessage('已保存');
        }

        function analyze() {
            var content = yamlEditor.getValue();
            originalYaml = content;  // 保存当前内容作为原始版本，用于预览对比
            var analyzer = new ApiYamlAnalyzer();
            var issues = analyzer.analyze(content);

            document.getElementById('issue-count').textContent = issues.length;
            renderIssues(issues);

            var errorCount = issues.filter(function(i) { return i.severity === 'error'; }).length;
            var warnCount = issues.filter(function(i) { return i.severity === 'warn'; }).length;

            var countEl = document.getElementById('issue-count');
            countEl.className = 'issue-count';
            if (errorCount > 0) countEl.classList.add('error');
            else if (warnCount > 0) countEl.classList.add('warn');

            setMessage('分析完成: ' + errorCount + ' 错误, ' + warnCount + ' 警告');
        }

        // Store issues with selection state
        var selectedIssues = {};

        function renderIssues(issues) {
            var container = document.getElementById('issue-list');

            if (issues.length === 0) {
                container.innerHTML = '<div class="empty"><div class="empty-icon">&#10004;</div><div class="empty-text">没有发现问题！</div></div>';
                return;
            }

            // Reset selection - info issues not selected by default (they don't need fixing)
            selectedIssues = {};
            issues.forEach(function(issue, i) {
                // Default to selected, except info which doesn't need fixing
                selectedIssues[i] = issue.severity !== 'info';
            });

            var html = '<div class="issue-select-all">' +
                '<label><input type="checkbox" id="select-all-issues" checked onchange="toggleAllIssues(this.checked)"> 全选</label>' +
                '<span style="margin-left: 12px; font-size: 11px; color: #888;">' +
                '<span style="color: #27ae60;">● 可修复</span> 自动修复 &nbsp; ' +
                '<span style="color: #e94560;">● 需手动</span> 点击编辑' +
                '</span></div>';

            html += issues.map(function(issue, index) {
                var checked = selectedIssues[index] ? 'checked' : '';
                var severityText = issue.severity === 'error' ? '错误' : (issue.severity === 'warn' ? '警告' : '提示');

                // 判断是否可以自动修复
                var canAutoFix = isAutoFixable(issue);

                if (canAutoFix) {
                    var fixableBadge = '<span class="issue-fixable fixable-yes" title="此问题可以自动修复">可修复</span>';
                } else {
                    var fixableBadge = '<button type="button" class="issue-fixable fixable-no" title="点击编辑" onclick="event.stopPropagation(); event.preventDefault(); handleManualIssue(' + index + ');">需手动</button>';
                }

                return '<div class="issue ' + issue.severity + '">' +
                    '<div class="issue-checkbox">' +
                    '<input type="checkbox" ' + checked + ' onchange="toggleIssue(' + index + ', this.checked)">' +
                    '</div>' +
                    '<div class="issue-content">' +
                    '<div class="issue-title">' +
                    '<span class="issue-icon"></span>' +
                    '<span class="issue-type">' + severityText + '</span>' +
                    '<span class="issue-rule" title="规则依据">' + (issue.rule || '') + '</span>' +
                    fixableBadge +
                    '</div>' +
                    '<div class="issue-message">' + issue.message + '</div>' +
                    (issue.api !== undefined ? '<div class="issue-api">API: ' + issue.api + '</div>' : '') +
                    '</div>' +
                    '</div>';
            }).join('');

            container.innerHTML = html;
            window.currentIssues = issues;
            updateIssueCount();
        }

        /**
         * 处理"需手动"问题的点击 - 跳转到编辑位置或显示编辑弹窗
         */
        function handleManualIssue(index) {
            console.log('handleManualIssue called with index:', index);
            var issue = window.currentIssues[index];
            console.log('issue:', issue);
            if (!issue) {
                console.error('No issue found at index:', index);
                return;
            }

            // 检查问题类型，提供对应的编辑功能
            var msg = issue.message;
            console.log('issue message:', msg);

            // 如果是缺少 description 的问题，显示编辑弹窗
            if (msg.includes('缺少 description')) {
                console.log('Showing description editor');
                showDescriptionEditor(issue);
            }
            // 如果是 x-java-class-annotations 问题，显示编辑弹窗
            else if (msg.includes('x-java-class-annotations') || msg.includes('annotations')) {
                console.log('Showing annotations editor');
                showDescriptionEditor(issue);
            }
            // 如果是 minLength/maxLength 错误，跳转到对应位置
            else if (msg.includes('minLength') || msg.includes('maxLength')) {
                jumpToYamlLocation(issue);
            }
            // 其他情况，跳转到对应位置
            else {
                jumpToYamlLocation(issue);
            }
        }

        /**
         * 显示 description 编辑弹窗
         */
        function showDescriptionEditor(issue) {
            var fieldName = '';
            var fieldType = '';
            var helpText = '';
            var exampleText = '';

            if (issue.message.includes('必填参数')) {
                var match = issue.message.match(/必填参数 (\w+) 缺少/);
                fieldName = match ? match[1] : '参数';
                fieldType = '参数';
                helpText = '请输入参数的描述信息，说明参数的用途和格式要求';
                exampleText = '例如：用户ID，用于唯一标识用户';
            } else if (issue.message.includes('requestBody')) {
                fieldName = 'requestBody';
                fieldType = 'requestBody';
                helpText = '请输入请求体的描述信息，说明请求体的用途和包含的数据';
                exampleText = '例如：创建用户的请求体，包含用户名、邮箱等基本信息';
            } else if (issue.message.includes('x-java-class-annotations')) {
                fieldName = 'x-java-class-annotations';
                fieldType = 'annotations';
                // 提取路径信息
                var pathMatch = issue.message.match(/路径\s+(\/[^\s]+)\s+下/);
                var pathStr = pathMatch ? pathMatch[1] : '未知路径';
                var methodMatch = issue.message.match(/(\w+)\s+方法/);
                var methodStr = methodMatch ? methodMatch[1] : '未知方法';

                helpText = '<b>问题说明：</b><br>' +
                    '在 Swagger/OpenAPI 中，您可以为路径（path）和方法（method）分别配置 x-java-class-annotations。<br><br>' +
                    '<b>当前状态：</b><br>' +
                    '• 路径：' + pathStr + '<br>' +
                    '• 方法：' + methodStr + '<br>' +
                    '• 问题：路径级别和方法级别的 x-java-class-annotations 注解配置不一致<br><br>' +
                    '<b>解决方法：</b><br>' +
                    '1. 在下方输入框中填写要统一使用的类级别注解（每行一个）<br>' +
                    '2. 点击"应用"后，系统会自动在路径级别添加这些注解<br>' +
                    '3. 如果需要修改方法级别的注解，请手动编辑 YAML 文件';
                exampleText = '@Secured\n@AuditLog(action="USER_QUERY")';
            }

            var defaultValue = '';
            var placeholder = '';
            if (fieldType === 'annotations') {
                placeholder = '@Secured\n@AuditLog(action="USER_QUERY")\n@Permission("admin:user:read")';
            } else {
                placeholder = exampleText;
            }

            // 创建编辑弹窗 - annotations 使用更大的弹窗
            var modalWidth = fieldType === 'annotations' ? '600px' : '500px';
            var modalHtml = '<div class="edit-modal-overlay" onclick="closeEditModal(event)">' +
                '<div class="edit-modal" onclick="event.stopPropagation()" style="max-width: ' + modalWidth + ';">' +
                '<div class="edit-modal-header">' +
                '<span>📝 编辑 ' + (fieldType === 'annotations' ? '类级别注解' : '描述') + '</span>' +
                '<button class="edit-modal-close" onclick="closeEditModal()">&times;</button>' +
                '</div>' +
                '<div class="edit-modal-body">' +
                '<div style="background: rgba(255,193,7,0.1); border: 1px solid rgba(255,193,7,0.3); border-radius: 4px; padding: 10px 12px; margin-bottom: 12px; font-size: 12px; color: #ffc107; line-height: 1.6;">' +
                helpText +
                '</div>' +
                (fieldType !== 'annotations' ? '<label>' + fieldType + ': <strong>' + fieldName + '</strong></label>' : '') +
                (issue.api ? '<label style="color: #888;">API: ' + issue.api + '</label>' : '') +
                '<label style="margin-top: 12px; display: block;">' + (fieldType === 'annotations' ? '请输入要添加的类级别注解（每行一个）:' : '描述内容:') + '</label>' +
                '<textarea id="edit-description-input" placeholder="' + placeholder + '" rows="' + (fieldType === 'annotations' ? '4' : '3') + '" style="font-family: ' + (fieldType === 'annotations' ? 'monospace' : 'inherit') + ';">' + defaultValue + '</textarea>' +
                (fieldType === 'annotations' ? '<div style="font-size: 11px; color: #888; margin-top: 4px;">提示：注解格式为 @AnnotationName 或 @AnnotationName(param="value")</div>' : '') +
                '</div>' +
                '<div class="edit-modal-footer">' +
                '<button class="btn btn-secondary" onclick="closeEditModal()">取消</button>' +
                '<button class="btn btn-primary" onclick="applyDescriptionEdit(\'' + fieldName + '\', \'' + fieldType + '\', \'' + (issue.field || '') + '\', \'' + (issue.api || '') + '\')">应用</button>' +
                '</div>' +
                '</div>' +
                '</div>';

            // 添加到页面
            var div = document.createElement('div');
            div.id = 'edit-modal-container';
            div.innerHTML = modalHtml;
            document.body.appendChild(div);

            // 聚焦输入框
            setTimeout(function() {
                var input = document.getElementById('edit-description-input');
                if (input) {
                    input.focus();
                    input.select();
                }
            }, 100);
        }

        /**
         * 应用 description 编辑
         */
        function applyDescriptionEdit(fieldName, fieldType, issueField, issueApi) {
            var description = document.getElementById('edit-description-input').value.trim();
            if (!description) {
                alert('请输入内容');
                return;
            }

            // 输入验证
            if (fieldType === 'annotations') {
                // 验证注解格式
                var annotations = description.split('\n').filter(function(a) { return a.trim(); });
                for (var i = 0; i < annotations.length; i++) {
                    var ann = annotations[i].trim();
                    if (!ann.startsWith('@')) {
                        alert('注解格式错误：第 ' + (i + 1) + ' 行 "' + ann + '" 不以 @ 开头\n\n正确格式示例：\n@Secured\n@AuditLog(action="USER_QUERY")');
                        return;
                    }
                    // 检查注解名称是否合法（字母开头，可包含字母数字下划线）
                    var annName = ann.substring(1).split('(')[0].trim();
                    if (!/^[A-Za-z][A-Za-z0-9_]*$/.test(annName)) {
                        alert('注解名称不合法：第 ' + (i + 1) + ' 行 "' + annName + '"\n\n注解名称必须以字母开头，只能包含字母、数字和下划线');
                        return;
                    }
                }
            } else if (fieldType === '参数' || fieldType === 'requestBody') {
                // 验证描述长度
                if (description.length < 2) {
                    alert('描述内容太短，请至少输入2个字符');
                    return;
                }
                if (description.length > 500) {
                    alert('描述内容太长，请限制在500字符以内');
                    return;
                }
            }

            // 获取当前 YAML 内容
            var yaml = yamlEditor.getValue();
            var lines = yaml.split('\n');
            var modified = false;

            // 解析 API 信息 (格式: "GET /api/v1/path")
            var apiMethod = '';
            var apiPath = '';
            if (issueApi) {
                var apiParts = issueApi.split(' ');
                if (apiParts.length >= 2) {
                    apiMethod = apiParts[0];
                    apiPath = apiParts[1];
                }
            }

            // 尝试找到对应位置并添加 description
            if (fieldType === 'annotations') {
                // 处理 x-java-class-annotations 编辑
                // 从 issueApi 中提取路径
                if (apiPath) {
                    for (var i = 0; i < lines.length; i++) {
                        if (lines[i].trim() === apiPath + ':') {
                            // 找到路径，检查是否已有 x-java-class-annotations
                            var baseIndent = lines[i].match(/^\s*/)[0];
                            var j = i + 1;
                            var foundAnnotations = false;

                            while (j < lines.length) {
                                var nextLine = lines[j];
                                var lineIndent = nextLine.match(/^\s*/)[0];

                                // 如果遇到同级或更高级别的元素，停止
                                if (nextLine.trim() && lineIndent.length <= baseIndent.length) {
                                    break;
                                }

                                if (nextLine.includes('x-java-class-annotations:')) {
                                    // 更新现有注解
                                    // 找到注解列表的结束位置
                                    var annotationsIndent = lineIndent + '  ';
                                    var k = j + 1;
                                    var newLines = [];
                                    var annotations = description.split('\n').filter(function(a) { return a.trim(); });
                                    annotations.forEach(function(ann) {
                                        newLines.push(annotationsIndent + '- "' + ann.trim() + '"');
                                    });

                                    // 删除旧的注解行
                                    while (k < lines.length && (lines[k].match(/^\s*- "/) || lines[k].trim() === '')) {
                                        var kIndent = lines[k].match(/^\s*/)[0];
                                        if (kIndent.length <= lineIndent.length) break;
                                        lines.splice(k, 1);
                                    }

                                    // 插入新的注解行
                                    var insertIdx = j + 1;
                                    for (var m = newLines.length - 1; m >= 0; m--) {
                                        lines.splice(insertIdx, 0, newLines[m]);
                                    }

                                    foundAnnotations = true;
                                    modified = true;
                                    break;
                                }
                                j++;
                            }

                            if (!foundAnnotations) {
                                // 添加新的 x-java-class-annotations
                                var annotationsIndent = baseIndent + '  ';
                                var newLines = [annotationsIndent + 'x-java-class-annotations:'];
                                var annotations = description.split('\n').filter(function(a) { return a.trim(); });
                                annotations.forEach(function(ann) {
                                    newLines.push(annotationsIndent + '  - "' + ann.trim() + '"');
                                });

                                for (var m = newLines.length - 1; m >= 0; m--) {
                                    lines.splice(i + 1, 0, newLines[m]);
                                }
                                modified = true;
                            }
                            break;
                        }
                    }
                }
            } else if (fieldType === 'requestBody') {
                // 找到 requestBody 所在位置 - 需要根据 API 路径定位
                // 首先从 YAML 中获取 basePath
                var basePath = '';
                for (var bi = 0; bi < lines.length; bi++) {
                    if (lines[bi].trim().startsWith('basePath:')) {
                        var basePathMatch = lines[bi].match(/basePath:\s*(['"]?)([^'"\s]+)\1/);
                        if (basePathMatch) {
                            basePath = basePathMatch[2];
                        }
                        break;
                    }
                }

                // 从 apiPath 中移除 basePath 前缀
                var actualPath = apiPath;
                if (basePath && apiPath && apiPath.startsWith(basePath)) {
                    actualPath = apiPath.substring(basePath.length);
                }

                // 首先找到目标 API 路径
                if (actualPath) {
                    for (var i = 0; i < lines.length; i++) {
                        if (lines[i].trim() === actualPath + ':') {
                            // 找到路径，现在查找对应的方法
                            var pathIndent = lines[i].match(/^\s*/)[0];
                            var j = i + 1;

                            while (j < lines.length) {
                                var methodLine = lines[j];
                                var methodIndent = methodLine.match(/^\s*/)[0];

                                if (methodLine.trim() && methodIndent.length <= pathIndent.length) {
                                    break;
                                }

                                if (methodLine.trim() === apiMethod.toLowerCase() + ':') {
                                    // 找到方法，查找 requestBody
                                    var k = j + 1;
                                    while (k < lines.length) {
                                        var rbLine = lines[k];
                                        var rbIndent = rbLine.match(/^\s*/)[0];

                                        if (rbLine.trim() && rbIndent.length <= methodIndent.length) {
                                            break;
                                        }

                                        if (rbLine.includes('requestBody:')) {
                                            var baseIndent = rbLine.match(/^\s*/)[0];
                                            var descIndent = baseIndent + '  ';

                                            var m = k + 1;
                                            var foundDesc = false;

                                            while (m < lines.length) {
                                                var nextLine = lines[m];
                                                var lineIndent = nextLine.match(/^\s*/)[0];

                                                if (nextLine.trim() && lineIndent.length <= baseIndent.length) {
                                                    break;
                                                }
                                                if (lineIndent === descIndent && nextLine.trim().startsWith('description:')) {
                                                    lines[m] = descIndent + 'description: ' + description;
                                                    foundDesc = true;
                                                    modified = true;
                                                    break;
                                                }
                                                m++;
                                            }

                                            if (!foundDesc) {
                                                lines.splice(k + 1, 0, descIndent + 'description: ' + description);
                                                modified = true;
                                            }
                                            break;
                                        }
                                        k++;
                                    }
                                    break;
                                }
                                j++;
                            }
                            break;
                        }
                    }
                }

                // 如果根据 API 定位失败，回退到简单查找
                if (!modified) {
                    for (var i = 0; i < lines.length; i++) {
                        if (lines[i].includes('requestBody:')) {
                            var baseIndent = lines[i].match(/^\s*/)[0];
                            var descIndent = baseIndent + '  ';

                            var j = i + 1;
                            var foundDesc = false;

                            while (j < lines.length) {
                                var nextLine = lines[j];
                                var lineIndent = nextLine.match(/^\s*/)[0];

                                if (nextLine.trim() && lineIndent.length <= baseIndent.length) {
                                    break;
                                }
                                if (lineIndent === descIndent && nextLine.trim().startsWith('description:')) {
                                    lines[j] = descIndent + 'description: ' + description;
                                    foundDesc = true;
                                    modified = true;
                                    break;
                                }
                                j++;
                            }

                            if (!foundDesc) {
                                lines.splice(i + 1, 0, descIndent + 'description: ' + description);
                                modified = true;
                            }
                            break;
                        }
                    }
                }
            } else {
                // 找到参数位置 - 需要根据 API 路径和方法定位正确的参数
                var foundParam = false;

                // 首先从 YAML 中获取 basePath
                var basePath = '';
                for (var bi = 0; bi < lines.length; bi++) {
                    if (lines[bi].trim().startsWith('basePath:')) {
                        var basePathMatch = lines[bi].match(/basePath:\s*(['"]?)([^'"\s]+)\1/);
                        if (basePathMatch) {
                            basePath = basePathMatch[2];
                        }
                        break;
                    }
                }

                // 从 apiPath 中移除 basePath 前缀
                var actualPath = apiPath;
                if (basePath && apiPath && apiPath.startsWith(basePath)) {
                    actualPath = apiPath.substring(basePath.length);
                }

                // 首先找到目标 API 路径
                if (actualPath) {
                    for (var i = 0; i < lines.length; i++) {
                        if (lines[i].trim() === actualPath + ':') {
                            // 找到路径，现在查找对应的方法和参数
                            var pathIndent = lines[i].match(/^\s*/)[0];
                            var j = i + 1;

                            // 查找方法块
                            while (j < lines.length) {
                                var methodLine = lines[j];
                                var methodIndent = methodLine.match(/^\s*/)[0];

                                // 如果遇到同级或更高级别的元素，停止
                                if (methodLine.trim() && methodIndent.length <= pathIndent.length) {
                                    break;
                                }

                                // 检查是否是目标方法
                                if (methodLine.trim() === apiMethod.toLowerCase() + ':') {
                                    // 找到方法，查找 parameters 块
                                    var k = j + 1;
                                    while (k < lines.length) {
                                        var paramLine = lines[k];
                                        var paramIndent = paramLine.match(/^\s*/)[0];

                                        // 如果遇到同级或更高级别的元素，停止
                                        if (paramLine.trim() && paramIndent.length <= methodIndent.length) {
                                            break;
                                        }

                                        // 检查是否是目标参数
                                        if (paramLine.match(/^\s*- name:\s*/) && paramLine.includes(fieldName)) {
                                            // 找到参数，添加或更新 description
                                            var currentIndent = paramLine.match(/^\s*/)[0];
                                            var descIndent = currentIndent.replace(/- /, '') + '  ';

                                            // 检查后续行是否已有 description
                                            var m = k + 1;
                                            var foundDesc = false;
                                            while (m < lines.length) {
                                                var nextLine = lines[m];
                                                if (nextLine.match(/^\s*- name:/) ||
                                                    (nextLine.trim() && nextLine.match(new RegExp('^.{0,' + currentIndent.length + '}\\S')))) {
                                                    break;
                                                }
                                                if (nextLine.includes('description:')) {
                                                    var existingIndent = nextLine.match(/^\s*/)[0];
                                                    lines[m] = existingIndent + 'description: ' + description;
                                                    foundDesc = true;
                                                    modified = true;
                                                    break;
                                                }
                                                m++;
                                            }

                                            if (!foundDesc) {
                                                lines.splice(k + 1, 0, descIndent + 'description: ' + description);
                                                modified = true;
                                            }
                                            foundParam = true;
                                            break;
                                        }
                                        k++;
                                    }
                                    break;
                                }
                                j++;
                            }
                            break;
                        }
                    }
                }

                // 如果根据 API 定位失败，回退到简单查找
                if (!foundParam) {
                    for (var i = 0; i < lines.length; i++) {
                        var line = lines[i];

                        if (line.match(/^\s*- name:\s*/) && line.includes(fieldName)) {
                            var currentIndent = line.match(/^\s*/)[0];
                            var descIndent = currentIndent.replace(/- /, '') + '  ';

                            var j = i + 1;
                            var foundDesc = false;
                            while (j < lines.length) {
                                var nextLine = lines[j];
                                if (nextLine.match(/^\s*- name:/) ||
                                    (nextLine.trim() && nextLine.match(new RegExp('^.{0,' + currentIndent.length + '}\\S')))) {
                                    break;
                                }
                                if (nextLine.includes('description:')) {
                                    var existingIndent = nextLine.match(/^\s*/)[0];
                                    lines[j] = existingIndent + 'description: ' + description;
                                    foundDesc = true;
                                    modified = true;
                                    break;
                                }
                                j++;
                            }

                            if (!foundDesc) {
                                lines.splice(i + 1, 0, descIndent + 'description: ' + description);
                                modified = true;
                            }
                            break;
                        }
                    }
                }
            }

            if (modified) {
                yamlEditor.setValue(lines.join('\n'));
                closeEditModal();
                setMessage('已添加描述，请点击"分析"重新检查');
            } else {
                alert('未能找到对应位置，请手动编辑 YAML 文件');
                closeEditModal();
            }
        }

        /**
         * 关闭编辑弹窗
         */
        function closeEditModal(event) {
            if (event && event.target !== event.currentTarget) return;
            var container = document.getElementById('edit-modal-container');
            if (container) {
                container.remove();
            }
        }

        /**
         * 跳转到 YAML 中的对应位置
         */
        function jumpToYamlLocation(issue) {
            var yaml = yamlEditor.getValue();
            var lines = yaml.split('\n');
            var msg = issue.message || '';

            // 处理 x-java-class-annotations 不一致的情况
            if (msg.includes('x-java-class-annotations') || msg.includes('注解') || msg.includes('annotations')) {
                // 从 message 中提取路径
                var pathMatch = msg.match(/路径\s+(\/[^\s]+)\s+下/);
                if (pathMatch) {
                    var targetPath = pathMatch[1];
                    for (var i = 0; i < lines.length; i++) {
                        if (lines[i].trim() === targetPath + ':') {
                            yamlEditor.setCursor(i, 0);
                            yamlEditor.scrollIntoView(null, 100);
                            yamlEditor.focus();
                            setMessage('已跳转到路径 ' + targetPath + '，行 ' + (i + 1));
                            return;
                        }
                    }
                }
            }

            if (!issue.field) {
                // 尝试从 message 中提取路径
                var pathMatch = msg.match(/API:\s*(\w+)\s+(\/[^\s]+)/);
                if (pathMatch) {
                    var method = pathMatch[1];
                    var path = pathMatch[2];
                    for (var i = 0; i < lines.length; i++) {
                        if (lines[i].trim() === path + ':') {
                            yamlEditor.setCursor(i, 0);
                            yamlEditor.scrollIntoView(null, 100);
                            yamlEditor.focus();
                            setMessage('已跳转到路径 ' + path + '，行 ' + (i + 1));
                            return;
                        }
                    }
                }
                setMessage('无法定位到具体位置，请手动查找');
                return;
            }

            // 根据 issue.field 查找对应行
            // field 格式可能是: "GET /api/path parameters[0]" 或 "path.method.requestBody.field"
            var searchTerm = '';

            if (issue.field.includes('parameters[')) {
                // 提取参数索引
                var match = issue.field.match(/parameters\[(\d+)\]/);
                if (match) {
                    var paramIndex = parseInt(match[1]);
                    var currentParamIndex = -1;
                    for (var i = 0; i < lines.length; i++) {
                        if (lines[i].match(/^\s*- name:/)) {
                            currentParamIndex++;
                            if (currentParamIndex === paramIndex) {
                                yamlEditor.setCursor(i, 0);
                                yamlEditor.scrollIntoView(null, 100);
                                yamlEditor.focus();
                                setMessage('已跳转到参数位置');
                                return;
                            }
                        }
                    }
                }
            }

            // 尝试从 message 中提取字段名
            var fieldMatch = issue.message.match(/参数 (\w+) /);
            if (fieldMatch) {
                searchTerm = fieldMatch[1];
                for (var i = 0; i < lines.length; i++) {
                    if (lines[i].includes('name: ' + searchTerm) || lines[i].includes(searchTerm + ':')) {
                        yamlEditor.setCursor(i, 0);
                        yamlEditor.scrollIntoView(null, 100);
                        yamlEditor.focus();
                        setMessage('已跳转到位置，行 ' + (i + 1));
                        return;
                    }
                }
            }

            setMessage('无法定位到具体位置，请手动查找');
        }

        /**
         * 判断问题是否可以自动修复
         */
        function isAutoFixable(issue) {
            var msg = issue.message || '';

            // 不能自动修复的问题类型
            var unfixablePatterns = [
                '缺少 description',           // 需要用户编写描述
                'x-java-class-annotations',   // 需要用户决定配置
                'annotations',                // 需要用户决定配置
                '不一致'                      // 需要用户决定配置
            ];
            // 注意：minLength > maxLength 和 minimum > maximum 可以自动修复（交换值）

            for (var i = 0; i < unfixablePatterns.length; i++) {
                if (msg.includes(unfixablePatterns[i])) {
                    return false;
                }
            }

            // 其他问题都可以自动修复
            return true;
        }

        function toggleIssue(index, checked) {
            selectedIssues[index] = checked;
            updateIssueCount();
        }

        function toggleAllIssues(checked) {
            var checkboxes = document.querySelectorAll('#issue-list input[type="checkbox"]:not(#select-all-issues)');
            checkboxes.forEach(function(cb, i) {
                cb.checked = checked;
                selectedIssues[i] = checked;
            });
            updateIssueCount();
        }

        function updateIssueCount() {
            var total = Object.keys(selectedIssues).length;
            var selected = Object.values(selectedIssues).filter(function(v) { return v; }).length;
            var countEl = document.getElementById('issue-count');
            countEl.textContent = selected + '/' + total;
        }

        function autoFix() {
            try {
                // 使用原始内容作为对比基础，先去掉注释
                var rawContent = originalYaml || yamlEditor.getValue();
                var content = stripYamlComments(rawContent);
                var analyzer = new ApiYamlAnalyzer();

                // Get selected issues and compute selective fix
                var issues = window.currentIssues || [];
                var selectedIndices = Object.keys(selectedIssues).filter(function(i) { return selectedIssues[i]; }).map(function(i) { return parseInt(i); });

                // 如果没有选中任何问题，默认选择所有可修复的问题（非"需手动"）
                if (selectedIndices.length === 0) {
                    issues.forEach(function(issue, i) {
                        // 选择所有非"需手动"的问题（包括 error、warn、info）
                        if (!issue.message.includes('需手动')) {
                            selectedIndices.push(i);
                        }
                    });
                }

                var fixed = analyzer.fixSelective(content, selectedIndices);

                // 获取修复统计
                var fixStats = analyzer.fixStats || { paramsFixed: 0 };
                window.currentFixStats = fixStats;

                // Show diff preview - 使用去掉注释后的内容作为修复前
                showDiffPreview(content, fixed);
                setMessage('点击"应用修复"确认更改');
            } catch (e) {
                console.error('AutoFix error:', e);
                setMessage('自动修复出错: ' + e.message);
            }
        }

        /**
         * 生成 API 的 YAML 片段（包含完整参数信息）
         */
        function generateApiYaml(method, api) {
            var yaml = method + ':\n';
            if (api.summary) yaml += '  summary: ' + api.summary + '\n';
            if (api.description) yaml += '  description: ' + api.description + '\n';
            if (api.operationId) yaml += '  operationId: ' + api.operationId + '\n';

            if (api.parameters && api.parameters.length > 0) {
                yaml += '  parameters:\n';
                api.parameters.forEach(function(p) {
                    yaml += '    - name: ' + p.name + '\n';
                    if (p.in) yaml += '      in: ' + p.in + '\n';
                    if (p.required !== undefined) yaml += '      required: ' + p.required + '\n';
                    if (p.description) yaml += '      description: ' + p.description + '\n';

                    if (p.schema) {
                        yaml += '      schema:\n';
                        if (p.schema.type) yaml += '        type: ' + p.schema.type + '\n';
                        if (p.schema.format) yaml += '        format: ' + p.schema.format + '\n';
                        if (p.schema.minimum !== undefined) yaml += '        minimum: ' + p.schema.minimum + '\n';
                        if (p.schema.maximum !== undefined) yaml += '        maximum: ' + p.schema.maximum + '\n';
                        if (p.schema.minLength !== undefined) yaml += '        minLength: ' + p.schema.minLength + '\n';
                        if (p.schema.maxLength !== undefined) yaml += '        maxLength: ' + p.schema.maxLength + '\n';
                        if (p.schema.pattern) yaml += '        pattern: ' + p.schema.pattern + '\n';
                    }
                });
            }

            return yaml;
        }

        /**
         * 生成 Java 代码预览（Controller 方法）- 格式化清晰
         */
        function generateJavaCode(path, method, api) {
            if (!api) return '';

            var javaCode = '';
            var operationId = api.operationId || 'operation';
            var summary = api.summary || '';
            var parameters = api.parameters || [];

            // 生成注释
            javaCode += '/**\n';
            javaCode += ' * ' + (summary || operationId) + '\n';
            javaCode += ' */\n';

            // 生成 @Path 注解
            javaCode += '@' + method.toUpperCase() + '("' + path + '")\n';

            // 收集方法参数
            var methodParams = [];
            var paramLines = [];

            parameters.forEach(function(p) {
                var paramType = mapSchemaTypeToJava(p.schema);
                var paramName = p.name;
                var annotations = [];

                // 位置注解
                if (p.in === 'path') {
                    annotations.push('@PathParam("' + paramName + '")');
                } else if (p.in === 'query') {
                    annotations.push('@QueryParam("' + paramName + '")');
                } else if (p.in === 'header') {
                    annotations.push('@HeaderParam("' + paramName + '")');
                } else if (p.in === 'body') {
                    annotations.push('@RequestBody');
                }

                // 校验注解
                if (p.required) {
                    if (paramType === 'String') {
                        annotations.push('@NotBlank');
                    } else {
                        annotations.push('@NotNull');
                    }
                }

                if (p.schema) {
                    if (p.schema.minLength !== undefined || p.schema.maxLength !== undefined) {
                        var min = p.schema.minLength || 0;
                        var max = p.schema.maxLength || 255;
                        annotations.push('@Size(min = ' + min + ', max = ' + max + ')');
                    }
                    if (p.schema.minimum !== undefined || p.schema.maximum !== undefined) {
                        var minVal = p.schema.minimum || 0;
                        var maxVal = p.schema.maximum || 2147483647;
                        annotations.push('@Range(min = ' + minVal + ', max = ' + maxVal + ')');
                    }
                    if (p.schema.pattern) {
                        annotations.push('@Pattern(regexp = "' + p.schema.pattern + '")');
                    }
                    if (p.schema.format === 'email' || (p.name && p.name.toLowerCase().includes('email'))) {
                        annotations.push('@Email');
                    }
                }

                // 生成参数行
                var paramLine = '        ' + annotations.join(' ') + ' ' + paramType + ' ' + paramName;
                paramLines.push(paramLine);
                methodParams.push(paramType + ' ' + paramName);
            });

            // 生成方法签名
            if (paramLines.length > 0) {
                javaCode += 'public Response ' + operationId + '(\n';
                javaCode += paramLines.join(',\n');
                javaCode += '\n    ) {\n';
            } else {
                javaCode += 'public Response ' + operationId + '() {\n';
            }

            javaCode += '        // TODO: 实现业务逻辑\n';
            javaCode += '        return Response.ok().build();\n';
            javaCode += '    }\n';

            return javaCode;
        }

        /**
         * 映射 Schema 类型到 Java 类型
         */
        function mapSchemaTypeToJava(schema) {
            if (!schema) return 'String';
            var type = schema.type || 'string';
            var format = schema.format || '';

            switch (type) {
                case 'string':
                    if (format === 'date') return 'LocalDate';
                    if (format === 'date-time') return 'LocalDateTime';
                    return 'String';
                case 'integer':
                    if (format === 'int64') return 'Long';
                    return 'Integer';
                case 'number':
                    if (format === 'float') return 'Float';
                    if (format === 'double') return 'Double';
                    return 'Double';
                case 'boolean':
                    return 'Boolean';
                case 'array':
                    var itemType = schema.items ? mapSchemaTypeToJava(schema.items) : 'String';
                    return 'List<' + itemType + '>';
                default:
                    return 'String';
            }
        }

        /**
         * Show diff preview modal - 统一视图显示 Java 代码风格对比
         */
        function showDiffPreview(before, after) {
            try {
                // 解析YAML获取API列表
                var beforeParsed, afterParsed;
                try {
                    beforeParsed = jsyaml.load(before);
                    afterParsed = jsyaml.load(after);
                } catch (e) {
                    console.error('YAML parse error in showDiffPreview:', e);
                    beforeParsed = null;
                    afterParsed = null;
                }

            // 路径标准化函数 - 用于匹配修复前后的路径
            function normalizePath(path) {
                if (!path) return path;
                // 删除重复斜杠
                var normalized = path.replace(/\/+/g, '/');
                // 删除 /XXX/ 前缀（占位符路径）
                normalized = normalized.replace(/^\/[A-Z][A-Z0-9_]*\//, '/');
                // 确保以 / 开头
                if (!normalized.startsWith('/')) {
                    normalized = '/' + normalized;
                }
                return normalized;
            }

            // 构建标准化路径映射
            var normalizedBeforePaths = {};
            if (beforeParsed && beforeParsed.paths) {
                for (var origPath in beforeParsed.paths) {
                    var np = normalizePath(origPath);
                    normalizedBeforePaths[np] = origPath;
                }
            }

            var normalizedAfterPaths = {};
            if (afterParsed && afterParsed.paths) {
                for (var origPath in afterParsed.paths) {
                    var np = normalizePath(origPath);
                    normalizedAfterPaths[np] = origPath;
                }
            }

            // 获取所有标准化路径
            var allNormalizedPaths = new Set([
                ...Object.keys(normalizedBeforePaths),
                ...Object.keys(normalizedAfterPaths)
            ]);

            // 获取所有API路径（使用标准化路径匹配）
            var apis = [];
            allNormalizedPaths.forEach(function(np) {
                var beforeOrigPath = normalizedBeforePaths[np];
                var afterOrigPath = normalizedAfterPaths[np];
                var beforeMethods = beforeOrigPath ? beforeParsed.paths[beforeOrigPath] : {};
                var afterMethods = afterOrigPath ? afterParsed.paths[afterOrigPath] : {};

                // 获取所有方法
                var allMethods = new Set([
                    ...Object.keys(beforeMethods || {}),
                    ...Object.keys(afterMethods || {})
                ]);

                allMethods.forEach(function(method) {
                    // 过滤掉 x- 开头的扩展字段（如 x-java-class-annotations）
                    if (method.startsWith('x-')) return;
                    // 过滤掉非 HTTP 方法
                    var httpMethods = ['get', 'post', 'put', 'delete', 'patch', 'options', 'head'];
                    if (!httpMethods.includes(method.toLowerCase())) return;

                    apis.push({
                        normalizedPath: np,
                        beforePath: beforeOrigPath,
                        afterPath: afterOrigPath,
                        method: method.toUpperCase(),
                        before: beforeMethods ? (beforeMethods[method] || null) : null,
                        after: afterMethods ? (afterMethods[method] || null) : null
                    });
                });
            });

            // 如果没有API或解析失败，回退到简单对比
            if (apis.length === 0) {
                var diff = Diff.diffLines(before, after);
                var unifiedHtml = '<div class="diff-api-unified"><div class="diff-api-code-section">';
                unifiedHtml += '<div class="diff-code-block">' + renderUnifiedDiff(before, after, diff) + '</div>';
                unifiedHtml += '</div></div>';
                document.getElementById('diff-unified').innerHTML = unifiedHtml;

                var addCount = 0, removeCount = 0;
                diff.forEach(function(part) {
                    var lines = (part.value.match(/\n/g) || []).length || 1;
                    if (part.added) addCount += lines;
                    if (part.removed) removeCount += lines;
                });
                document.getElementById('diff-adds').textContent = '+' + addCount + ' 行';
                document.getElementById('diff-removes').textContent = '-' + removeCount + ' 行';
            } else {
                // 统一视图渲染 - 只显示有变化的 API
                var unifiedHtml = '';
                var changeCount = 0;

                apis.forEach(function(api, index) {
                    var method = api.method;
                    var beforePath = api.beforePath || '';
                    var afterPath = api.afterPath || '';

                    // 生成该API的 Java 代码
                    var beforeJava = api.before ? generateJavaCode(beforePath, method, api.before) : '';
                    var afterJava = api.after ? generateJavaCode(afterPath, method, api.after) : '';

                    // 判断是否有变化
                    var changeType = '';
                    var hasChange = false;
                    if (api.before && !api.after) {
                        changeType = 'removed';
                        hasChange = true;
                    } else if (!api.before && api.after) {
                        changeType = 'added';
                        hasChange = true;
                    } else if (beforePath !== afterPath) {
                        changeType = 'path-fixed';
                        hasChange = true;
                    } else {
                        var beforeStr = JSON.stringify(api.before);
                        var afterStr = JSON.stringify(api.after);
                        if (beforeStr !== afterStr) {
                            changeType = 'modified';
                            hasChange = true;
                        }
                    }

                    // 只显示有变化的 API
                    if (!hasChange) return;
                    changeCount++;

                    // 开始渲染统一块
                    unifiedHtml += '<div class="diff-api-unified">';

                    // 头部：显示方法和路径变化
                    unifiedHtml += '<div class="diff-api-unified-header">';
                    unifiedHtml += '<span class="diff-api-unified-badge ' + method.toLowerCase() + '">' + method + '</span>';

                    if (changeType === 'path-fixed') {
                        unifiedHtml += '<span class="diff-api-path-before">' + escapeHtml(beforePath) + '</span>';
                        unifiedHtml += '<span class="diff-api-path-arrow">→</span>';
                        unifiedHtml += '<span class="diff-api-path-after">' + escapeHtml(afterPath) + '</span>';
                        unifiedHtml += '<span class="diff-api-change-type path-fixed">路径修复</span>';
                    } else {
                        unifiedHtml += '<span class="diff-api-path-unchanged">' + escapeHtml(afterPath || beforePath) + '</span>';
                        if (changeType === 'added') {
                            unifiedHtml += '<span class="diff-api-change-type added">新增</span>';
                        } else if (changeType === 'removed') {
                            unifiedHtml += '<span class="diff-api-change-type removed">已删除</span>';
                        } else if (changeType === 'modified') {
                            unifiedHtml += '<span class="diff-api-change-type modified">参数修改</span>';
                        }
                    }
                    unifiedHtml += '</div>';

                    // 行级 diff 视图
                    unifiedHtml += '<div class="diff-line-by-line">';

                    if (changeType === 'path-fixed') {
                        // 路径修复：只显示修复后的代码
                        unifiedHtml += '<div class="diff-code-block add">';
                        unifiedHtml += renderLineByLineDiff('', afterJava);
                        unifiedHtml += '</div>';
                    } else {
                        // 其他修改：显示行级对比
                        unifiedHtml += renderLineByLineDiff(beforeJava, afterJava);
                    }

                    unifiedHtml += '</div>';
                    unifiedHtml += '</div>';
                });

                // 如果没有变化
                if (changeCount === 0) {
                    unifiedHtml = '<div class="diff-no-changes"><div class="diff-no-changes-icon">✓</div><div class="diff-no-changes-text">没有需要修复的问题</div></div>';
                }

                // 渲染到统一容器
                document.getElementById('diff-unified').innerHTML = unifiedHtml;

                // 统计变化数量
                var addCount = 0, removeCount = 0, modifyCount = 0;
                apis.forEach(function(api) {
                    if (api.before && !api.after) {
                        removeCount++;
                    } else if (!api.before && api.after) {
                        addCount++;
                    } else if (api.before && api.after) {
                        var beforeStr = JSON.stringify(api.before);
                        var afterStr = JSON.stringify(api.after);
                        if (beforeStr !== afterStr || api.beforePath !== api.afterPath) {
                            modifyCount++;
                        }
                    }
                });

                // 显示修复统计 - 优先显示实际修复的参数数量
                var fixStats = window.currentFixStats || {};
                if (fixStats.paramsFixed > 0) {
                    document.getElementById('diff-adds').textContent = fixStats.paramsFixed + ' 个参数已修复';
                } else {
                    document.getElementById('diff-adds').textContent = modifyCount + ' 处修改';
                }
                document.getElementById('diff-removes').textContent = removeCount + ' 处删除';
            }

            window.pendingFixedContent = after;
            setupScrollSync();
            document.getElementById('diff-modal').classList.add('active');
            } catch (e) {
                console.error('showDiffPreview error:', e);
                setMessage('显示预览出错: ' + e.message);
            }
        }

        // 简单渲染：显示所有行，变化的标颜色
        function renderSimpleDiff(content, diff, type) {
            var lines = content.split('\n');
            var html = '';
            var lineNum = 1;

            // 构建行号到变化类型的映射
            var lineChangeMap = {};
            var currentLine = 0;

            diff.forEach(function(part) {
                var partLines = part.value.split('\n');
                partLines.forEach(function(line, i) {
                    // 跳过空字符串（diffSplit会产生最后的空字符串）
                    if (i < partLines.length - 1 || line) {
                        if (part.added) {
                            lineChangeMap[currentLine] = 'add';
                        } else if (part.removed) {
                            lineChangeMap[currentLine] = 'remove';
                        }
                        currentLine++;
                    }
                });
            });

            // 渲染每一行
            for (var i = 0; i < lines.length; i++) {
                var state = lineChangeMap[i] || '';
                var bg = '';
                var color = '';

                if (type === 'add' && state === 'add') {
                    bg = 'background: rgba(46, 213, 115, 0.15);';
                    color = 'color: #2ed573;';
                }
                if (type === 'remove' && state === 'remove') {
                    bg = 'background: rgba(255, 71, 87, 0.15);';
                    color = 'color: #ff4757;';
                }

                html += '<div class="diff-line" style="' + bg + '">';
                html += '<div class="diff-line-num" style="color: #5c5f66;">' + lineNum + '</div>';
                html += '<div class="diff-line-content" style="' + color + '">' + escapeHtml(lines[i]) + '</div>';
                html += '</div>';
                lineNum++;
            }
            return html;
        }

        /**
         * 渲染 Java 代码 diff（带语法高亮）
         */
        function renderJavaDiff(content, diff, type) {
            var lines = content.split('\n');
            var html = '';
            var lineNum = 1;

            // 构建行号到变化类型的映射
            var lineChangeMap = {};
            var currentLine = 0;

            diff.forEach(function(part) {
                var partLines = part.value.split('\n');
                partLines.forEach(function(line, i) {
                    if (i < partLines.length - 1 || line) {
                        if (part.added) {
                            lineChangeMap[currentLine] = 'add';
                        } else if (part.removed) {
                            lineChangeMap[currentLine] = 'remove';
                        }
                        currentLine++;
                    }
                });
            });

            // 渲染每一行
            for (var i = 0; i < lines.length; i++) {
                var state = lineChangeMap[i] || '';
                var bg = '';
                var prefix = '';

                if (type === 'add' && state === 'add') {
                    bg = 'background: rgba(46, 213, 115, 0.15);';
                    prefix = '+';
                }
                if (type === 'remove' && state === 'remove') {
                    bg = 'background: rgba(255, 71, 87, 0.15);';
                    prefix = '-';
                }

                // Java 语法高亮
                var highlightedLine = highlightJavaSyntax(lines[i]);

                html += '<div class="diff-line diff-java-line" style="' + bg + '">';
                html += '<div class="diff-line-prefix" style="color: #5c5f66; width: 20px; text-align: center;">' + prefix + '</div>';
                html += '<div class="diff-line-num" style="color: #5c5f66;">' + lineNum + '</div>';
                html += '<div class="diff-line-content">' + highlightedLine + '</div>';
                html += '</div>';
                lineNum++;
            }
            return html;
        }

        /**
         * Java 语法高亮
         */
        function highlightJavaSyntax(line) {
            var escaped = escapeHtml(line);

            // 关键字
            var keywords = ['public', 'private', 'protected', 'class', 'interface', 'extends', 'implements',
                           'void', 'return', 'if', 'else', 'for', 'while', 'do', 'switch', 'case', 'break',
                           'continue', 'try', 'catch', 'finally', 'throw', 'throws', 'new', 'this', 'super',
                           'static', 'final', 'abstract', 'synchronized', 'volatile', 'transient', 'native',
                           'import', 'package', 'true', 'false', 'null', 'instanceof'];
            keywords.forEach(function(kw) {
                var regex = new RegExp('\\b(' + kw + ')\\b', 'g');
                escaped = escaped.replace(regex, '<span style="color: #ff79c6;">$1</span>');
            });

            // 类型
            var types = ['String', 'Integer', 'Long', 'Double', 'Float', 'Boolean', 'Byte', 'Short', 'Character',
                        'List', 'Map', 'Set', 'ArrayList', 'HashMap', 'HashSet', 'Response', 'LocalDate', 'LocalDateTime',
                        'Object', 'Class'];
            types.forEach(function(t) {
                var regex = new RegExp('\\b(' + t + ')\\b', 'g');
                escaped = escaped.replace(regex, '<span style="color: #8be9fd;">$1</span>');
            });

            // 注解
            escaped = escaped.replace(/(@\w+)/g, '<span style="color: #ffb86c;">$1</span>');

            // 字符串
            escaped = escaped.replace(/(&quot;[^&]*&quot;)/g, '<span style="color: #f1fa8c;">$1</span>');

            // 注释
            escaped = escaped.replace(/(\/\/.*)$/g, '<span style="color: #6272a4;">$1</span>');

            // 数字
            escaped = escaped.replace(/\b(\d+)\b/g, '<span style="color: #bd93f9;">$1</span>');

            return escaped;
        }

        /**
         * 行级 diff 渲染 - 显示变化的行
         */
        function renderLineByLineDiff(beforeCode, afterCode) {
            var html = '';

            // 使用 diff 库比较
            var diff = Diff.diffLines(beforeCode || '', afterCode || '');

            diff.forEach(function(part) {
                var lines = part.value.split('\n');
                // 移除最后的空字符串
                if (lines.length > 0 && lines[lines.length - 1] === '') {
                    lines.pop();
                }

                lines.forEach(function(line) {
                    if (part.added) {
                        // 新增的行
                        html += '<div class="diff-line-added">';
                        html += '<span class="diff-line-marker">+</span>';
                        html += '<span class="diff-line-code">' + highlightJavaSyntax(line) + '</span>';
                        html += '</div>';
                    } else if (part.removed) {
                        // 删除的行
                        html += '<div class="diff-line-removed">';
                        html += '<span class="diff-line-marker">-</span>';
                        html += '<span class="diff-line-code">' + highlightJavaSyntax(line) + '</span>';
                        html += '</div>';
                    } else {
                        // 未变化的行 - 只显示上下文
                        // 为了简洁，这里不显示未变化的行
                    }
                });
            });

            return html || '<div class="diff-no-change">（无变化）</div>';
        }

        // 生成参数对比表格
        function renderParamDiffTable(beforeParams, afterParams) {
            if (!beforeParams && !afterParams) return '';

            var beforeMap = {};
            var afterMap = {};

            if (beforeParams) {
                beforeParams.forEach(function(p) { beforeMap[p.name] = p; });
            }
            if (afterParams) {
                afterParams.forEach(function(p) { afterMap[p.name] = p; });
            }

            var allNames = new Set([...Object.keys(beforeMap), ...Object.keys(afterMap)]);
            var rows = [];

            allNames.forEach(function(name) {
                var before = beforeMap[name];
                var after = afterMap[name];
                var status = '';
                var statusText = '';

                if (before && !after) {
                    status = 'param-removed';
                    statusText = 'removed';
                } else if (!before && after) {
                    status = 'param-added';
                    statusText = 'added';
                } else if (before && after) {
                    // 检查是否有变化
                    var changed = false;
                    if (before.required !== after.required) changed = true;
                    if (JSON.stringify(before.schema) !== JSON.stringify(after.schema)) changed = true;
                    if (before.description !== after.description) changed = true;
                    if (changed) {
                        status = 'param-changed';
                        statusText = 'changed';
                    }
                }

                if (status || (!before && !after)) return;

                var row = '<tr class="' + status + '">';
                row += '<td class="param-name">' + escapeHtml(name) + '</td>';

                // Before values
                if (before) {
                    var reqBadge = before.required ? '<span class="param-badge required">必填</span>' : '<span class="param-badge optional">可选</span>';
                    row += '<td>' + reqBadge + (before.description ? escapeHtml(before.description) : '-') + '</td>';
                    row += '<td>' + (before.schema ? escapeHtml(before.schema.type || '-') : '-') + '</td>';
                    row += '<td>' + formatSchemaValidation(before.schema) + '</td>';
                } else {
                    row += '<td>-</td><td>-</td><td>-</td>';
                }

                // After values
                if (after) {
                    var reqBadge = after.required ? '<span class="param-badge required">必填</span>' : '<span class="param-badge optional">可选</span>';
                    row += '<td>' + reqBadge + (after.description ? escapeHtml(after.description) : '-') + '</td>';
                    row += '<td>' + (after.schema ? escapeHtml(after.schema.type || '-') : '-') + '</td>';
                    row += '<td>' + formatSchemaValidation(after.schema) + '</td>';
                } else {
                    row += '<td>-</td><td>-</td><td>-</td>';
                }

                row += '</tr>';
                rows.push(row);
            });

            if (rows.length === 0) return '';

            var html = '<table class="diff-param-table">';
            html += '<thead><tr>';
            html += '<th style="width:12%">参数</th>';
            html += '<th style="width:18%">描述</th>';
            html += '<th style="width:10%">类型</th>';
            html += '<th style="width:20%">校验规则</th>';
            html += '<th style="width:18%">描述</th>';
            html += '<th style="width:10%">类型</th>';
            html += '<th style="width:20%">校验规则</th>';
            html += '</tr></thead>';
            html += '<tbody>';
            html += '<tr style="background:#161b22;"><td colspan="4" style="text-align:center;color:#8b949e;font-weight:600;">修复前</td><td colspan="3" style="text-align:center;color:#8b949e;font-weight:600;">修复后</td></tr>';
            html += rows.join('');
            html += '</tbody></table>';
            return html;
        }

        // 格式化 schema 校验规则显示
        function formatSchemaValidation(schema) {
            if (!schema) return '-';
            var parts = [];
            if (schema.minimum !== undefined) parts.push('min=' + schema.minimum);
            if (schema.maximum !== undefined) parts.push('max=' + schema.maximum);
            if (schema.minLength !== undefined) parts.push('minLength=' + schema.minLength);
            if (schema.maxLength !== undefined) parts.push('maxLength=' + schema.maxLength);
            if (schema.pattern) parts.push('pattern=' + schema.pattern.substring(0, 20) + (schema.pattern.length > 20 ? '...' : ''));
            if (schema.minItems !== undefined) parts.push('minItems=' + schema.minItems);
            if (schema.maxItems !== undefined) parts.push('maxItems=' + schema.maxItems);
            return parts.length > 0 ? escapeHtml(parts.join(', ')) : '-';
        }

        // 从 YAML 中提取每个 API 的内容（暂时不用）
        function extractApis(yamlContent) {
            return {};
        }

        // 渲染单个 API 块的 diff（暂时不用）
        function renderApiBlockDiff(content, diff, type) {
            return '';
        }

        /**
         * Render API-level changes with before/after comparison
         * 左边(修复前)显示原始代码，右边(修复后)显示修复后代码
         */
        function renderApiChanges(impact) {
            var beforeContainer = document.getElementById('diff-api-before');
            var afterContainer = document.getElementById('diff-api-after');
            var countEl = document.getElementById('diff-api-count');

            if (!impact || !impact.apis || impact.apis.length === 0) {
                beforeContainer.innerHTML = '<div class="diff-field-empty">无接口变更</div>';
                afterContainer.innerHTML = '<div class="diff-field-empty">无接口变更</div>';
                countEl.textContent = '0';
                return;
            }

            var apis = impact.apis;
            countEl.textContent = apis.length;

            // 分别构建修复前和修复后的API块
            var beforeBlocksHtml = '';
            var afterBlocksHtml = '';

            apis.forEach(function(api, index) {
                var method = (api.method || 'get').toUpperCase();
                var fixedPath = api.path || '';
                var originalPath = api.originalPath || api.path || '';
                var apiName = api.name || api.summary || api.operationId || fixedPath.replace(/\//g, '').replace(/\{|\}/g, '') || 'api';
                var annotations = api.annotations || [];
                var params = api.parameters || [];
                var originalParams = api.originalParameters || api.parameters || [];

                // 生成Java代码
                var javaCode = generateJavaControllerCode(fixedPath, method, apiName, annotations, api.description, params);
                var originalJavaCode = generateJavaControllerCode(originalPath, method, apiName, annotations, api.description, originalParams);

                // 方法颜色
                var methodColor = method === 'GET' ? '#61affe' : method === 'POST' ? '#49cc90' : method === 'PUT' ? '#fca130' : method === 'DELETE' ? '#f93e3e' : '#9012fe';

                // 构建变更摘要
                var changesSummary = '';
                if (api.changes && api.changes.length > 0) {
                    var changeLines = [];
                    api.changes.forEach(function(change) {
                        if (change.prop === 'path') {
                            changeLines.push('路径: ' + escapeHtml(change.before) + ' → ' + escapeHtml(change.after));
                        } else if (change.prop.startsWith('参数 ')) {
                            var detail = change.prop.replace('参数 ', '');
                            if (change.before === '(无)') {
                                changeLines.push('+ ' + detail + ': ' + change.after);
                            } else {
                                changeLines.push(detail + ': ' + escapeHtml(change.before) + ' → ' + escapeHtml(change.after));
                            }
                        }
                    });
                    if (changeLines.length > 0) {
                        changesSummary = '<div class="diff-api-changes">' + changeLines.join('<br>') + '</div>';
                    }
                }

                // 块标题（公共部分）
                var blockHeader = '<div class="diff-api-block-header">' +
                    '<span class="diff-api-method" style="background:' + methodColor + '">' + method + '</span>' +
                    '<span class="diff-api-path">' + escapeHtml(fixedPath) + '</span>' +
                    '<span class="diff-api-type">' + (api.type === 'added' ? '(新增)' : api.type === 'deleted' ? '(删除)' : '(修改)') + '</span>' +
                    '</div>';

                if (api.type === 'added') {
                    // 新增的接口 - 只在右边显示
                    var afterBlock = '<div class="diff-api-block" id="after-api-block-' + index + '">' +
                        blockHeader +
                        '<div class="diff-api-block-content">' +
                        '<div class="diff-api-block-after" style="flex:1">' +
                        '<div class="diff-api-block-label" style="color:#2ed573">+ 新增</div>' +
                        '<pre class="diff-java-code">' + javaCode + '</pre>' +
                        '</div>' +
                        '</div></div>';
                    afterBlocksHtml += afterBlock;
                    // 左边为空或显示占位
                    beforeBlocksHtml += '';

                } else if (api.type === 'deleted') {
                    // 删除的接口 - 只在左边显示
                    var beforeBlock = '<div class="diff-api-block" id="before-api-block-' + index + '">' +
                        blockHeader +
                        '<div class="diff-api-block-content">' +
                        '<div class="diff-api-block-before" style="flex:1">' +
                        '<div class="diff-api-block-label" style="color:#ff4757">- 删除</div>' +
                        '<pre class="diff-java-code">' + originalJavaCode + '</pre>' +
                        '</div>' +
                        '</div></div>';
                    beforeBlocksHtml += beforeBlock;
                    // 右边为空
                    afterBlocksHtml += '';

                } else {
                    // 修改的接口 - 左边显示修复前，右边显示修复后
                    var beforeBlock = '<div class="diff-api-block" id="before-api-block-' + index + '">' +
                        blockHeader +
                        '<div class="diff-api-block-content">' +
                        '<div class="diff-api-block-before" style="flex:1">' +
                        '<div class="diff-api-block-label" style="color:#ff4757">修改前</div>' +
                        changesSummary +
                        '<pre class="diff-java-code">' + originalJavaCode + '</pre>' +
                        '</div>' +
                        '</div></div>';

                    var afterBlock = '<div class="diff-api-block" id="after-api-block-' + index + '">' +
                        blockHeader +
                        '<div class="diff-api-block-content">' +
                        '<div class="diff-api-block-after" style="flex:1">' +
                        '<div class="diff-api-block-label" style="color:#2ed573">修改后</div>' +
                        changesSummary +
                        '<pre class="diff-java-code">' + javaCode + '</pre>' +
                        '</div>' +
                        '</div></div>';

                    beforeBlocksHtml += beforeBlock;
                    afterBlocksHtml += afterBlock;
                }
            });

            // 渲染到两个面板 - 左边(修复前)，右边(修复后)
            beforeContainer.innerHTML = beforeBlocksHtml;
            afterContainer.innerHTML = afterBlocksHtml;
        }

        /**
         * 生成 Java Controller 代码风格（完整方法预览，带语法高亮）
         */
        function generateJavaControllerCode(path, httpMethod, apiName, annotations, description, params) {
            var methodName = toCamelCase(apiName);
            var returnType = 'Response';
            annotations = annotations || [];
            description = description || apiName;
            params = params || [];

            switch (httpMethod.toLowerCase()) {
                case 'get':
                    returnType = 'Response';
                    break;
                case 'post':
                    returnType = 'Response';
                    break;
                case 'put':
                    returnType = 'Response';
                    break;
                case 'delete':
                    returnType = 'Response';
                    break;
                case 'patch':
                    returnType = 'Response';
                    break;
            }

            // 生成自定义注解（带语法高亮）
            var customAnnotationsHtml = '';
            if (annotations && annotations.length > 0) {
                annotations.forEach(function(ann) {
                    var highlighted = ann
                        .replace(/(@\w+)/g, '<span class="syntax-keyword">$1</span>')
                        .replace(/(\w+)=/g, '<span class="syntax-field">$1</span>=')
                        .replace(/(".*?")/g, '<span class="syntax-string">$1</span>');
                    customAnnotationsHtml += '    <span class="syntax-annotation">' + highlighted + '</span>\n';
                });
            }

            // 根据框架选择注解
            var httpMethodAnnotation = currentFramework === 'spring' ? httpMethod.toUpperCase() : httpMethod.toUpperCase();
            var pathAnnotation = currentFramework === 'spring' ? '@GetMapping' : '@' + httpMethod.toUpperCase();
            var pathAnnotationValue = currentFramework === 'spring' ? '("' + path + '")' : '("' + path + '")';
            var classAnnotation = currentFramework === 'spring' ? '@RestController' : '@Path("' + path + '")';
            var producesAnnotation = currentFramework === 'spring' ? '@GetMapping' : '@Produces';

            // 生成完整的方法代码（带语法高亮）
            var code = '';
            if (customAnnotationsHtml) {
                code += customAnnotationsHtml;
            }

            // Spring 使用 @GetMapping/@PostMapping 等，CXF 使用 @GET/@POST + @Path
            if (currentFramework === 'spring') {
                // Spring: @GetMapping("/path"), @PostMapping("/path") 等
                code += '    <span class="syntax-annotation">@' + httpMethodAnnotation + 'Mapping' + pathAnnotationValue + '</span>\n';
            } else {
                // CXF: @GET, @Path
                code += '    <span class="syntax-annotation">@' + httpMethod.toUpperCase() + '</span>\n';
                code += '    <span class="syntax-annotation">@Path("' + path + '")</span>\n';
            }

            // 处理参数
            var hasRequestBody = false;
            var pathParams = [];
            var queryParams = [];
            var headerParams = [];
            var cookieParams = [];

            if (params && params.length > 0) {
                params.forEach(function(param) {
                    if (param.in === 'path') {
                        pathParams.push(param);  // 保存完整对象
                    } else if (param.in === 'query') {
                        queryParams.push(param);  // 保存完整对象
                    } else if (param.in === 'header') {
                        headerParams.push(param);  // 保存完整对象
                    } else if (param.in === 'cookie') {
                        cookieParams.push(param);  // 保存完整对象
                    } else if (param.in === 'body' || param.name === 'body') {
                        hasRequestBody = true;
                    }
                });

                // 注意：参数注解和声明都在后面的方法签名生成逻辑中统一处理
                // 这里不再单独生成注解，避免位置错误
            }

            if (hasRequestBody) {
                code += '    <span class="syntax-annotation">@Consumes</span>(<span class="syntax-string">MediaType.APPLICATION_JSON</span>)\n';
            }
            // Spring 使用 @ProducesMediaType.APPLICATION_JSON_JSON，CXF 使用 @Produces
            if (currentFramework === 'spring') {
                // Spring: @PostMapping 等已经包含了 produces，不需要单独加
            } else {
                // CXF: 需要 @Produces
                if (hasRequestBody) {
                    code += '    <span class="syntax-annotation">@Consumes</span>(<span class="syntax-string">MediaType.APPLICATION_JSON</span>)\n';
                }
                code += '    <span class="syntax-annotation">@Produces</span>(<span class="syntax-string">MediaType.APPLICATION_JSON</span>)\n';
            }

            // 生成方法签名 - @Size放在参数前面
            var paramStr = '()';
            if (hasRequestBody) {
                paramStr = '(@Valid <span class="syntax-type">RequestBody</span> <span class="syntax-field">req</span>)';
            } else if (pathParams.length > 0 || queryParams.length > 0 || headerParams.length > 0 || cookieParams.length > 0) {
                var methodParams = [];

                // CXF vs Spring annotation mapping
                var paramAnnotationMap = {
                    'path': currentFramework === 'spring' ? 'PathVariable' : 'PathParam',
                    'query': currentFramework === 'spring' ? 'RequestParam' : 'QueryParam',
                    'header': currentFramework === 'spring' ? 'RequestHeader' : 'HeaderParam',
                    'cookie': currentFramework === 'spring' ? 'CookieValue' : 'CookieParam'
                };

                // 处理路径参数
                pathParams.forEach(function(p) {
                    // 支持 param.type 或 param.schema.type
                    var paramType = p.type || (p.schema && p.schema.type);
                    paramType = paramType === 'integer' ? 'Integer' : (paramType === 'number' ? 'Double' : 'String');
                    var annots = '';
                    // required参数 -> String用@NotBlank，其他用@NotNull
                    if (p.required === true) {
                        annots += '<span class="syntax-annotation">@' + (paramType === 'String' ? 'NotBlank' : 'NotNull') + '</span> ';
                    }
                    // 数值类型 -> @Min/@Max
                    var minimum = p.minimum !== undefined ? p.minimum : (p.schema && p.schema.minimum !== undefined ? p.schema.minimum : undefined);
                    var maximum = p.maximum !== undefined ? p.maximum : (p.schema && p.schema.maximum !== undefined ? p.schema.maximum : undefined);
                    if (minimum !== undefined || maximum !== undefined) {
                        if (minimum !== undefined) annots += '<span class="syntax-annotation">@Min</span>(' + minimum + ') ';
                        if (maximum !== undefined) annots += '<span class="syntax-annotation">@Max</span>(' + maximum + ') ';
                    }
                    // 字符串类型 -> @Size
                    var minLength = p.minLength !== undefined ? p.minLength : (p.schema && p.schema.minLength !== undefined ? p.schema.minLength : undefined);
                    var maxLength = p.maxLength !== undefined ? p.maxLength : (p.schema && p.schema.maxLength !== undefined ? p.schema.maxLength : undefined);
                    if (minLength !== undefined || maxLength !== undefined) {
                        var parts = [];
                        if (minLength !== undefined && minLength > 0) parts.push('min=' + minLength);
                        if (maxLength !== undefined) parts.push('max=' + maxLength);
                        if (parts.length > 0) annots += '<span class="syntax-annotation">@Size</span>(' + parts.join(', ') + ') ';
                    }
                    annots += '<span class="syntax-annotation">@' + paramAnnotationMap['path'] + '("' + p.name + '")</span> ';
                    methodParams.push(annots + '<span class="syntax-type">' + paramType + '</span> <span class="syntax-field">' + p.name + '</span>');
                });

                // 处理查询参数
                queryParams.forEach(function(p) {
                    // 支持 param.type 或 param.schema.type
                    var paramType = p.type || (p.schema && p.schema.type);
                    paramType = paramType === 'integer' ? 'Integer' : (paramType === 'number' ? 'Double' : 'String');
                    var annots = '';
                    // required参数 -> String用@NotBlank，其他用@NotNull
                    if (p.required === true || (p.schema && p.schema.required === true)) {
                        annots += '<span class="syntax-annotation">@' + (paramType === 'String' ? 'NotBlank' : 'NotNull') + '</span> ';
                    }
                    // minLength/maxLength -> @Size
                    var minLength = p.minLength !== undefined ? p.minLength : (p.schema && p.schema.minLength !== undefined ? p.schema.minLength : undefined);
                    var maxLength = p.maxLength !== undefined ? p.maxLength : (p.schema && p.schema.maxLength !== undefined ? p.schema.maxLength : undefined);
                    if (minLength !== undefined || maxLength !== undefined) {
                        var parts = [];
                        if (minLength !== undefined && minLength > 0) parts.push('min=' + minLength);
                        if (maxLength !== undefined) parts.push('max=' + maxLength);
                        if (parts.length > 0) annots += '<span class="syntax-annotation">@Size</span>(' + parts.join(', ') + ') ';
                    }
                    // minimum/maximum -> @Min/@Max
                    var minimum = p.minimum !== undefined ? p.minimum : (p.schema && p.schema.minimum !== undefined ? p.schema.minimum : undefined);
                    var maximum = p.maximum !== undefined ? p.maximum : (p.schema && p.schema.maximum !== undefined ? p.schema.maximum : undefined);
                    if (minimum !== undefined || maximum !== undefined) {
                        if (minimum !== undefined) annots += '<span class="syntax-annotation">@Min</span>(' + minimum + ') ';
                        if (maximum !== undefined) annots += '<span class="syntax-annotation">@Max</span>(' + maximum + ') ';
                    }
                    annots += '<span class="syntax-annotation">@' + paramAnnotationMap['query'] + '("' + p.name + '")</span> ';
                    methodParams.push(annots + '<span class="syntax-type">' + paramType + '</span> <span class="syntax-field">' + p.name + '</span>');
                });

                // 处理Header参数
                headerParams.forEach(function(p) {
                    var paramType = p.type || (p.schema && p.schema.type);
                    paramType = paramType === 'integer' ? 'Integer' : (paramType === 'number' ? 'Double' : 'String');
                    var annots = '';
                    // required参数 -> String用@NotBlank，其他用@NotNull
                    if (p.required === true || (p.schema && p.schema.required === true)) {
                        annots += '<span class="syntax-annotation">@' + (paramType === 'String' ? 'NotBlank' : 'NotNull') + '</span> ';
                    }
                    // minLength/maxLength -> @Size
                    var minLength = p.minLength !== undefined ? p.minLength : (p.schema && p.schema.minLength !== undefined ? p.schema.minLength : undefined);
                    var maxLength = p.maxLength !== undefined ? p.maxLength : (p.schema && p.schema.maxLength !== undefined ? p.schema.maxLength : undefined);
                    if (minLength !== undefined || maxLength !== undefined) {
                        var parts = [];
                        if (minLength !== undefined && minLength > 0) parts.push('min=' + minLength);
                        if (maxLength !== undefined) parts.push('max=' + maxLength);
                        if (parts.length > 0) annots += '<span class="syntax-annotation">@Size</span>(' + parts.join(', ') + ') ';
                    }
                    // minimum/maximum -> @Min/@Max
                    var minimum = p.minimum !== undefined ? p.minimum : (p.schema && p.schema.minimum !== undefined ? p.schema.minimum : undefined);
                    var maximum = p.maximum !== undefined ? p.maximum : (p.schema && p.schema.maximum !== undefined ? p.schema.maximum : undefined);
                    if (minimum !== undefined || maximum !== undefined) {
                        if (minimum !== undefined) annots += '<span class="syntax-annotation">@Min</span>(' + minimum + ') ';
                        if (maximum !== undefined) annots += '<span class="syntax-annotation">@Max</span>(' + maximum + ') ';
                    }
                    annots += '<span class="syntax-annotation">@' + paramAnnotationMap['header'] + '("' + p.name + '")</span> ';
                    methodParams.push(annots + '<span class="syntax-type">' + paramType + '</span> <span class="syntax-field">' + p.name + '</span>');
                });

                // 处理Cookie参数
                cookieParams.forEach(function(p) {
                    var paramType = p.type || (p.schema && p.schema.type);
                    paramType = paramType === 'integer' ? 'Integer' : (paramType === 'number' ? 'Double' : 'String');
                    var annots = '';
                    // required参数 -> String用@NotBlank，其他用@NotNull
                    if (p.required === true || (p.schema && p.schema.required === true)) {
                        annots += '<span class="syntax-annotation">@' + (paramType === 'String' ? 'NotBlank' : 'NotNull') + '</span> ';
                    }
                    // minLength/maxLength -> @Size
                    var minLength = p.minLength !== undefined ? p.minLength : (p.schema && p.schema.minLength !== undefined ? p.schema.minLength : undefined);
                    var maxLength = p.maxLength !== undefined ? p.maxLength : (p.schema && p.schema.maxLength !== undefined ? p.schema.maxLength : undefined);
                    if (minLength !== undefined || maxLength !== undefined) {
                        var parts = [];
                        if (minLength !== undefined && minLength > 0) parts.push('min=' + minLength);
                        if (maxLength !== undefined) parts.push('max=' + maxLength);
                        if (parts.length > 0) annots += '<span class="syntax-annotation">@Size</span>(' + parts.join(', ') + ') ';
                    }
                    // minimum/maximum -> @Min/@Max
                    var minimum = p.minimum !== undefined ? p.minimum : (p.schema && p.schema.minimum !== undefined ? p.schema.minimum : undefined);
                    var maximum = p.maximum !== undefined ? p.maximum : (p.schema && p.schema.maximum !== undefined ? p.schema.maximum : undefined);
                    if (minimum !== undefined || maximum !== undefined) {
                        if (minimum !== undefined) annots += '<span class="syntax-annotation">@Min</span>(' + minimum + ') ';
                        if (maximum !== undefined) annots += '<span class="syntax-annotation">@Max</span>(' + maximum + ') ';
                    }
                    annots += '<span class="syntax-annotation">@' + paramAnnotationMap['cookie'] + '("' + p.name + '")</span> ';
                    methodParams.push(annots + '<span class="syntax-type">' + paramType + '</span> <span class="syntax-field">' + p.name + '</span>');
                });

                paramStr = '(' + methodParams.join(', ') + ')';
            }

            code += '    <span class="syntax-keyword">public</span> <span class="syntax-type">' + returnType + '</span> <span class="syntax-method">' + methodName + '</span>' + paramStr + ' {\n';
            code += '        <span class="syntax-comment">// TODO: 实现业务逻辑</span>\n';
            code += '        <span class="syntax-keyword">return</span> <span class="syntax-keyword">null</span>;\n';
            code += '    }';

            return code;
        }

        /**
         * 生成 Java 字段代码（完整效果，带语法高亮）
         * 使用简单的方式：先转义HTML，再简单高亮注解名
         */
        function generateJavaFieldCode(fieldName, fieldType, annotations, validation) {
            annotations = annotations || [];
            validation = validation || {};

            var code = '';

            // 添加注解
            annotations.forEach(function(ann) {
                // 先转义HTML特殊字符，避免注入
                var escapedAnn = ann
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');

                // 简单高亮注解名 @开头的部分
                escapedAnn = escapedAnn.replace(/^(@\w+)/, '<span class="syntax-annotation">$1</span>');

                code += '    ' + escapedAnn + '\n';
            });

            // 字段
            var escapedType = fieldType.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            var escapedName = fieldName.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            code += '    <span class="syntax-keyword">private</span> <span class="syntax-type">' + escapedType + '</span> <span class="syntax-field">' + escapedName + '</span>;\n';

            return code;
        }

        /**
         * 生成 Java 字段代码（纯文本版本，用于escapeHtml）
         */
        function generateJavaFieldCodePlain(fieldName, fieldType, annotations, validation) {
            annotations = annotations || [];
            validation = validation || {};

            var code = '';

            // 添加注解
            annotations.forEach(function(ann) {
                code += '    ' + ann + '\n';
            });

            // 字段
            code += '    private ' + fieldType + ' ' + fieldName + ';\n';

            return code;
        }

        /**
         * 转换为驼峰命名
         */
        function toCamelCase(str) {
            if (!str) return 'api';
            return str.replace(/[-_\/](\w)/g, function(match, c) {
                return c ? c.toUpperCase() : '';
            }).replace(/^\w/, function(c) {
                return c.toLowerCase();
            });
        }

        /**
         * Render field-level changes with before/after comparison
         */
        function renderFieldChanges(impact) {
            var beforeContainer = document.getElementById('diff-field-before');
            var afterContainer = document.getElementById('diff-field-after');
            var countEl = document.getElementById('diff-field-count');

            if (!impact || !impact.fields || impact.fields.length === 0) {
                beforeContainer.innerHTML = '<div class="diff-field-empty">无字段变更</div>';
                afterContainer.innerHTML = '<div class="diff-field-empty">无字段变更</div>';
                countEl.textContent = '0';
                return;
            }

            var fields = impact.fields;
            countEl.textContent = fields.length;

            // Group by class
            var byClass = {};
            fields.forEach(function(item) {
                if (!byClass[item.className]) {
                    byClass[item.className] = [];
                }
                byClass[item.className].push(item);
            });

            var beforeHtml = '';
            var afterHtml = '';

            for (var className in byClass) {
                var classFields = byClass[className];

                beforeHtml += '<div class="diff-field-class"><div class="diff-field-class-title">' + escapeHtml(className) + '.java</div>';
                afterHtml += '<div class="diff-field-class"><div class="diff-field-class-title">' + escapeHtml(className) + '.java</div>';

                classFields.forEach(function(item) {
                    var fieldType = item.fieldType || 'String';
                    var fieldName = item.field;
                    var changes = item.changes || [];
                    var changeType = item.type || 'modified';

                    // Build detailed changes info - 分离before和after
                    var addedAnnotations = [];
                    var beforeDetails = [];  // 修复前缺失的校验
                    var afterDetails = [];   // 修复后新增的校验

                    // 先收集所有的变更，按字段分组
                    if (changes.length > 0) {
                        // 用于收集每个字段的变更
                        var fieldChangesMap = {};
                        var yamlFormatChange = false;

                        changes.forEach(function(change) {
                            if (change === 'YAML格式变化') {
                                yamlFormatChange = true;
                                addedAnnotations.push('@Valid');
                                beforeDetails.push('缺失校验规则');
                                afterDetails.push('新增 @Valid');
                            } else if (typeof change === 'object' && change.before !== undefined) {
                                if (change.prop === 'required') {
                                    var requiredAnnot = fieldType === 'String' ? '@NotBlank' : '@NotNull';
                                    beforeDetails.push('缺失必填校验');
                                    afterDetails.push('新增 ' + requiredAnnot);
                                    addedAnnotations.push(requiredAnnot);
                                } else if (change.prop === 'format' && change.after === 'email') {
                                    beforeDetails.push('缺失邮箱格式校验');
                                    afterDetails.push('新增 @Email');
                                    addedAnnotations.push('@Email');
                                } else if (change.prop === 'pattern') {
                                    // 检查是否已经有同字段的变更
                                    var existingIdx = beforeDetails.findIndex(function(d) {
                                        return d.includes('缺失正则校验');
                                    });
                                    if (existingIdx === -1) {
                                        beforeDetails.push('缺失正则校验');
                                        afterDetails.push('新增 @Pattern(regexp="' + escapeHtml(change.after || '') + '")');
                                        addedAnnotations.push('@Pattern(regexp="' + (change.after || '') + '")');
                                    }
                                } else if (change.prop === 'minimum') {
                                    // 收集minimum，后面合并
                                    if (!fieldChangesMap['min']) fieldChangesMap['min'] = [];
                                    fieldChangesMap['min'].push(change.after);
                                } else if (change.prop === 'maximum') {
                                    if (!fieldChangesMap['max']) fieldChangesMap['max'] = [];
                                    fieldChangesMap['max'].push(change.after);
                                } else if (change.prop === 'minLength') {
                                    if (!fieldChangesMap['sizeMin']) fieldChangesMap['sizeMin'] = [];
                                    fieldChangesMap['sizeMin'].push(change.after);
                                } else if (change.prop === 'maxLength') {
                                    if (!fieldChangesMap['sizeMax']) fieldChangesMap['sizeMax'] = [];
                                    fieldChangesMap['sizeMax'].push(change.after);
                                }
                            } else if (typeof change === 'string' && change.startsWith('@')) {
                                addedAnnotations.push(change);
                            }
                        });

                        // 合并数值范围校验 @Min/@Max
                        if (fieldChangesMap['min'] || fieldChangesMap['max']) {
                            var minVals = fieldChangesMap['min'] || [0];
                            var maxVals = fieldChangesMap['max'] || [];
                            // 去重
                            minVals = [...new Set(minVals)];
                            maxVals = [...new Set(maxVals)];

                            beforeDetails.push('缺失数值范围校验');
                            var mmAnnots = [];
                            minVals.forEach(function(m) {
                                mmAnnots.push('@Min(' + m + ')');
                            });
                            maxVals.forEach(function(m) {
                                mmAnnots.push('@Max(' + m + ')');
                            });
                            afterDetails.push('新增 ' + mmAnnots.join(' '));
                            mmAnnots.forEach(function(a) { addedAnnotations.push(a); });
                        }

                        // 合并长度校验 @Size
                        if (fieldChangesMap['sizeMin'] || fieldChangesMap['sizeMax']) {
                            var sMinVals = fieldChangesMap['sizeMin'] || [];
                            var sMaxVals = fieldChangesMap['sizeMax'] || [];
                            sMinVals = [...new Set(sMinVals)];
                            sMaxVals = [...new Set(sMaxVals)];

                            beforeDetails.push('缺失长度范围校验');
                            var sizeParts = [];
                            var hasSizeMin = false;
                            sMinVals.forEach(function(m) {
                                if (m > 0) {
                                    sizeParts.push('min=' + m);
                                    hasSizeMin = true;
                                }
                            });
                            sMaxVals.forEach(function(m) {
                                sizeParts.push('max=' + m);
                            });
                            var sizeAnnot = '@Size(' + sizeParts.join(', ') + ')';
                            afterDetails.push('新增 ' + sizeAnnot);
                            addedAnnotations.push(sizeAnnot);
                        }
                    }

                    // Deduplicate
                    addedAnnotations = [...new Set(addedAnnotations)];

                    // Generate field code for before/after
                    var beforeCode = generateJavaFieldCode(fieldName, fieldType, [], {});
                    var afterCode = generateJavaFieldCode(fieldName, fieldType, addedAnnotations, {});

                    // Before: show field without annotations - 显示缺失的校验
                    beforeHtml += '<div class="diff-field-row">';
                    beforeHtml += '<pre class="diff-java-code">' + beforeCode + '</pre>';
                    if (beforeDetails.length > 0) {
                        beforeHtml += '<div class="diff-validation-details">' + beforeDetails.join('<br>') + '</div>';
                    }
                    beforeHtml += '</div>';

                    // After: field with annotations added - 显示新增的校验
                    afterHtml += '<div class="diff-field-row">';
                    afterHtml += '<pre class="diff-java-code">' + afterCode + '</pre>';
                    if (afterDetails.length > 0) {
                        afterHtml += '<div class="diff-validation-details diff-validation-after">' + afterDetails.join('<br>') + '</div>';
                    }
                    afterHtml += '</div>';
                });

                beforeHtml += '</div>';
                afterHtml += '</div>';
            }

            beforeContainer.innerHTML = beforeHtml;
            afterContainer.innerHTML = afterHtml;
        }

        /**
         * Compute impact on Java code
         */
        function computeImpact(before, after) {
            var result = {
                apis: [],  // API/interface level changes
                fields: []  // Field level changes
            };

            try {
                var beforeParsed = jsyaml.load(before);
                var afterParsed = jsyaml.load(after);

                if (!beforeParsed || !afterParsed) {
                    return result;
                }

                // Check if it's Swagger/OpenAPI format
                var isSwagger = (beforeParsed.swagger || beforeParsed.openapi || beforeParsed.paths);

                if (isSwagger) {
                    // Swagger/OpenAPI format - compare paths/APIs
                    var beforePaths = beforeParsed.paths || {};
                    var afterPaths = afterParsed.paths || {};

                    // Normalize path: ensure it starts with /
                    function normalizePath(path) {
                        if (!path) return path;
                        // Remove duplicate slashes
                        var normalized = path.replace(/\/+/g, '/');
                        // Remove /XXX/ prefix (placeholder path)
                        normalized = normalized.replace(/^\/XXX\//, '/');
                        if (!normalized.startsWith('/')) {
                            normalized = '/' + normalized;
                        }
                        return normalized;
                    }

                    // Build normalized map for before paths
                    var normalizedBeforePaths = {};
                    for (var origPath in beforePaths) {
                        var np = normalizePath(origPath);
                        normalizedBeforePaths[np] = origPath;
                    }

                    // Compare each path in after
                    for (var path in afterPaths) {
                        var np = normalizePath(path);
                        var beforePath = beforePaths[path];
                        var afterPath = afterPaths[path];
                        var originalPath = path;

                        // Check if path was fixed (e.g., //users -> /users or users -> /users)
                        if (normalizedBeforePaths[np]) {
                            // Found matching normalized path
                            originalPath = normalizedBeforePaths[np];
                            beforePath = beforePaths[originalPath];
                        }

                        if (!beforePath && originalPath === path) {
                            // New API path added - check if it's truly new (not just normalized difference)
                            if (!normalizedBeforePaths[np]) {
                                var afterOp = afterPath[Object.keys(afterPath)[0]];
                                // Only add if there's actual content
                                if (afterOp.summary || afterOp.operationId || (afterOp.parameters && afterOp.parameters.length > 0)) {
                                    result.apis.push({
                                        path: path,
                                        originalPath: path,
                                        method: Object.keys(afterPath)[0],
                                        name: afterOp.operationId || afterOp.summary || path.replace(/\//g, '').replace(/\{|\}/g, ''),
                                        summary: afterOp.summary || '',
                                        operationId: afterOp.operationId || '',
                                        parameters: afterOp.parameters || [],
                                        type: 'added',
                                        changes: [{ prop: 'API', before: '(无)', after: '新增接口' }]
                                    });
                                }
                            }
                        } else if (originalPath !== path) {
                            // Path was fixed (//users -> /users or users -> /users)
                            var afterOpFixed = afterPath[Object.keys(afterPath)[0]];
                            var beforeOpFixed = beforePath[originalPath] || {};
                            var changes = [{ prop: 'path', before: originalPath, after: path }];

                            // 比较参数变化
                            if (afterOpFixed.parameters && afterOpFixed.parameters.length > 0) {
                                var beforeParamMap = {};
                                if (beforeOpFixed.parameters) {
                                    beforeOpFixed.parameters.forEach(function(p) { beforeParamMap[p.name] = p; });
                                }
                                afterOpFixed.parameters.forEach(function(param) {
                                    var beforeParam = beforeParamMap[param.name];
                                    if (!beforeParam) {
                                        changes.push({ prop: '参数 ' + param.name, before: '(无)', after: '新增' });
                                    } else {
                                        // 检查description变化
                                        if (!beforeParam.description && param.description) {
                                            changes.push({ prop: '参数 ' + param.name + ' description', before: '(无)', after: param.description });
                                        }
                                        // 检查校验规则变化
                                        var beforeMinLength = beforeParam.minLength || (beforeParam.schema && beforeParam.schema.minLength);
                                        var afterMinLength = param.minLength || (param.schema && param.schema.minLength);
                                        if (!beforeMinLength && afterMinLength !== undefined) {
                                            changes.push({ prop: '参数 ' + param.name + ' minLength', before: '(无)', after: afterMinLength });
                                        }
                                        var beforeMaxLength = beforeParam.maxLength || (beforeParam.schema && beforeParam.schema.maxLength);
                                        var afterMaxLength = param.maxLength || (param.schema && param.schema.maxLength);
                                        if (!beforeMaxLength && afterMaxLength !== undefined) {
                                            changes.push({ prop: '参数 ' + param.name + ' maxLength', before: '(无)', after: afterMaxLength });
                                        }
                                        var beforeMinimum = beforeParam.minimum || (beforeParam.schema && beforeParam.schema.minimum);
                                        var afterMinimum = param.minimum || (param.schema && param.schema.minimum);
                                        if (!beforeMinimum && afterMinimum !== undefined) {
                                            changes.push({ prop: '参数 ' + param.name + ' minimum', before: '(无)', after: afterMinimum });
                                        }
                                        var beforeMaximum = beforeParam.maximum || (beforeParam.schema && beforeParam.schema.maximum);
                                        var afterMaximum = param.maximum || (param.schema && param.schema.maximum);
                                        if (!beforeMaximum && afterMaximum !== undefined) {
                                            changes.push({ prop: '参数 ' + param.name + ' maximum', before: '(无)', after: afterMaximum });
                                        }
                                        var beforePattern = beforeParam.pattern || (beforeParam.schema && beforeParam.schema.pattern);
                                        var afterPattern = param.pattern || (param.schema && param.schema.pattern);
                                        if (!beforePattern && afterPattern) {
                                            changes.push({ prop: '参数 ' + param.name + ' pattern', before: '(无)', after: afterPattern });
                                        }
                                    }
                                });
                            }

                            result.apis.push({
                                path: path,
                                originalPath: originalPath,
                                method: Object.keys(afterPath)[0],
                                name: afterOpFixed.operationId || afterOpFixed.summary || path.replace(/\//g, '').replace(/\{|\}/g, ''),
                                summary: afterOpFixed.summary || '',
                                operationId: afterOpFixed.operationId || '',
                                parameters: afterOpFixed.parameters || [],
                                originalParameters: beforeOpFixed.parameters || [],
                                type: 'modified',
                                changes: changes
                            });
                        } else {
                            // Check if methods changed - only add if there are actual changes
                            var hasActualChange = false;
                            var pathChanges = [];

                            // Check if path was fixed
                            if (originalPath !== path) {
                                hasActualChange = true;
                                pathChanges.push({ prop: 'path', before: originalPath, after: path });
                            }

                            for (var method in afterPath) {
                                var beforeMethod = beforePath[method];
                                var afterMethod = afterPath[method];

                                if (!beforeMethod) {
                                    // New method added - this is an actual change
                                    hasActualChange = true;
                                } else {
                                    // Check specific property changes
                                    var changes = [];

                                    // Check operationId
                                    if (!beforeMethod.operationId && afterMethod.operationId) {
                                        changes.push({ prop: 'operationId', before: '(无)', after: afterMethod.operationId });
                                    }
                                    // Check description
                                    if (!beforeMethod.description && afterMethod.description) {
                                        changes.push({ prop: 'description', before: '(无)', after: afterMethod.description });
                                    }

                                    // Check parameters - compare by name
                                    // 注意：需要比较 param 和 param.schema 两层的校验规则
                                    if (afterMethod.parameters && afterMethod.parameters.length > 0) {
                                        var beforeParamMap = {};
                                        if (beforeMethod.parameters) {
                                            beforeMethod.parameters.forEach(function(p) { beforeParamMap[p.name] = p; });
                                        }
                                        afterMethod.parameters.forEach(function(param) {
                                            var beforeParam = beforeParamMap[param.name];
                                            if (!beforeParam) {
                                                changes.push({ prop: '参数 ' + param.name, before: '(无)', after: '新增' });
                                            } else {
                                                // 检查description变化
                                                if (!beforeParam.description && param.description) {
                                                    changes.push({ prop: '参数 ' + param.name + ' description', before: '(无)', after: param.description });
                                                }
                                                // 检查type变化（支持 param.type 和 param.schema.type）
                                                var beforeType = beforeParam.type || (beforeParam.schema && beforeParam.schema.type);
                                                var afterType = param.type || (param.schema && param.schema.type);
                                                if (!beforeType && afterType) {
                                                    changes.push({ prop: '参数 ' + param.name + ' type', before: '(无)', after: afterType });
                                                }
                                                // 检查校验规则变化 - 需要检查 param 和 schema 两层
                                                var beforeRequired = beforeParam.required || (beforeParam.schema && beforeParam.schema.required);
                                                var afterRequired = param.required || (param.schema && param.schema.required);
                                                if (!beforeRequired && afterRequired === true) {
                                                    changes.push({ prop: '参数 ' + param.name + ' required', before: '(无)', after: true });
                                                }
                                                // 检查 minLength
                                                var beforeMinLength = beforeParam.minLength || (beforeParam.schema && beforeParam.schema.minLength);
                                                var afterMinLength = param.minLength || (param.schema && param.schema.minLength);
                                                if (!beforeMinLength && afterMinLength !== undefined) {
                                                    changes.push({ prop: '参数 ' + param.name + ' minLength', before: '(无)', after: afterMinLength });
                                                }
                                                // 检查 maxLength
                                                var beforeMaxLength = beforeParam.maxLength || (beforeParam.schema && beforeParam.schema.maxLength);
                                                var afterMaxLength = param.maxLength || (param.schema && param.schema.maxLength);
                                                if (!beforeMaxLength && afterMaxLength !== undefined) {
                                                    changes.push({ prop: '参数 ' + param.name + ' maxLength', before: '(无)', after: afterMaxLength });
                                                }
                                                // 检查 minimum
                                                var beforeMinimum = beforeParam.minimum || (beforeParam.schema && beforeParam.schema.minimum);
                                                var afterMinimum = param.minimum || (param.schema && param.schema.minimum);
                                                if (!beforeMinimum && afterMinimum !== undefined) {
                                                    changes.push({ prop: '参数 ' + param.name + ' minimum', before: '(无)', after: afterMinimum });
                                                }
                                                // 检查 maximum
                                                var beforeMaximum = beforeParam.maximum || (beforeParam.schema && beforeParam.schema.maximum);
                                                var afterMaximum = param.maximum || (param.schema && param.schema.maximum);
                                                if (!beforeMaximum && afterMaximum !== undefined) {
                                                    changes.push({ prop: '参数 ' + param.name + ' maximum', before: '(无)', after: afterMaximum });
                                                }
                                                // 检查 pattern
                                                var beforePattern = beforeParam.pattern || (beforeParam.schema && beforeParam.schema.pattern);
                                                var afterPattern = param.pattern || (param.schema && param.schema.pattern);
                                                if (!beforePattern && afterPattern) {
                                                    changes.push({ prop: '参数 ' + param.name + ' pattern', before: '(无)', after: afterPattern });
                                                }
                                                // 检查 format (如 email)
                                                var beforeFormat = beforeParam.format || (beforeParam.schema && beforeParam.schema.format);
                                                var afterFormat = param.format || (param.schema && param.schema.format);
                                                if (!beforeFormat && afterFormat) {
                                                    changes.push({ prop: '参数 ' + param.name + ' format', before: '(无)', after: afterFormat });
                                                }
                                            }
                                        });
                                    }

                                    // Only add to changes if there are actual content changes
                                    if (changes.length > 0) {
                                        hasActualChange = true;
                                        pathChanges = pathChanges.concat(changes);
                                    }
                                }
                            }

                            // Only add to result if there are actual changes
                            if (hasActualChange) {
                                var firstAfterMethod = afterPath[Object.keys(afterPath)[0]];
                                var firstBeforeMethod = beforePath[Object.keys(beforePath)[0]] || {};
                                result.apis.push({
                                    path: path,
                                    originalPath: originalPath,
                                    method: Object.keys(afterPath)[0],
                                    name: firstAfterMethod.operationId || firstAfterMethod.summary || path.replace(/\//g, '').replace(/\{|\}/g, ''),
                                    summary: firstAfterMethod.summary || '',
                                    operationId: firstAfterMethod.operationId || '',
                                    parameters: firstAfterMethod.parameters || [],
                                    originalParameters: firstBeforeMethod.parameters || [],
                                    type: (originalPath !== path || pathChanges.some(function(c) { return c.prop === 'path'; })) ? 'modified' : 'modified',
                                    changes: pathChanges
                                });
                            }
                        }
                    }

                    // Check for deleted paths
                    for (var path in beforePaths) {
                        if (!afterPaths[path]) {
                            var beforeOp = beforePaths[path][Object.keys(beforePaths[path])[0]];
                            result.apis.push({
                                path: path,
                                originalPath: path,
                                method: Object.keys(beforePaths[path])[0],
                                name: beforeOp.operationId || beforeOp.summary || path.replace(/\//g, '').replace(/\{|\}/g, ''),
                                summary: beforeOp.summary || '',
                                operationId: beforeOp.operationId || '',
                                parameters: beforeOp.parameters || [],
                                type: 'deleted',
                                changes: []
                            });
                        }
                    }

                    // Compare definitions (field changes)
                    var beforeDefs = beforeParsed.definitions || (beforeParsed.components && beforeParsed.components.schemas) || {};
                    var afterDefs = afterParsed.definitions || (afterParsed.components && afterParsed.components.schemas) || {};

                    // Extract definitions section for format comparison
                    var beforeDefSection = extractDefinitionsSection(before);
                    var afterDefSection = extractDefinitionsSection(after);

                    // Compare each definition
                    for (var defName in afterDefs) {
                        var beforeDef = beforeDefs[defName] || {};
                        var afterDef = afterDefs[defName];
                        var beforeProps = beforeDef.properties || {};
                        var afterProps = afterDef.properties || {};

                        var hasChanges = false;
                        var fieldChangesList = [];

                        for (var propName in afterProps) {
                            var beforeProp = beforeProps[propName] || {};
                            var afterProp = afterProps[propName];

                            // Check if validation changed
                            var beforeVal = JSON.stringify(beforeProp);
                            var afterVal = JSON.stringify(afterProp);

                            if (beforeVal !== afterVal) {
                                hasChanges = true;
                                var fieldType = afterProp.type || 'Object';
                                if (fieldType === 'integer') fieldType = 'Integer';
                                if (fieldType === 'number' && afterProp.format === 'double') fieldType = 'Double';
                                if (fieldType === 'boolean') fieldType = 'Boolean';
                                if (fieldType === 'array') fieldType = 'List';

                                var changes = getSwaggerFieldChanges(beforeProp, afterProp);
                                fieldChangesList.push({
                                    field: propName,
                                    fieldType: fieldType,
                                    changes: changes
                                });
                            }
                        }

                        // If there are changes, add them
                        if (fieldChangesList.length > 0) {
                            fieldChangesList.forEach(function(fc) {
                                result.fields.push({
                                    className: defName,
                                    field: fc.field,
                                    fieldType: fc.fieldType,
                                    type: 'model',
                                    changes: fc.changes
                                });
                            });
                        } else if (hasChanges === false && JSON.stringify(beforeDef) !== JSON.stringify(afterDef)) {
                            // Parsed objects are same but might have YAML format difference
                            // Add all fields as having "格式变化"
                            for (var propName in afterProps) {
                                var fieldType = afterProps[propName].type || 'Object';
                                if (fieldType === 'integer') fieldType = 'Integer';
                                if (fieldType === 'boolean') fieldType = 'Boolean';
                                if (fieldType === 'array') fieldType = 'List';

                                result.fields.push({
                                    className: defName,
                                    field: propName,
                                    fieldType: fieldType,
                                    type: 'model',
                                    changes: ['YAML格式变化']
                                });
                            }
                        }
                    }

                    // If no field changes detected but YAML has changes in definitions, show them
                    if (result.fields.length === 0 && beforeDefSection !== afterDefSection) {
                        // Show all definitions as changed
                        for (var defName in afterDefs) {
                            var afterDef = afterDefs[defName];
                            if (afterDef.properties) {
                                for (var propName in afterDef.properties) {
                                    var fieldType = afterDef.properties[propName].type || 'Object';
                                    if (fieldType === 'integer') fieldType = 'Integer';
                                    if (fieldType === 'boolean') fieldType = 'Boolean';
                                    if (fieldType === 'array') fieldType = 'List';

                                    result.fields.push({
                                        className: defName,
                                        field: propName,
                                        fieldType: fieldType,
                                        type: 'model',
                                        changes: ['YAML格式变化']
                                    });
                                }
                            }
                        }
                    }

                    return result;
                }

                /**
                 * Extract definitions section from YAML text for comparison
                 */
                function extractDefinitionsSection(yamlText) {
                    // Remove line numbers that might be at the start
                    var text = yamlText.replace(/^\d+/gm, '');
                    var lines = text.split('\n');
                    var inDefinitions = false;
                    var result = [];

                    for (var i = 0; i < lines.length; i++) {
                        var line = lines[i];
                        if (line.match(/^definitions:\s*$/) || line.match(/^components:\s*$/)) {
                            inDefinitions = true;
                            continue;
                        }
                        if (inDefinitions) {
                            // Stop at next top-level key
                            if (line.match(/^[a-zA-Z]/) && !line.match(/^\s/)) {
                                break;
                            }
                            result.push(line);
                        }
                    }
                    return result.join('\n');
                }

                // Custom format - check apis
                if (!beforeParsed.apis || !afterParsed.apis) {
                    return result;
                }

                // Compare each API
                beforeParsed.apis.forEach(function(api, apiIndex) {
                    var afterApi = afterParsed.apis[apiIndex];
                    if (!afterApi) return;

                    var className = (api.request && api.request.className) ||
                                   (api.response && api.response.className) ||
                                   'Unknown';

                    // Track API level changes
                    var apiChanged = false;

                    // Check request fields
                    if (api.request && api.request.fields && afterApi.request && afterApi.request.fields) {
                        var maxReqFields = Math.max(api.request.fields.length, afterApi.request.fields.length);
                        for (var fieldIndex = 0; fieldIndex < maxReqFields; fieldIndex++) {
                            var field = api.request.fields[fieldIndex];
                            var afterField = afterApi.request.fields[fieldIndex];

                            if (!field && afterField) {
                                // New field added
                                if (afterField.validation && Object.keys(afterField.validation).length > 0) {
                                    result.fields.push({
                                        className: afterApi.request.className || className + 'Req',
                                        field: afterField.name,
                                        fieldType: afterField.type || 'String',
                                        type: 'request',
                                        changes: getFieldChanges({}, afterField.validation)
                                    });
                                    apiChanged = true;
                                }
                            } else if (field && afterField) {
                                var beforeVal = JSON.stringify(field.validation || {});
                                var afterVal = JSON.stringify(afterField.validation || {});
                                if (beforeVal !== afterVal) {
                                    result.fields.push({
                                        className: afterApi.request.className || className + 'Req',
                                        field: field.name,
                                        fieldType: field.type || 'String',
                                        type: 'request',
                                        changes: getFieldChanges(field.validation, afterField.validation)
                                    });
                                    apiChanged = true;
                                }
                            }
                        }
                    }

                    // Check response fields
                    if (api.response && api.response.fields && afterApi.response && afterApi.response.fields) {
                        var maxRspFields = Math.max(api.response.fields.length, afterApi.response.fields.length);
                        for (var fieldIndex = 0; fieldIndex < maxRspFields; fieldIndex++) {
                            var field = api.response.fields[fieldIndex];
                            var afterField = afterApi.response.fields[fieldIndex];

                            if (!field && afterField) {
                                // New field added
                                if (afterField.validation && Object.keys(afterField.validation).length > 0) {
                                    result.fields.push({
                                        className: afterApi.response.className || className + 'Rsp',
                                        field: afterField.name,
                                        fieldType: afterField.type || 'String',
                                        type: 'response',
                                        changes: getFieldChanges({}, afterField.validation)
                                    });
                                    apiChanged = true;
                                }
                            } else if (field && afterField) {
                                var beforeVal = JSON.stringify(field.validation || {});
                                var afterVal = JSON.stringify(afterField.validation || {});
                                if (beforeVal !== afterVal) {
                                    result.fields.push({
                                        className: afterApi.response.className || className + 'Rsp',
                                        field: field.name,
                                        fieldType: field.type || 'String',
                                        type: 'response',
                                        changes: getFieldChanges(field.validation, afterField.validation)
                                    });
                                    apiChanged = true;
                                }
                            }
                        }
                    }

                    // Add API to changes if fields changed
                    if (apiChanged) {
                        result.apis.push({
                            name: api.name || 'API ' + (apiIndex + 1),
                            path: api.path || '',
                            method: api.method || '',
                            annotations: api.annotations || [],
                            type: 'modified'
                        });
                    }
                });
            } catch (e) {
                console.log('Impact analysis error:', e);
            }

            return result;
        }

        /**
         * Get field validation changes
         */
        function getFieldChanges(beforeVal, afterVal) {
            var changes = [];
            var before = beforeVal || {};
            var after = afterVal || {};

            // Check each validation property
            var props = ['notNull', 'minLength', 'maxLength', 'email', 'pattern', 'min', 'max', 'minSize', 'maxSize', 'past', 'future'];
            props.forEach(function(prop) {
                if (before[prop] !== after[prop]) {
                    if (after[prop] !== undefined && after[prop] !== false) {
                        var annotation = propToAnnotation(prop, after[prop]);
                        if (annotation) changes.push(annotation);
                    }
                }
            });

            return changes;
        }

        /**
         * Get swagger field validation changes with before/after values
         */
        function getSwaggerFieldChanges(beforeProp, afterProp) {
            var changes = [];

            // Check description
            if (!beforeProp.description && afterProp.description) {
                changes.push({ prop: 'description', before: '(无)', after: afterProp.description });
            }

            // Check type
            if (!beforeProp.type && afterProp.type) {
                changes.push({ prop: 'type', before: '(无)', after: afterProp.type });
            }

            // Check required
            if (afterProp.required && !beforeProp.required) {
                changes.push({ prop: 'required', before: 'false', after: 'true' });
            }

            // Check format
            if (afterProp.format === 'email' || afterProp.description && afterProp.description.toLowerCase().includes('email')) {
                if (!beforeProp.format || beforeProp.format !== 'email') {
                    changes.push({ prop: 'format', before: '(无)', after: 'email' });
                }
            }

            // Check pattern
            if (afterProp.pattern && !beforeProp.pattern) {
                changes.push({ prop: 'pattern', before: '(无)', after: afterProp.pattern });
            }

            // Check minimum/maximum
            if (afterProp.minimum !== undefined && beforeProp.minimum === undefined) {
                changes.push({ prop: 'minimum', before: '(无)', after: afterProp.minimum });
            }
            if (afterProp.maximum !== undefined && beforeProp.maximum === undefined) {
                changes.push({ prop: 'maximum', before: '(无)', after: afterProp.maximum });
            }

            // Check minLength/maxLength
            if (afterProp.minLength !== undefined && beforeProp.minLength === undefined) {
                changes.push({ prop: 'minLength', before: '(无)', after: afterProp.minLength });
            }
            if (afterProp.maxLength !== undefined && beforeProp.maxLength === undefined) {
                changes.push({ prop: 'maxLength', before: '(无)', after: afterProp.maxLength });
            }

            // Check minItems/maxItems (for arrays)
            if (afterProp.minItems !== undefined && beforeProp.minItems === undefined) {
                changes.push({ prop: 'minItems', before: '(无)', after: afterProp.minItems });
            }
            if (afterProp.maxItems !== undefined && beforeProp.maxItems === undefined) {
                changes.push({ prop: 'maxItems', before: '(无)', after: afterProp.maxItems });
            }

            return changes;
        }

        /**
         * Convert validation property to Java annotation
         */
        function propToAnnotation(prop, value) {
            var map = {
                'notNull': '@NotNull',
                'minLength': '@Size(min=' + value + ')',
                'maxLength': '@Size(max=' + value + ')',
                'email': '@Email',
                'pattern': '@Pattern(regexp="' + value + '")',
                'min': '@Min(value=' + value + ')',
                'max': '@Max(value=' + value + ')',
                'minSize': '@Size(min=' + value + ')',
                'maxSize': '@Size(max=' + value + ')',
                'past': '@Past',
                'future': '@Future'
            };
            return map[prop] || null;
        }

        /**
         * Setup synchronized scrolling for all diff panel groups
         */
        function setupScrollSync() {
            var isSyncing = false;

            // Sync function for a group of panels
            function setupGroupSync(groupName) {
                var leftPanel = document.querySelector('[data-scroll-group="' + groupName + '"].diff-panel-left, #diff-' + groupName + '-before, #diff-' + groupName + '-panel-left');
                var rightPanel = document.querySelector('[data-scroll-group="' + groupName + '"]:not(.diff-panel-left), #diff-' + groupName + '-after, #diff-' + groupName + '-panel:not(.diff-panel-left)');

                // Handle YAML panels
                if (groupName === 'yaml') {
                    leftPanel = document.getElementById('diff-before');
                    rightPanel = document.getElementById('diff-after');
                }

                if (!leftPanel || !rightPanel) return;

                function syncScroll(source, target) {
                    if (isSyncing) return;
                    isSyncing = true;
                    target.scrollTop = source.scrollTop;
                    target.scrollLeft = source.scrollLeft;
                    setTimeout(function() { isSyncing = false; }, 10);
                }

                leftPanel.addEventListener('scroll', function() {
                    syncScroll(leftPanel, rightPanel);
                });

                rightPanel.addEventListener('scroll', function() {
                    syncScroll(rightPanel, leftPanel);
                });
            }

            // Setup sync for each group
            setupGroupSync('yaml');
            setupGroupSync('api');
            setupGroupSync('field');
        }

        /**
         * Close diff modal
         */
        function closeDiffModal() {
            document.getElementById('diff-modal').classList.remove('active');
            window.pendingFixedContent = null;
        }

        /**
         * Show debug info (full YAML content)
         */
        function showDebugInfo() {
            var before = originalYaml || yamlEditor.getValue();
            var after = window.pendingFixedContent || '';
            var msg = '=== 修复前 YAML (共 ' + before.length + ' 字符) ===\n\n' + before + '\n\n=== 修复后 YAML (共 ' + after.length + ' 字符) ===\n\n' + after;
            alert(msg);
        }

        /**
         * Apply the fixed content
         */
        function applyFix() {
            if (window.pendingFixedContent) {
                yamlEditor.setValue(window.pendingFixedContent);
                analyze();
                closeDiffModal();
                setMessage('已应用修复');
            }
        }

        /**
         * 使用词语级别对比 - 解决微小格式差异问题
         * 例如：'^1[3-9]\d{9}$' vs ^1[3-9]\d{9}$ 会被识别为微小差异
         */
        function computeDiff(before, after) {
            if (typeof Diff !== 'undefined') {
                return Diff.diffWords(before, after);
            }
            // 降级
            return [{ value: before, added: false, removed: false }];
        }

        /**
         * 渲染对比视图 - 词语级别高亮，左右独立显示完整内容
         * 每边都显示完整的行，用颜色标记变化的词语
         */
        function renderDiffContent(beforeContent, afterContent, diff, side) {
            if (!diff || diff.length === 0) {
                return escapeHtml(side === 'before' ? beforeContent : afterContent);
            }

            var content = side === 'before' ? beforeContent : afterContent;
            var html = '';
            var lines = content.split('\n');

            // 为每个字符标记状态 (unchanged/add/remove)
            var charStates = new Array(content.length).fill('unchanged');

            var pos = 0;
            diff.forEach(function(part) {
                var partLen = part.value.length;
                if (part.added) {
                    for (var i = 0; i < partLen; i++) {
                        if (pos + i < charStates.length) {
                            charStates[pos + i] = 'add';
                        }
                    }
                } else if (part.removed) {
                    for (var i = 0; i < partLen; i++) {
                        if (pos + i < charStates.length) {
                            charStates[pos + i] = 'remove';
                        }
                    }
                }
                pos += partLen;
            });

            // 按行渲染
            var currentPos = 0;
            for (var i = 0; i < lines.length; i++) {
                var line = lines[i];
                var lineStart = currentPos;
                var lineEnd = currentPos + line.length;

                html += '<div class="diff-line">';
                html += '<div class="diff-line-num">' + (i + 1) + '</div>';
                html += '<div class="diff-line-content">';

                // 逐字符渲染这一行
                var currentClass = '';
                var inSpan = false;

                for (var j = 0; j < line.length; j++) {
                    var state = charStates[lineStart + j];
                    var char = line[j];

                    if (state !== currentClass) {
                        if (inSpan) {
                            html += '</span>';
                            inSpan = false;
                        }
                        if (state === 'add') {
                            html += '<span class="diff-word-add">';
                            inSpan = true;
                        } else if (state === 'remove') {
                            html += '<span class="diff-word-remove">';
                            inSpan = true;
                        }
                        currentClass = state;
                    }

                    html += escapeHtml(char);
                }

                if (inSpan) {
                    html += '</span>';
                }

                html += '</div></div>';
                currentPos = lineEnd + 1;
            }

            return html;
        }

        /**
         * 渲染单行 diff
         */
        function renderGitDiffLine(content, lineNum, type) {
            if (content === undefined || content === null) {
                content = '';
            }

            var lineClass = '';
            var prefix = ' ';

            if (type === 'add') {
                lineClass = 'add';
                prefix = '+';
            } else if (type === 'remove') {
                lineClass = 'remove';
                prefix = '-';
            } else {
                lineClass = 'unchanged';
            }

            return '<div class="diff-line ' + lineClass + '">' +
                '<div class="diff-line-num">' + (lineNum || '') + '</div>' +
                '<div class="diff-line-content"><span class="diff-prefix">' + prefix + '</span>' + escapeHtml(content) + '</div>' +
                '</div>';
        }

        /**
         * Escape HTML
         */
        function escapeHtml(text) {
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function setMessage(msg) {
            document.getElementById('status-message').textContent = msg;
        }

        // Initialize
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
